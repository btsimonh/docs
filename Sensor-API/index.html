<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation (Wiki) for Tasmota"><link href=https://tasmota.github.io/docs/Sensor-API/ rel=canonical><link rel="shortcut icon" href=../_media/favicon.ico><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.8"><title>Sensor API - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.cb6bc1d0.min.css><link rel=stylesheet href=../assets/stylesheets/palette.39b8e14a.min.css><meta name=theme-color content=#2094f3><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Barlow",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-140681905-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=blue data-md-color-accent=indigo> <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#important-things-to-consider class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://tasmota.github.io/docs/ title=Tasmota class="md-header-nav__button md-logo" aria-label=Tasmota> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <div class=md-header-nav__topic> <span class=md-ellipsis> Tasmota </span> </div> <div class=md-header-nav__topic> <span class=md-ellipsis> Sensor API </span> </div> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/arendst/tasmota/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../About/ class=md-tabs__link> About </a> </li> <li class=md-tabs__item> <a href=../Getting-Started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../Upgrading/ class=md-tabs__link> Upgrading </a> </li> <li class=md-tabs__item> <a href=../MQTT/ class=md-tabs__link> MQTT </a> </li> <li class=md-tabs__item> <a href=../Commands/ class=md-tabs__link> Commands </a> </li> <li class=md-tabs__item> <a href=../Templates/ class=md-tabs__link> Templates </a> </li> <li class=md-tabs__item> <a href=../Components/ class=md-tabs__link> Components </a> </li> <li class=md-tabs__item> <a href=../Modules/ class=md-tabs__link> Modules </a> </li> <li class=md-tabs__item> <a href=../Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../WebUI/ class=md-tabs__link> WebUI </a> </li> <li class=md-tabs__item> <a href=../Features/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> <li class=md-tabs__item> <a href=../Builds/ class=md-tabs__link> Builds </a> </li> <li class=md-tabs__item> <a href=../Compile-your-build/ class=md-tabs__link> Compiling </a> </li> <li class=md-tabs__item> <a href=../Contributing/ class=md-tabs__link> Contributing </a> </li> <li class=md-tabs__item> <a href="http://ota.tasmota.com/tasmota/release/ " target='_blank""' class=md-tabs__link> Download </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://tasmota.github.io/docs/ title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../About/ class=md-nav__link> About </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../Upgrading/ class=md-nav__link> Upgrading </a> </li> <li class=md-nav__item> <a href=../MQTT/ class=md-nav__link> MQTT </a> </li> <li class=md-nav__item> <a href=../Commands/ class=md-nav__link> Commands </a> </li> <li class=md-nav__item> <a href=../Templates/ class=md-nav__link> Templates </a> </li> <li class=md-nav__item> <a href=../Components/ class=md-nav__link> Components </a> </li> <li class=md-nav__item> <a href=../Modules/ class=md-nav__link> Modules </a> </li> <li class=md-nav__item> <a href=../Peripherals/ class=md-nav__link> Peripherals </a> </li> <li class=md-nav__item> <a href=../WebUI/ class=md-nav__link> WebUI </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-12 type=checkbox id=nav-12> <label class=md-nav__link for=nav-12> Features <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Features data-md-level=1> <label class=md-nav__title for=nav-12> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Features/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../bluetooth/Bluetooth-Esp32/ class=md-nav__link> Bluetooth ESP32 </a> </li> <li class=md-nav__item> <a href=../bluetooth/Bluetooth-Esp8266/ class=md-nav__link> Bluetooth ESP8266 </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ class=md-nav__link> Buttons and Switches </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ class=md-nav__link> DeepSleep </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ class=md-nav__link> Device Groups </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ class=md-nav__link> Dynamic Sleep </a> </li> <li class=md-nav__item> <a href=../I2CDevices/ class=md-nav__link> I2C Devices </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ class=md-nav__link> IR Communication </a> </li> <li class=md-nav__item> <a href=../Lights/ class=md-nav__link> Lights </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> OpenTherm </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ class=md-nav__link> PIR Motion Sensors </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ class=md-nav__link> Power Monitoring Calibration </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ class=md-nav__link> PWM Dimmer </a> </li> <li class=md-nav__item> <a href=../RF-Protocol/ class=md-nav__link> RF 433MHz Protocol </a> </li> <li class=md-nav__item> <a href=../Rules/ class=md-nav__link> Rules </a> </li> <li class=md-nav__item> <a href=../Scripting-Language/ class=md-nav__link> Scripting </a> </li> <li class=md-nav__item> <a href=../Serial-to-TCP-Bridge/ class=md-nav__link> Serial to TCP Bridge </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ class=md-nav__link> Shutters and Blinds </a> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ class=md-nav__link> Smart Meter Interface </a> </li> <li class=md-nav__item> <a href=../Subscribe-%26-Unsubscribe/ class=md-nav__link> Subscribe & Unsubscribe </a> </li> <li class=md-nav__item> <a href=../TasmotaClient/ class=md-nav__link> TasmotaClient </a> </li> <li class=md-nav__item> <a href=../Thermostat/ class=md-nav__link> Thermostat </a> </li> <li class=md-nav__item> <a href=../Timers/ class=md-nav__link> Timers </a> </li> <li class=md-nav__item> <a href=../TLS/ class=md-nav__link> TLS Secured MQTT </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ class=md-nav__link> TuyaMCU </a> </li> <li class=md-nav__item> <a href=../Zigbee/ class=md-nav__link> Zigbee </a> </li> <li class=md-nav__item> <a href=../Tutorials/ class=md-nav__link> Projects and Tutorials </a> </li> <li class=md-nav__item> <a href=../For-Developers/ class=md-nav__link> For Developers </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-13 type=checkbox id=nav-13> <label class=md-nav__link for=nav-13> Smart Home Integrations <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Smart Home Integrations" data-md-level=1> <label class=md-nav__title for=nav-13> <span class="md-nav__icon md-icon"></span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../Alexa/ class=md-nav__link> Alexa </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ class=md-nav__link> AWS IoT </a> </li> <li class=md-nav__item> <a href=../Domoticz/ class=md-nav__link> Domoticz </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ class=md-nav__link> Home Assistant </a> </li> <li class=md-nav__item> <a href=../Homebridge/ class=md-nav__link> Homebridge </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ class=md-nav__link> HomeSeer </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ class=md-nav__link> IP Symcon </a> </li> <li class=md-nav__item> <a href=../KNX/ class=md-nav__link> KNX </a> </li> <li class=md-nav__item> <a href=../NodeRed/ class=md-nav__link> NodeRed </a> </li> <li class=md-nav__item> <a href=../nymea/ class=md-nav__link> nymea </a> </li> <li class=md-nav__item> <a href=../Octoprint/ class=md-nav__link> OctoPrint </a> </li> <li class=md-nav__item> <a href=../openHAB/ class=md-nav__link> openHAB </a> </li> <li class=md-nav__item> <a href=../otto/ class=md-nav__link> Otto </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 class=md-nav__link> IOBroker </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter class=md-nav__link> Mozilla WebThings Adapter </a> </li> <li class=md-nav__item> <a href=https://github.com/hongtat/tasmota-connect class=md-nav__link> SmartThings </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-14 type=checkbox id=nav-14> <label class=md-nav__link for=nav-14> Peripherals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Peripherals data-md-level=1> <label class=md-nav__title for=nav-14> <span class="md-nav__icon md-icon"></span> Peripherals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Supported-Peripherals/ class=md-nav__link> Supported Peripherals </a> </li> <li class=md-nav__item> <a href=../ADC/ class=md-nav__link> Analog pin </a> </li> <li class=md-nav__item> <a href=../Buzzer/ class=md-nav__link> Buzzer </a> </li> <li class=md-nav__item> <a href=../Displays/ class=md-nav__link> Displays </a> </li> <li class=md-nav__item> <a href=../ESP32/ class=md-nav__link> ESP32 Support (Beta development) </a> </li> <li class=md-nav__item> <a href=../A4988-Stepper-Motor-Controller/ class=md-nav__link> A4988 stepper motor controller </a> </li> <li class=md-nav__item> <a href=../AHT1x/ class=md-nav__link> AHT1x temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../AM2301/ class=md-nav__link> AM2301 temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../APDS-9960/ class=md-nav__link> APDS-9960 light and gesture sensor </a> </li> <li class=md-nav__item> <a href=../AS3935/ class=md-nav__link> AS3935 Franklin Lightning sensor </a> </li> <li class=md-nav__item> <a href=../AZ-7798/ class=md-nav__link> AZ7798 CO<sub>2</sub> meter </a> </li> <li class=md-nav__item> <a href=../BH1750/ class=md-nav__link> BH1750 ambient light sensor </a> </li> <li class=md-nav__item> <a href=../BME280/ class=md-nav__link> BME280 temperature, humidity and pressure sensor </a> </li> <li class=md-nav__item> <a href=../BME680/ class=md-nav__link> BME680 temperature, humidity, pressure and gas sensor </a> </li> <li class=md-nav__item> <a href=../CC2530/ class=md-nav__link> CC253x Zigbee module </a> </li> <li class=md-nav__item> <a href=../Moisture-Sensor-and-Chirp%21-Sensor/ class=md-nav__link> Chirp! moisture sensor </a> </li> <li class=md-nav__item> <a href=../DHT11/ class=md-nav__link> DHT11 temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../DS18x20/ class=md-nav__link> DS18x20 temperature sensor </a> </li> <li class=md-nav__item> <a href=../DS3231/ class=md-nav__link> DS3231 Real Time Clock </a> </li> <li class=md-nav__item> <a href=../EZO/ class=md-nav__link> EZO sensors </a> </li> <li class=md-nav__item> <a href=../HM-10/ class=md-nav__link> HM-10 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../HM-17/ class=md-nav__link> HM-17 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../HC-SR04/ class=md-nav__link> HC-SR04 ultrasonic ranging sensor </a> </li> <li class=md-nav__item> <a href=../Honeywell-HIH/ class=md-nav__link> Honeywell HIH temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../IAQ/ class=md-nav__link> iAQ-Core indoor air quality sensor </a> </li> <li class=md-nav__item> <a href=../IR-Remote/ class=md-nav__link> IR Remote </a> </li> <li class=md-nav__item> <a href=../LM75AD/ class=md-nav__link> LM75AD temperature sensor </a> </li> <li class=md-nav__item> <a href=../MCP230xx/ class=md-nav__link> MCP23008 / MCP23017 GPIO Expander </a> </li> <li class=md-nav__item> <a href=../MGC3130/ class=md-nav__link> MGC3130 3D tracking and gesture controller </a> </li> <li class=md-nav__item> <a href=../MH-Z19B/ class=md-nav__link> MH-Z19B CO<sub>2</sub> Sensor </a> </li> <li class=md-nav__item> <a href=../MLX90614/ class=md-nav__link> MLX90614 infrared thermometer </a> </li> <li class=md-nav__item> <a href=../MLX90640/ class=md-nav__link> MLX90640 Far infrared thermal sensor array </a> </li> <li class=md-nav__item> <a href=../MPR121/ class=md-nav__link> MPR121 capacitive touch sensor </a> </li> <li class=md-nav__item> <a href=../MPU-6050/ class=md-nav__link> MPU-6050 gyroscope and accelerometer </a> </li> <li class=md-nav__item> <a href=../NRF24L01/ class=md-nav__link> NRF24L01 module </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> OpenTherm </a> </li> <li class=md-nav__item> <a href=../P1-Smart-Meter/ class=md-nav__link> P1 Smart Meter </a> </li> <li class=md-nav__item> <a href=../PAJ7620/ class=md-nav__link> PAJ7620U2 gesture sensor </a> </li> <li class=md-nav__item> <a href=../PCA9685/ class=md-nav__link> PCA9685 12-bit PWM controller </a> </li> <li class=md-nav__item> <a href=../PN532/ class=md-nav__link> PN532 NFC reader </a> </li> <li class=md-nav__item> <a href=../PZEM-0XX/ class=md-nav__link> PZEM-0xx power monitor </a> </li> <li class=md-nav__item> <a href=../RCWL-0516/ class=md-nav__link> RCWL-0516 microwave radar motion sensor </a> </li> <li class=md-nav__item> <a href=../RDM6300/ class=md-nav__link> RDM6300 RFID reader </a> </li> <li class=md-nav__item> <a href=../RF-Transciever/ class=md-nav__link> RF Transciever </a> </li> <li class=md-nav__item> <a href=../SDS011/ class=md-nav__link> SDS011 air quality sensor </a> </li> <li class=md-nav__item> <a href=../SHT30/ class=md-nav__link> SHT30 temperature sensor </a> </li> <li class=md-nav__item> <a href=../TX2x/ class=md-nav__link> TX20/TX23 anemometer </a> </li> <li class=md-nav__item> <a href=../TSL2561/ class=md-nav__link> TSL2561 light sensor </a> </li> <li class=md-nav__item> <a href=../VEML6070/ class=md-nav__link> VEML6070 UV light sensor </a> </li> <li class=md-nav__item> <a href=../VEML6075/ class=md-nav__link> VEML6075 UVA/UVB/UVINDEX Sensor </a> </li> <li class=md-nav__item> <a href=../VEML7700/ class=md-nav__link> VEML7700 Ambient light sensor </a> </li> <li class=md-nav__item> <a href=../VL53L0x/ class=md-nav__link> VL53L0X laser ranging module </a> </li> <li class=md-nav__item> <a href=../WS2812B-RGB-Shield/ class=md-nav__link> WS2812B RGB Shield </a> </li> <li class=md-nav__item> <a href=../WS2812B-and-WS2813/ class=md-nav__link> WS2812B and WS2813 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-15 type=checkbox id=nav-15> <label class=md-nav__link for=nav-15> Supported Devices <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Supported Devices" data-md-level=1> <label class=md-nav__title for=nav-15> <span class="md-nav__icon md-icon"></span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-nav__link> Configure Unknown Device </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' class=md-nav__link> All Supported Devices </a> </li> <li class=md-nav__item> <a href=../Pinouts/ class=md-nav__link> Wi-Fi Module Pinouts </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ class=md-nav__link> Supported Modules </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-16 type=checkbox id=nav-16> <label class=md-nav__link for=nav-16> Help <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Help data-md-level=1> <label class=md-nav__title for=nav-16> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ class=md-nav__link> Device Recovery </a> </li> <li class=md-nav__item> <a href="https://discord.gg/Ks2Kzd4 " target='_blank""' class=md-nav__link> Discord Support </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Builds/ class=md-nav__link> Builds </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ class=md-nav__link> Compiling </a> </li> <li class=md-nav__item> <a href=../Contributing/ class=md-nav__link> Contributing </a> </li> <li class=md-nav__item> <a href="http://ota.tasmota.com/tasmota/release/ " target='_blank""' class=md-nav__link> Download </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#important-things-to-consider class=md-nav__link> Important things to consider </a> </li> <li class=md-nav__item> <a href=#managing-a-forked-branch class=md-nav__link> Managing a Forked Branch </a> </li> <li class=md-nav__item> <a href=#directoryfile-structure class=md-nav__link> Directory/file structure </a> </li> <li class=md-nav__item> <a href=#api-structure class=md-nav__link> API structure </a> <nav class=md-nav aria-label="API structure"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pre-processor-directives class=md-nav__link> Pre-processor directives </a> </li> <li class=md-nav__item> <a href=#callback-function class=md-nav__link> Callback function </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#callback-ids class=md-nav__link> Callback IDs </a> </li> <li class=md-nav__item> <a href=#useful-functions class=md-nav__link> Useful functions </a> <nav class=md-nav aria-label="Useful functions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mqtt class=md-nav__link> MQTT </a> </li> <li class=md-nav__item> <a href=#logging class=md-nav__link> Logging </a> </li> <li class=md-nav__item> <a href=#i2c-interface class=md-nav__link> I2C Interface </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#useful-pre-processor-directives class=md-nav__link> Useful pre-processor directives </a> </li> <li class=md-nav__item> <a href=#keeping-esp8266-code-compact class=md-nav__link> Keeping ESP8266 code compact </a> <nav class=md-nav aria-label="Keeping ESP8266 code compact"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#about-esp8266 class=md-nav__link> About ESP8266 </a> </li> <li class=md-nav__item> <a href=#first-example class=md-nav__link> First example </a> </li> <li class=md-nav__item> <a href=#uint8_t-or-uint32_t class=md-nav__link> uint8_t or uint32_t ? </a> </li> <li class=md-nav__item> <a href=#loops class=md-nav__link> Loops </a> </li> <li class=md-nav__item> <a href=#floats-not-doubles class=md-nav__link> Floats, not doubles! </a> </li> <li class=md-nav__item> <a href=#string-concatenation class=md-nav__link> String concatenation </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/Sensor-API.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Sensor API</h1> <p>Tasmota sensor API documentation for sensor driver development.</p> <h2 id=important-things-to-consider>Important things to consider<a class=headerlink href=#important-things-to-consider title="Permanent link">~</a></h2> <ul> <li>There are several I<sup>2</sup>C sensor examples you can take from the development codebase when writing your own and you are encouraged to do this as it is a quick and easy way to see how things fit together.</li> <li>The Tasmota firmware is essentially intended for ESP8266/ESP8285 Wi-Fi SoC based devices and commits to the main development branch will be subject to review based on whether or not what you intend to develop or add to the existing code is relevant to the general ESP device users.</li> <li>That being said, there is a lot of development going into the firmware which extends the functionality of standard off the shelf Sonoff devices. The firmware in itself is also useful for boards such as the WeMos ESP82xx boards. More technically inclined individuals who use generic ESP82xx modules in their own circuits to provide more access to pins and the ability to add more sensors and hardware external to the device or the generic ESP82xx module circuits can also take advantage of Tasmota.</li> <li>The resources on the ESP82xx are finite. Most devices ship with 1MByte SPI flash which means for the generic device users, the code generally needs to be less than 502KBytes to ensure that OTA (Over The Air) flash functionality (which is the main reason why people use this firmware) remains available. RAM is also limited to an absolute maximum of 80KBytes. This memory is divided into heap (used by global variables and Strings) and stack (used by local variables) where stack space is just 4KBytes.</li> <li>Given the above resource constraints its important to keep your code as small as possible, as fast running as possible, and use as little RAM as possible.</li> <li>You need to think about these resource constraints all the time whilst doing any development you wish to add to the firmware functionality - Face the fact that microcontroller development isn't as close a relative to standard computer programming as you'd expect.</li> <li>You will be adding code to an existing framework which requires you to adhere to some simple but strict rules such as not having any infinite loops like you would have in your generic Arduino code and try to avoid using the delay() functions when writing your code as this will cause the entire firmware to be subjected to the delays you have added - Infinite loops will cause the firmware to lock up completely!</li> <li>If your sensor has configuration options please make these available by using the <code>SensorXX</code> framework which is already incorporated in the base code - This may not stop you from using a web-based configuration interface but since web-based configuration takes up a lot of code space in flash it is very important to make this optional by means of a compiler directive or a #define in the configuration file and as such something you need to keep in mind during your development and debugging - The more progressively optional additional features are in your driver the smaller the basic codebase can be for minimalist implementations.</li> <li>Whilst developing drivers for devices that use the I<sup>2</sup>C bus always consider other devices already supported in the codebase which may use the same address range. This could mean you need to find a unique way of differentiating your device detection from other devices on the same address range (e.g. querying a model-specific register) and/or disabling by #undef existing devices if yours is selected with a #define statement and in such cases always provide a warning to the user during compile time using the #warning pragma such as including <code>#warning **** Turned off conflicting drivers SHT and VEML6070 ****</code> in your code.</li> <li>DO NOT ADD WEB INTERFACE FOR SENSOR CONFIGURATION if your sensor requires additional user configuration. The reason for this is the additional program memory required but most importantly the amount of RAM required to even create minimal user interfaces. Running out of RAM during runtime will lead to abnormal behaviour of your driver and/or other drivers or the entire firmware! See sensors such as the MCP23008/MCP23017 driver on more information on how to implement <code>SensorXX</code> commands instead!</li> <li>While developing you might want to enable additional debugging provided by file <code>xdrv_99_debug.ino</code> using <code>#define USE_DEBUG_DRIVER</code> which provides some commands for managing configuration settings and CPU timing. In addition you can enable define <code>PROFILE_XSNS_SENSOR_EVERY_SECOND</code> to profile your drivers duration.</li> <li>Do not assume others will know immediately how to use your addition and know that you will need to write a Wiki for it in the end.</li> </ul> <h2 id=managing-a-forked-branch>Managing a Forked Branch<a class=headerlink href=#managing-a-forked-branch title="Permanent link">~</a></h2> <p>If you plan to submit a PR bigger than a simple change in one file, here is a short intro about how to do a clean PR.</p> <ul> <li>fork the Tasmota repository in Github</li> <li><code>git clone https://github.com/&lt;github_user&gt;/Tasmota.git</code> and work on your local copy</li> <li><code>git remote add upstream https://github.com/arendst/Tasmota.git</code></li> <li><code>git checkout development</code></li> <li><code>git checkout -b &lt;temp_branch&gt;</code> to create a working branch where you can push commits</li> <li><code>git push --set-upstream origin &lt;temp_branch&gt;</code></li> <li>work on your local version and push as many commits as you want</li> </ul> <p>When you think it is ready to merge and submit a PR:</p> <ul> <li><code>git checkout development</code> to go back to the main branch</li> <li><code>git pull upstream development</code> to update all the latest changes</li> <li><code>git push</code> to update your fork</li> <li><code>git checkout -b &lt;pr_branch&gt;</code> to create a new branch for the final PR</li> <li><code>git push --set-upstream origin &lt;pr_branch&gt;</code></li> <li>Merge the edits but be sure to remove the history of your local commits</li> <li><code>git merge --squash &lt;temp_branch&gt;</code></li> <li><code>git commit -m "Message"</code></li> </ul> <p>Now you have a clean single commit from which you can create the PR on the Tasmota Github.</p> <h2 id=directoryfile-structure>Directory/file structure<a class=headerlink href=#directoryfile-structure title="Permanent link">~</a></h2> <p>Sensor libraries are located in the <code>lib/</code> directory. Sensor drivers are located in the <code>tasmota/</code> directory. The filename of the sensor driver is <code>xsns_&lt;driver_ID&gt;_&lt;driver_name&gt;.ino</code>, e.g. <code>xsns_05_ds18b20.ino</code> where <code>&lt;driver_ID&gt;</code> is a <em>unique</em> number between 01 and 90 and <code>&lt;driver_name&gt;</code> is a human-readable name of the driver.</p> <p>Using generic libraries from external sources for sensors should be avoided as far as possible as they usually include code for other platforms and are not always written in an optimized way.</p> <h2 id=api-structure>API structure<a class=headerlink href=#api-structure title="Permanent link">~</a></h2> <h3 id=pre-processor-directives>Pre-processor directives<a class=headerlink href=#pre-processor-directives title="Permanent link">~</a></h3> <p>Conditional compiling of a sensor driver is achieved by adding a pre-processor directive of the scheme <code>USE_&lt;driver_name&gt;</code> in <code>my_user_config.h</code>. Accordingly the driver code has to be wrapped in <code>#ifdef USE_&lt;driver_name&gt; ... #endif // USE_&lt;driver_name&gt;</code>. Any Sensor driver must contain a pre-processor directive defining the driver ID by the scheme <code>#define XSNS_&lt;driver_ID&gt;</code>.</p> <h3 id=callback-function>Callback function<a class=headerlink href=#callback-function title="Permanent link">~</a></h3> <p>Any sensor driver needs a callback function following the scheme</p> <div class=codehilite><pre><span></span><code><span class=c1>// Conditional compilation of driver</span>
<span class=cp>#ifdef USE_&lt;driver_name&gt;</span>

<span class=c1>// Define driver ID</span>
<span class=cp>#define XSNS_&lt;driver_ID&gt;  &lt;driver_ID&gt;</span>

<span class=cm>/**</span>
<span class=cm> * The callback function Xsns&lt;driver_ID&gt;() interfaces Tasmota with the sensor driver.</span>
<span class=cm> *</span>
<span class=cm> * It provides the Tasmota callback IDs.</span>
<span class=cm> *</span>
<span class=cm> * @param   byte    callback_id  Tasmota function ID.</span>
<span class=cm> * @return  boolean              Return value.</span>
<span class=cm> * @pre     None.</span>
<span class=cm> * @post    None.</span>
<span class=cm> *</span>
<span class=cm> */</span>
<span class=n>boolean</span> <span class=n>Xsns</span><span class=o>&lt;</span><span class=n>driverID</span><span class=o>&gt;</span><span class=p>(</span><span class=n>byte</span> <span class=n>callback_id</span><span class=p>)</span> <span class=p>{</span>

  <span class=c1>// Set return value to `false`</span>
  <span class=n>boolean</span> <span class=n>result</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>

  <span class=c1>// Check if I2C interface mode</span>
<span class=c1>// if(i2c_flg) {</span>

  <span class=c1>// Check which callback ID is called by Tasmota</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>callback_id</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=nl>FUNC_INIT</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=nl>FUNC_EVERY_50_MSECOND</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=nl>FUNC_EVERY_SECOND</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=nl>FUNC_JSON_APPEND</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
<span class=cp>#ifdef USE_WEBSERVER</span>
    <span class=k>case</span> <span class=nl>FUNC_WEB_APPEND</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
<span class=cp>#endif </span><span class=c1>// USE_WEBSERVER</span>
    <span class=k>case</span> <span class=nl>FUNC_SAVE_BEFORE_RESTART</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=nl>FUNC_COMMAND</span><span class=p>:</span>
      <span class=k>break</span><span class=p>;</span>
  <span class=p>}</span>
<span class=c1>// } // if(i2c_flg)</span>

  <span class=c1>// Return boolean result</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
<span class=cp>#endif </span><span class=c1>// USE_&lt;driver_name&gt;</span>
</code></pre></div> <h2 id=callback-ids>Callback IDs<a class=headerlink href=#callback-ids title="Permanent link">~</a></h2> <p><code>FUNC_INIT</code></p> <p>This callback ID is called when sensor drivers should be initialized.</p> <p><code>FUNC_EVERY_50_MSECOND</code></p> <p>This callback ID is called every 50 milliseconds, e.g. for near real-time operation</p> <p><code>FUNC_EVERY_SECOND</code></p> <p>This callback ID is called every second.</p> <p>It can be useful for anything that you need to do on a per second basis and is commonly used as an entry point to detect a driver or initialize an externally driven device such as a sensor, relay board or other forms of input/output required by your driver.</p> <p>You would normally want to make sure you've detected and initialised before it is used by <code>JSON_APPEND</code>, etc. so that its ready to serve data.</p> <p>The generally accepted way to use this would be to detect your sensor and once this is done set a sensor value accordingly so that the function does not use unnecessary resources during future calls, for example:</p> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=nf>MySensorDetect</span><span class=p>()</span>
<span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>MySensorDetected</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span><span class=p>;</span> <span class=p>}</span>
  <span class=cm>/*</span>
<span class=cm>   * Perform the code which needs to be completed to</span>
<span class=cm>   * detect your sensor and then set MySensorDetected to</span>
<span class=cm>   * a non-zero value which will prevent this section</span>
<span class=cm>   * of your code to re-run every time the function is</span>
<span class=cm>   * called.</span>
<span class=cm>   * </span>
<span class=cm>   * Under normal circumstances you&#39;d not need to do</span>
<span class=cm>   * re-detect or initialise your sensor once it has been</span>
<span class=cm>   * done</span>
<span class=cm>   */</span>
<span class=p>}</span>
</code></pre></div> <p>Setting a flag that the driver was successful in detecting the attached chip/board via I<sup>2</sup>C or SPI will prevent it from continuously trying to initialize an already initialized device.</p> <p>When writing your function responsible for detecting an externally connected I<sup>2</sup>C device try to create a method by which you read or write to specific registers that would be applicable to that specific I<sup>2</sup>C device only as to confirm a positive detect for the device. If this is not done extensively it will lead to some drivers getting false detects for a different device type simply because it shares the same I<sup>2</sup>C address.</p> <p>Unless your driver is specifically going to use the entire array of addresses provisioned by the manufacturer please consider using a <code>#define USE_MYCHIPNAME_ADDR</code> in the <code>my_user_config.h</code> so that the user may specify the address on which to expect the device. This is of course only applicable to drivers that are not enabled by default in any of the pre-built binaries.</p> <p><strong>I<sup>2</sup>C address auto-detection example</strong></p> <div class=codehilite><pre><span></span><code><span class=cp>#define MPR121_I2C_ADDR_1ST  0x5A    </span><span class=cm>/** 1st I2C address of sensor model **/</span><span class=cp></span>
<span class=cp>#define MPR121_I2C_ADDR_NUM  4       </span><span class=cm>/** Number of sensors/I2C addresses **/</span><span class=cp></span>
<span class=cp>#define MPR121_I2C_ID_REG    0x5D    </span><span class=cm>/** Sensor model specific ID register **/</span><span class=cp></span>
<span class=cp>#define MPR121_I2C_ID_VAL    0x24    </span><span class=cm>/** Sensor model specific ID register value **/</span><span class=cp></span>

<span class=cm>/* Sensor data struct type declaration/default definition */</span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
    <span class=kt>bool</span> <span class=n>connected</span>    <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>     <span class=cm>/** Status if sensor is connected at I2C address */</span>
    <span class=kt>bool</span> <span class=n>running</span>      <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>     <span class=cm>/** Running state of sensor */</span>
        <span class=p>.</span>
        <span class=p>.</span>
        <span class=p>.</span>
<span class=p>}</span> <span class=n>mpr121</span><span class=p>;</span>

<span class=c1>// Declare array of sensor data structs</span>
<span class=n>mpr121</span> <span class=n>mpr121</span><span class=p>[</span><span class=n>MPR121_I2C_ADDR_NUM</span><span class=p>];</span>

<span class=c1>// Sensor specific init function</span>
<span class=kt>void</span> <span class=nf>mpr121_init</span><span class=p>()</span> <span class=p>{</span>

    <span class=c1>// Loop through I2C addresses</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>MPR121_I2C_ADDR_NUM</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>

        <span class=c1>// Check if sensor is connected on I2C address</span>
        <span class=n>mpr121</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>connected</span> <span class=o>=</span> <span class=p>(</span><span class=n>MPR121_I2C_ID_VAL</span> <span class=o>==</span> <span class=n>I2cRead8</span><span class=p>(</span><span class=n>MPR121_I2C_ADDR_1ST</span> <span class=o>+</span> <span class=n>i</span><span class=p>,</span> <span class=n>MPR121_I2C_ID_REG</span><span class=p>);</span>
        <span class=k>if</span><span class=p>(</span><span class=n>mpr121</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>connected</span><span class=p>)</span> <span class=p>{</span>

            <span class=c1>// Log sensor found</span>
            <span class=n>snprintf_P</span><span class=p>(</span><span class=n>log_data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>log_data</span><span class=p>),</span> <span class=n>PSTR</span><span class=p>(</span><span class=n>D_LOG_I2C</span> <span class=s>&quot;MPR121-%d &quot;</span> <span class=n>D_FOUND_AT</span> <span class=s>&quot; 0x%X&quot;</span><span class=p>),</span> <span class=n>i</span><span class=p>,</span> <span class=n>MPR121_I2C_ADDR_1ST</span> <span class=o>+</span> <span class=n>i</span><span class=p>);</span>
            <span class=n>AddLog</span><span class=p>(</span><span class=n>LOG_LEVEL_INFO</span><span class=p>);</span>

            <span class=c1>// Initialize sensor</span>
            <span class=p>.</span>
            <span class=p>.</span>
            <span class=p>.</span>

            <span class=c1>// Set running to true</span>
            <span class=n>mpr121</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>running</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>mpr121</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>connected</span> <span class=o>||</span> <span class=n>mpr121</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>connected</span> <span class=o>||</span> <span class=n>mpr121</span><span class=p>[</span><span class=mi>2</span><span class=p>].</span><span class=n>connected</span> <span class=o>||</span> <span class=n>mpr121</span><span class=p>[</span><span class=mi>3</span><span class=p>].</span><span class=n>connected</span><span class=p>)){</span>
        <span class=n>snprintf_P</span><span class=p>(</span><span class=n>log_data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>log_data</span><span class=p>),</span> <span class=n>PSTR</span><span class=p>(</span><span class=n>D_LOG_I2C</span> <span class=s>&quot;MPR121: No sensors found&quot;</span><span class=p>));</span>
        <span class=n>AddLog</span><span class=p>(</span><span class=n>LOG_LEVEL_INFO</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><strong>Four advanced methods to use <code>FUNC_EVERY_SECOND</code> (Food for thought) :</strong> * If a sensor needs an action which takes a long time, like more than 100mS, the action will be started here for a future follow-up. Using the uptime variable for testing like (uptime &amp;1) will happen every 2 seconds. An example is the DS18B20 driver where readings (conversions they call it) can take up to 800mS from the initial request. * If a sensor needed the previous action it is now time to gather the information and store it in a safe place to be used by <code>FUNC_JSON_APPEND</code> and/or <code>FUNC_WEB_APPEND</code>. Using the else function of the previous test (uptime &amp;1) will happen every 2 seconds too but just 1 second later than the previous action. * If a sensor does not respond for 10 times the sensor detection flag could be reset which will stop further processing until the sensor is re-detected. This is currently not being used actively as some users complain about disappearing sensors for whatever reason - Could be hardware related but easier to make Tasmota a little more flexible. * Making re-detection of a sensor possible by executing this once every 100 seconds (94 == (uptime %100)) a re-attached sensor can be detected without a restart of Tasmota. The 94 given in this example should be different for every sensor driver to make sure not all sensors start detection at the same time. Using the drivers index number should be a good starting point.</p> <p><code>FUNC_PREP_BEFORE_TELEPERIOD</code></p> <p>NOTE: This callback ID is deprecated as sensors should prepare for more regular updates due to "realtime" rule execution. Use <code>FUNC_EVERY_SECOND</code> instead. See examples used in xsns_05_ds18x20.ino and xsns_09_bmp.ino where updated sensor data is stored in preparation to calls to FUNC_JSON_APPEND and FUNC_WEB_APPEND.</p> <p><code>FUNC_JSON_APPEND</code></p> <p>This callback ID is called when <a href=../Commands/#teleperiod><code>TelePeriod</code></a> is due to append telemetry data to the MQTT JSON string or at approximately every 2 seconds when a rule is checked, e.g.</p> <div class=codehilite><pre><span></span><code><span class=n>snprintf_P</span><span class=p>(</span><span class=n>mqtt_data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>mqtt_data</span><span class=p>),</span> <span class=n>PSTR</span><span class=p>(</span><span class=s>&quot;{</span><span class=se>\&quot;</span><span class=s>MPR121%c</span><span class=se>\&quot;</span><span class=s>:{</span><span class=se>\&quot;</span><span class=s>Button%i</span><span class=se>\&quot;</span><span class=s>:%i}}&quot;</span><span class=p>),</span> <span class=n>pS</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>j</span><span class=p>,</span> <span class=n>BITC</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>));</span>
</code></pre></div> <p><code>FUNC_WEB_APPEND</code></p> <p>This callback ID is called every <webrefresh> millisecond when HTML code should be added to the Tasmota web-interface main page, e.g.,</p> <div class=codehilite><pre><span></span><code><span class=n>snprintf_P</span><span class=p>(</span><span class=n>mqtt_data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>mqtt_data</span><span class=p>),</span> <span class=n>PSTR</span><span class=p>(</span><span class=s>&quot;%s{s}MPR121%c Button%d{m}%d{e}&quot;</span><span class=p>),</span> <span class=n>mqtt_data</span><span class=p>,</span> <span class=n>pS</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>j</span><span class=p>,</span> <span class=n>BITC</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>));</span>
</code></pre></div> <p>It should be wrapped in <code>#ifdef USE_WEBSERVER ... #endif // USE_WEBSERVER</code></p> <p><code>FUNC_SAVE_BEFORE_RESTART</code></p> <p>This callback ID is called to allow a sensor to prepare for saving configuration changes. To be used to save volatile data just before a restart. Variables can be appended to <code>struct SYSCFG {} Settings</code> in file <code>tasmota/settings.h</code>.</p> <p><code>FUNC_COMMAND</code></p> <p>This callback ID is called when a sensor specific command <code>Sensor&lt;xx&gt;</code> or <code>Driver&lt;xx&gt;</code> is executed where xx is the sensor index.</p> <div class=codehilite><pre><span></span><code>        <span class=k>case</span> <span class=nl>FUNC_COMMAND</span><span class=p>:</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>XSNS_</span><span class=o>&lt;</span><span class=n>driver_ID</span><span class=o>&gt;</span> <span class=o>==</span> <span class=n>XdrvMailbox</span><span class=p>.</span><span class=n>index</span><span class=p>)</span> <span class=p>{</span>
               <span class=n>result</span> <span class=o>=</span> <span class=o>&lt;</span><span class=n>driver_name</span><span class=o>&gt;</span><span class=n>Command</span><span class=p>()</span> <span class=p>{</span> <span class=p>...</span> <span class=p>};</span>  <span class=c1>// Return true on success</span>
            <span class=p>}</span>
            <span class=k>break</span><span class=p>;</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=c1>// Data struct of FUNC_COMMAND ID</span>
<span class=k>struct</span> <span class=nc>XDRVMAILBOX</span> <span class=p>{</span>
  <span class=kt>uint16_t</span>      <span class=n>valid</span><span class=p>;</span>      <span class=c1>// ???</span>
  <span class=kt>uint16_t</span>      <span class=n>index</span><span class=p>;</span>      <span class=c1>// Sensor index</span>
  <span class=kt>uint16_t</span>      <span class=n>data_len</span><span class=p>;</span>   <span class=c1>// Length of command string</span>
  <span class=kt>uint16_t</span>      <span class=n>payload16</span><span class=p>;</span>  <span class=c1>// 16 bit unsigned int of payload if it could be converted, otherwise 0</span>
  <span class=kt>int16_t</span>       <span class=n>payload</span><span class=p>;</span>    <span class=c1>// 16 bit signed int of payload if it could be converted, otherwise 0</span>
  <span class=kt>uint8_t</span>       <span class=n>grpflg</span><span class=p>;</span>     <span class=c1>// ???</span>
  <span class=kt>uint8_t</span>       <span class=n>notused</span><span class=p>;</span>    <span class=c1>// ???</span>
  <span class=kt>char</span>         <span class=o>*</span><span class=n>topic</span><span class=p>;</span>      <span class=c1>// Command topic</span>
  <span class=kt>char</span>         <span class=o>*</span><span class=n>data</span><span class=p>;</span>       <span class=c1>// Command string/value - length of which is defined by data_len</span>
<span class=p>}</span> <span class=n>XdrvMailbox</span><span class=p>;</span>
</code></pre></div> <p>If your driver needs to accept multiple parameters for <code>SensorXX</code> and/or <code>DriverXX</code> please consider using comma delimited formatting and use the already written <code>subStr()</code> function declared in <code>support.ino</code> to parse through the parameters you need.</p> <p>An example of those could be</p> <div class=codehilite><pre><span></span><code><span class=n>SensorXX</span> <span class=n>reset</span> <span class=c1>// The reset parameter may be intercepted using:</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>subStr</span><span class=p>(</span><span class=n>sub_string</span><span class=p>,</span> <span class=n>XdrvMailbox</span><span class=p>.</span><span class=n>data</span><span class=p>,</span> <span class=s>&quot;,&quot;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span><span class=s>&quot;RESET&quot;</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// Note 1 used for param number</span>
    <span class=n>MyDriverName_Reset</span><span class=p>();</span> 
    <span class=k>return</span> <span class=n>serviced</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Or in the case of multiple parameters</p> <div class=codehilite><pre><span></span><code><span class=n>SensorXX</span> <span class=n>mode</span><span class=p>,</span><span class=mi>1</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>strcmp</span><span class=p>(</span><span class=n>subStr</span><span class=p>(</span><span class=n>sub_string</span><span class=p>,</span> <span class=n>XdrvMailbox</span><span class=p>.</span><span class=n>data</span><span class=p>,</span> <span class=s>&quot;,&quot;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span><span class=s>&quot;MODE&quot;</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// Note 1 used for param number</span>
  <span class=kt>uint8_t</span> <span class=n>mode</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=n>subStr</span><span class=p>(</span><span class=n>sub_string</span><span class=p>,</span> <span class=n>XdrvMailbox</span><span class=p>.</span><span class=n>data</span><span class=p>,</span> <span class=s>&quot;,&quot;</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>  <span class=c1>// Note 2 used for param number</span>
<span class=p>}</span>
</code></pre></div> <h2 id=useful-functions>Useful functions<a class=headerlink href=#useful-functions title="Permanent link">~</a></h2> <h3 id=mqtt>MQTT<a class=headerlink href=#mqtt title="Permanent link">~</a></h3> <hr> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=n>MqttPublishPrefixTopic_P</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>prefix</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>subtopic</span><span class=p>,</span> <span class=n>boolean</span> <span class=n>retained</span><span class=p>)</span>
</code></pre></div> <p>This function publishes MQTT messages immediately, e.g.,</p> <div class=codehilite><pre><span></span><code><span class=n>snprintf_P</span><span class=p>(</span><span class=n>mqtt_data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>mqtt_data</span><span class=p>),</span> <span class=n>PSTR</span><span class=p>(</span><span class=s>&quot;{</span><span class=se>\&quot;</span><span class=s>MPR121%c</span><span class=se>\&quot;</span><span class=s>:{</span><span class=se>\&quot;</span><span class=s>Button%i</span><span class=se>\&quot;</span><span class=s>:%i}}&quot;</span><span class=p>),</span> <span class=n>pS</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>j</span><span class=p>,</span> <span class=n>BITC</span><span class=p>(</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>));</span>
<span class=n>MqttPublishPrefixTopic_P</span><span class=p>(</span><span class=n>RESULT_OR_STAT</span><span class=p>,</span> <span class=n>mqtt_data</span><span class=p>);</span>
</code></pre></div> <h3 id=logging>Logging<a class=headerlink href=#logging title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=n>AddLog</span><span class=p>(</span><span class=n>byte</span> <span class=n>loglevel</span><span class=p>)</span>
</code></pre></div> <p>This function adds log messages stored in <code>log_data</code> to the local logging system, e.g.</p> <div class=codehilite><pre><span></span><code><span class=n>snprintf_P</span><span class=p>(</span><span class=n>log_data</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>log_data</span><span class=p>),</span> <span class=n>PSTR</span><span class=p>(</span><span class=n>D_LOG_I2C</span> <span class=s>&quot;MPR121(%c) &quot;</span> <span class=n>D_FOUND_AT</span> <span class=s>&quot; 0x%X&quot;</span><span class=p>),</span> <span class=n>pS</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>pS</span><span class=o>-&gt;</span><span class=n>i2c_addr</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
<span class=n>AddLog</span><span class=p>(</span><span class=n>LOG_LEVEL_INFO</span><span class=p>);</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=n>AddLogSerial</span><span class=p>(</span><span class=n>byte</span> <span class=n>loglevel</span><span class=p>)</span>
</code></pre></div> <p>This function adds a log message to the local logging system dumping the serial buffer as hex information, e.g.</p> <div class=codehilite><pre><span></span><code><span class=n>AddLogSerial</span><span class=p>(</span><span class=n>LOG_LEVEL_INFO</span><span class=p>);</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=n>AddLogMissed</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>sensor</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>misses</span><span class=p>)</span>
</code></pre></div> <p>This function adds a log message to the local logging system about missed sensor reads.</p> <h3 id=i2c-interface>I<sup>2</sup>C Interface<a class=headerlink href=#i2c-interface title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidRead8</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidRead16</span><span class=p>(</span><span class=kt>uint16_t</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidReadS16</span><span class=p>(</span><span class=kt>int16_t</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidRead16LE</span><span class=p>(</span><span class=kt>uint16_t</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidReadS16_LE</span><span class=p>(</span><span class=kt>int16_t</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidRead24</span><span class=p>(</span><span class=kt>int32_t</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cValidRead</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>size</span><span class=p>)</span>
</code></pre></div> <p>These functions return <code>true</code> if 1, 2, 3 or <code>size</code> bytes can be read from the I<sup>2</sup>C address <code>addr</code> and register <code>reg</code> into <code>*data</code>. Functions with a <code>S</code> read signed data types while functions without a <code>S</code> read unsigned data types. Functions with LE read little-endian byte order while functions without LE read machine byte order.</p> <div class=codehilite><pre><span></span><code><span class=kt>uint8_t</span> <span class=n>I2cRead8</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>uint16_t</span> <span class=n>I2cRead16</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>int16_t</span> <span class=n>I2cReadS16</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>uint16_t</span> <span class=n>I2cRead16LE</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>int16_t</span> <span class=n>I2cReadS16_LE</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>int32_t</span> <span class=n>I2cRead24</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>)</span>
</code></pre></div> <p>These functions return 1, 2 or 3 bytes from the I<sup>2</sup>C address <code>addr</code> and register <code>reg</code>. Functions with a <code>S</code> read signed data types while functions without a <code>S</code> read unsigned data types. Functions with LE read little endian byte order while functions without LE read machine byte order.</p> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cWrite8</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>val</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cWrite16</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>val</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cWrite</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>val</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>size</span><span class=p>)</span>
</code></pre></div> <p>These functions return true after successfully writing 1, 2 or <code>size</code> bytes to the I<sup>2</sup>C address <code>addr</code> and register <code>reg</code>.</p> <div class=codehilite><pre><span></span><code><span class=kt>int8_t</span> <span class=n>I2cReadBuffer</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>reg_data</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>len</span><span class=p>)</span>
</code></pre></div> <div class=codehilite><pre><span></span><code><span class=kt>int8_t</span> <span class=n>I2cWriteBuffer</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>addr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>reg</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=o>*</span><span class=n>reg_data</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>len</span><span class=p>)</span>
</code></pre></div> <p>These functions copy <code>len</code> bytes from/to <code>*reg_data</code> starting at I<sup>2</sup>C address <code>addr</code> and register <code>reg</code>.</p> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=n>I2cScan</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>devs</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>devs_len</span><span class=p>)</span>
</code></pre></div> <p>This functions writes a list of I<sup>2</sup>C addresses in use into the string <code>*dev</code> with maximum length <code>devs_len</code>.</p> <div class=codehilite><pre><span></span><code><span class=kt>bool</span> <span class=n>I2cDevice</span><span class=p>(</span><span class=n>byte</span> <span class=n>addr</span><span class=p>)</span>
</code></pre></div> <p>This functions checks if the I<sup>2</sup>C address <code>addr</code> is in use.</p> <h2 id=useful-pre-processor-directives>Useful pre-processor directives<a class=headerlink href=#useful-pre-processor-directives title="Permanent link">~</a></h2> <p><code>PSTR("string")</code></p> <p>This pre-processor directive saves RAM by storing strings in flash instead of RAM.</p> <div class=codehilite><pre><span></span><code><span class=k>const</span> <span class=kt>char</span> <span class=n>MyTextStaticVariable</span><span class=p>[]</span> <span class=n>PROGMEM</span> <span class=o>=</span> <span class=s>&quot;string&quot;</span><span class=p>;</span>
</code></pre></div> <p>This pre-processor directive saves RAM by storing strings in flash instead of RAM.</p> <p>You may then reference them directly (if the type matches the parameter required) or force it to 4 byte alignment by using the variable as <code>FPSTR(MyTextStaticVariable)</code></p> <h2 id=keeping-esp8266-code-compact>Keeping ESP8266 code compact<a class=headerlink href=#keeping-esp8266-code-compact title="Permanent link">~</a></h2> <p>Below are various tips and tricks to keep ESP8266 code compact and save both Flash and Memory. Flash code is limited to 1024k but keep in mind that to allow OTA upgrade, you need Flash memory to contain two firmwares at the same time. To go beyond 512k, you typically use <code>tasmota-minimal</code> as an intermediate firmware. <code>tasmota-minimal</code> takes roughly 360k, so it's safe not to go <code>uint32_t</code> beyond 620k of Flash. Memory is even more limited: 80k. With Arduino Core and basic Tasmota, there are 25k-30k left of heap space. Heap memory is very precious, running out of memory will generally cause a crash.</p> <h3 id=about-esp8266>About ESP8266<a class=headerlink href=#about-esp8266 title="Permanent link">~</a></h3> <p>ESP8266 is based on <a href=https://0x04.net/~mwk/doc/xtensa.pdf>Xtensa instruction set</a>. Xtensa is a 32 bits RISC processor core, containing 16 x 32 bits registers. ESP8266 supports integer operations, including 32x32 multiplication. It does not contain an FPU for floating point operations, nor integer divisions.</p> <p>Contrary to classical RISC processors, all instructions are 24 bits wide instead of 32 bits. To increase code compactness, some instructions have a 16 bits version used whenever possible by gcc.</p> <p>If you want to see what assembly is generated by gcc, in file <code>platform.ini</code>, at the section used to compile (ex: <code>[core_2_6_1]</code>) in section <code>build_flags</code> add:</p> <p><code>-save-temps=obj -fverbose-asm</code></p> <p>Gcc will store <code>&lt;file&gt;.s</code> in the same folder as the <code>.o</code> file, typically in <code>.pioenvs/</code>.</p> <h3 id=first-example>First example<a class=headerlink href=#first-example title="Permanent link">~</a></h3> <p>Let's take a basic function:</p> <div class=codehilite><pre><span></span><code><span class=kt>uint32_t</span> <span class=nf>Example</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Below is the generated assembly. Function names are mangled using standard C++, i.e. their name derive from their arguments and return types:</p> <div class=codehilite><pre><span></span><code><span class=nl>_Z7Examplejj:</span>
    <span class=nf>add.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=no>a3</span>  <span class=c1>#, a, b</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>As you can see, this is the simplest function we can think of. Register A2 holds the first argument and is used for return value. A3 holds the second argument.</p> <h3 id=uint8_t-or-uint32_t>uint8_t or uint32_t ?<a class=headerlink href=#uint8_t-or-uint32_t title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=kt>uint32_t</span> <span class=nf>Example</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>uint8_t</span> <span class=n>c</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>c</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly:</p> <div class=codehilite><pre><span></span><code><span class=nl>_Z7Examplejj:</span>
    <span class=nf>add.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=no>a3</span>  <span class=c1># tmp52, a, b</span>
    <span class=nf>extui</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span>    <span class=c1>#, tmp52</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>Whenever gcc needs to convert from <code>uin32_t</code> to <code>uint8_t</code>, it uses an extra instruction <code>extui &lt;reg&gt;, &lt;reg&gt;, 0, 8</code>.</p> <p>Whenever you allocate <code>uint8_t</code> as a local variable, it will anyways allocate 32 bits on the stack.</p> <p>In conclusion you can easily use <code>uint32_t</code> in many places in the code. The main reason to force <code>uint8_t</code> are:</p> <ul> <li>in structures, to save memory. This is the only place where <code>uint8_t</code> will take 1 byte and the compiler will try to pack as much as 4 <code>uint8_t</code> in 32 bits</li> <li>when you want to ensure that the value can never exceed 255. Beware though that the compiler will just chunk the last 8 bits of a 32 bits value and will not report any overflow.</li> </ul> <h3 id=loops>Loops<a class=headerlink href=#loops title="Permanent link">~</a></h3> <p>Should you use <code>uint8_t</code> or <code>uint32_t</code> for loops?</p> <p>Let's try:</p> <div class=codehilite><pre><span></span><code><span class=kt>uint32_t</span> <span class=nf>Example</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>a</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>a</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>a</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly:</p> <div class=codehilite><pre><span></span><code><span class=nl>_Z7Examplejj:</span>
    <span class=nf>movi.n</span>  <span class=no>a3</span><span class=p>,</span> <span class=mi>0</span>   <span class=c1># ivtmp$7334,                     &lt;- loop 1</span>
<span class=nl>.L2031:</span>
    <span class=nf>add.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=no>a3</span>  <span class=c1># a, a, ivtmp$7334</span>
    <span class=nf>addi.n</span>  <span class=no>a3</span><span class=p>,</span> <span class=no>a3</span><span class=p>,</span> <span class=mi>1</span>   <span class=c1># ivtmp$7334, ivtmp$7334,</span>
    <span class=nf>bnei</span>    <span class=no>a3</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=no>.L2031</span>  <span class=c1># ivtmp$7334,,</span>
    <span class=nf>movi.n</span>  <span class=no>a3</span><span class=p>,</span> <span class=mi>0</span>   <span class=c1># j,                              &lt;- loop 2</span>
<span class=nl>.L2033:</span>
    <span class=nf>add.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=no>a3</span>  <span class=c1># a, a, j</span>
    <span class=nf>addi.n</span>  <span class=no>a3</span><span class=p>,</span> <span class=no>a3</span><span class=p>,</span> <span class=mi>1</span>   <span class=c1># j, j,</span>
    <span class=nf>bnei</span>    <span class=no>a3</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=no>.L2033</span>  <span class=c1># j,,</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>As you can see here, both loops generate the same assembly for fixed size loops.</p> <p>Let's now see for variable size loops.</p> <div class=codehilite><pre><span></span><code><span class=kt>uint32_t</span> <span class=nf>Example</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>a</span> <span class=o>+=</span> <span class=n>i</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>uint32_t</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>a</span> <span class=o>+=</span> <span class=n>j</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>a</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly:</p> <div class=codehilite><pre><span></span><code><span class=nl>_Z7Examplejj:</span>
    <span class=nf>movi.n</span>  <span class=no>a4</span><span class=p>,</span> <span class=mi>0</span>   <span class=c1># i,                     &lt;- loop 1</span>
    <span class=nf>j</span>   <span class=no>.L2030</span>  <span class=c1>#</span>
<span class=nl>.L2031:</span>
    <span class=nf>add.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=no>a4</span>  <span class=c1># a, a, i</span>
    <span class=nf>addi.n</span>  <span class=no>a4</span><span class=p>,</span> <span class=no>a4</span><span class=p>,</span> <span class=mi>1</span>   <span class=c1># tmp48, i,</span>
    <span class=nf>extui</span>   <span class=no>a4</span><span class=p>,</span> <span class=no>a4</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span>    <span class=c1># i, tmp48       &lt;- extra 32 to 8 bits conversion</span>
<span class=nl>.L2030:</span>
    <span class=nf>bltu</span>    <span class=no>a4</span><span class=p>,</span> <span class=no>a3</span><span class=p>,</span> <span class=no>.L2031</span>  <span class=c1># i, b,</span>
    <span class=nf>movi.n</span>  <span class=no>a4</span><span class=p>,</span> <span class=mi>0</span>   <span class=c1># j,                     &lt;- loop 2</span>
    <span class=nf>j</span>   <span class=no>.L2032</span>  <span class=c1>#</span>
<span class=nl>.L2033:</span>
    <span class=nf>add.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a2</span><span class=p>,</span> <span class=no>a4</span>  <span class=c1># a, a, j</span>
    <span class=nf>addi.n</span>  <span class=no>a4</span><span class=p>,</span> <span class=no>a4</span><span class=p>,</span> <span class=mi>1</span>   <span class=c1># j, j,</span>
<span class=nl>.L2032:</span>
    <span class=nf>bne</span> <span class=no>a4</span><span class=p>,</span> <span class=no>a3</span><span class=p>,</span> <span class=no>.L2033</span>  <span class=c1># j, b,</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>In the first loop, the register a4 needs to be converted from 32 bits to 8 bits in each iteration.</p> <p>Again, there is no definitive rule, but keep in mind that using <code>uint8_t</code> can sometimes increase code size compared to <code>uint32_t</code>.</p> <h3 id=floats-not-doubles>Floats, not doubles!<a class=headerlink href=#floats-not-doubles title="Permanent link">~</a></h3> <p>ESP8266 does not have a FPU (Floating Point Unit), all floating point operations are emulated in software and provided in <code>libm.a</code>. The linker removes any unused functions, so we need to limit the number of floating point function calls.</p> <p><strong>Rule 1</strong>: use ints where you can, avoid floating point operations.</p> <p><strong>Rule 2</strong>: if you really need floating point, always use <code>float</code>, never <strong>ever</strong> use <code>double</code>.</p> <p>Let's now see why.</p> <p><code>float</code>fits in 32 bits, with a mantissa of 20 bits, exponent of TODO. The mantissa is 20 bits wide, which provides enough precision for most of our needs.</p> <p><code>float</code> is 32 bits wide and fits in a single register, whereas <code>double</code> is 64 bits and requires 2 registers.</p> <div class=codehilite><pre><span></span><code><span class=kt>float</span> <span class=nf>Examplef</span><span class=p>(</span><span class=kt>float</span> <span class=n>a</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>sinf</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>b</span> <span class=o>+</span> <span class=mf>0.4f</span><span class=p>)</span> <span class=o>-</span> <span class=mf>3.5f</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly:</p> <div class=codehilite><pre><span></span><code>    <span class=na>.literal</span> <span class=no>.LC1012</span><span class=p>,</span> <span class=mi>0x3ecccccd</span>      <span class=err>&lt;</span><span class=p>-</span> <span class=mi>0</span><span class=no>.4f</span>
    <span class=na>.literal</span> <span class=no>.LC1013</span><span class=p>,</span> <span class=mi>0x40600000</span>      <span class=err>&lt;</span><span class=p>-</span> <span class=mi>3</span><span class=no>.5f</span>
<span class=nl>_Z8Examplefff:</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>-16</span> <span class=c1>#,,       &lt;- reserve 16 bytes on stack</span>
    <span class=nf>s32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,        &lt;- save a0 (return address) on stack</span>
    <span class=nf>s32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>8</span>  <span class=c1>#,        &lt;- save a12 on stack, to free for local var</span>
    <span class=nf>s32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>4</span>  <span class=c1>#,        &lt;- save a13 on stack, to free for local var</span>
    <span class=nf>mov.n</span>   <span class=no>a13</span><span class=p>,</span> <span class=no>a3</span> <span class=c1># b, b            &lt;- a3 holds &#39;b&#39;, save to a13</span>
    <span class=nf>call0</span>   <span class=no>sinf</span>    <span class=c1>#                 &lt;- calc sin of a2 (a)</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1012</span> <span class=c1>#,        &lt;- load 0.4f in a3</span>
    <span class=nf>mov.n</span>   <span class=no>a12</span><span class=p>,</span> <span class=no>a2</span> <span class=c1># D.171139,       &lt;- save result &#39;sin(a)&#39; to a12</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a13</span> <span class=c1>#, b              &lt;- move a13 (second arg: b) to a2</span>
    <span class=nf>call0</span>   <span class=no>__addsf3</span>    <span class=c1>#         &lt;- add floats a2 and a3, result to a2</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a2</span>  <span class=c1># D.171139,       &lt;- copy result to a3</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#, D.171139       &lt;- load a2 with a12: sin(a)</span>
    <span class=nf>call0</span>   <span class=no>__mulsf3</span>    <span class=c1>#         &lt;- multiply &#39;sin(a)*(b+0.4f)&#39;</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1013</span> <span class=c1>#,        &lt;- load a3 with 3.5f</span>
    <span class=nf>call0</span>   <span class=no>__subsf3</span>    <span class=c1>#         &lt;- substract </span>
    <span class=nf>l32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,        &lt;- restore a0 (return address)</span>
    <span class=nf>l32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>8</span>  <span class=c1>#,        &lt;- restore a12</span>
    <span class=nf>l32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>4</span>  <span class=c1>#,        &lt;- restore a13</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>16</span>  <span class=c1>#,,       &lt;- free stack</span>
    <span class=nf>ret.n</span>                             <span class=err>&lt;</span><span class=p>-</span> <span class=no>return</span>
</code></pre></div> <p>Now with <code>double</code>:</p> <div class=codehilite><pre><span></span><code><span class=kt>double</span> <span class=nf>Exampled</span><span class=p>(</span><span class=kt>double</span> <span class=n>a</span><span class=p>,</span> <span class=kt>double</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>sin</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>b</span> <span class=o>+</span> <span class=mf>0.4</span><span class=p>)</span> <span class=o>-</span> <span class=mf>3.5</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly:</p> <div class=codehilite><pre><span></span><code>    <span class=na>.literal</span> <span class=no>.LC1014</span><span class=p>,</span> <span class=mi>0x9999999a</span><span class=p>,</span> <span class=mi>0x3fd99999</span>     <span class=err>&lt;</span><span class=p>-</span> <span class=mi>0</span><span class=no>.4</span>
    <span class=na>.literal</span> <span class=no>.LC1015</span><span class=p>,</span> <span class=mi>0x00000000</span><span class=p>,</span> <span class=mi>0x400c0000</span>     <span class=err>&lt;</span><span class=p>-</span> <span class=mi>3</span><span class=no>.5</span>
<span class=nl>_Z8Exampleddd:</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>-32</span> <span class=c1>#,,</span>
    <span class=nf>s32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>28</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>24</span> <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>20</span> <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>16</span> <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a15</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a14</span><span class=p>,</span> <span class=no>a4</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a15</span><span class=p>,</span> <span class=no>a5</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>sin</span> <span class=c1>#</span>
    <span class=nf>l32r</span>    <span class=no>a4</span><span class=p>,</span> <span class=no>.LC1014</span> <span class=c1>#,</span>
    <span class=nf>l32r</span>    <span class=no>a5</span><span class=p>,</span> <span class=no>.LC1014</span><span class=err>+</span><span class=mi>4</span>   <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a12</span><span class=p>,</span> <span class=no>a2</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a13</span><span class=p>,</span> <span class=no>a3</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a14</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a15</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__adddf3</span>    <span class=c1>#</span>
    <span class=nf>mov.n</span>   <span class=no>a4</span><span class=p>,</span> <span class=no>a2</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a5</span><span class=p>,</span> <span class=no>a3</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a13</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__muldf3</span>    <span class=c1>#</span>
    <span class=nf>l32r</span>    <span class=no>a4</span><span class=p>,</span> <span class=no>.LC1015</span> <span class=c1>#,</span>
    <span class=nf>l32r</span>    <span class=no>a5</span><span class=p>,</span> <span class=no>.LC1015</span><span class=err>+</span><span class=mi>4</span>   <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__subdf3</span>    <span class=c1>#</span>
    <span class=nf>l32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>28</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>24</span> <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>20</span> <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>16</span> <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a15</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span> <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>32</span>  <span class=c1>#,,</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>As you can see the <code>double</code> needs to move many more registers around. Examplef (float) is 84 bytes, Exampled (double) is 119 bytes (+42% code size). Actually it's even worse, <code>sin</code> is larger than float version <code>sinf</code>.</p> <p>Also, never forget to explicitly tag literals as float: always put <code>1.5f</code> and not <code>1.5</code>. Let's see the impact:</p> <div class=codehilite><pre><span></span><code><span class=kt>float</span> <span class=nf>Examplef2</span><span class=p>(</span><span class=kt>float</span> <span class=n>a</span><span class=p>,</span> <span class=kt>float</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>sinf</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>b</span> <span class=o>+</span> <span class=mf>0.4</span><span class=p>)</span> <span class=o>-</span> <span class=mf>3.5</span><span class=p>;</span>    <span class=c1>// same as above with double literals</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly:</p> <div class=codehilite><pre><span></span><code>    <span class=na>.literal</span> <span class=no>.LC1014</span><span class=p>,</span> <span class=mi>0x9999999a</span><span class=p>,</span> <span class=mi>0x3fd99999</span>
    <span class=na>.literal</span> <span class=no>.LC1015</span><span class=p>,</span> <span class=mi>0x00000000</span><span class=p>,</span> <span class=mi>0x400c0000</span>
    <span class=na>.align</span>  <span class=mi>4</span>
    <span class=na>.global</span> <span class=no>_Z9Examplef2ff</span>
    <span class=na>.type</span>   <span class=no>_Z9Examplef2ff</span><span class=p>,</span> <span class=na>@function</span>
<span class=nl>_Z9Examplef2ff:</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>-16</span> <span class=c1>#,,</span>
    <span class=nf>s32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>8</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>4</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>0</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a14</span><span class=p>,</span> <span class=no>a3</span> <span class=c1># b, b</span>
    <span class=nf>call0</span>   <span class=no>sinf</span>    <span class=c1>#</span>
    <span class=nf>call0</span>   <span class=no>__extendsfdf2</span>   <span class=c1>#        &lt;- extend float to double</span>
    <span class=nf>mov.n</span>   <span class=no>a12</span><span class=p>,</span> <span class=no>a2</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a14</span> <span class=c1>#, b</span>
    <span class=nf>mov.n</span>   <span class=no>a13</span><span class=p>,</span> <span class=no>a3</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__extendsfdf2</span>   <span class=c1>#        &lt;- extend float to double</span>
    <span class=nf>l32r</span>    <span class=no>a4</span><span class=p>,</span> <span class=no>.LC1014</span> <span class=c1>#,</span>
    <span class=nf>l32r</span>    <span class=no>a5</span><span class=p>,</span> <span class=no>.LC1014</span><span class=err>+</span><span class=mi>4</span>   <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__adddf3</span>    <span class=c1>#        &lt;- add double</span>
    <span class=nf>mov.n</span>   <span class=no>a4</span><span class=p>,</span> <span class=no>a2</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a5</span><span class=p>,</span> <span class=no>a3</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a13</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__muldf3</span>    <span class=c1>#        &lt;- multiply double</span>
    <span class=nf>l32r</span>    <span class=no>a4</span><span class=p>,</span> <span class=no>.LC1015</span> <span class=c1>#,</span>
    <span class=nf>l32r</span>    <span class=no>a5</span><span class=p>,</span> <span class=no>.LC1015</span><span class=err>+</span><span class=mi>4</span>   <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>__subdf3</span>    <span class=c1>#        &lt;- substract double</span>
    <span class=nf>call0</span>   <span class=no>__truncdfsf2</span>    <span class=c1>#        &lt;- truncate double to float</span>
    <span class=nf>l32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>8</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>4</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>0</span>  <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>16</span>  <span class=c1>#,,</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>The last example takes 143 bytes, which is even worse than the <code>double</code> version, because of conversions from <code>float</code> to <code>double</code> and back. Internally, if you don't force <code>float</code> literals, gcc will make all intermediate compute in <code>double</code> and convert to <code>float</code> in the end. This is usually what is wanted: compute with maximum precision and truncate at the last moment. But for ESP8266 we want the opposite: most compact code.</p> <h3 id=string-concatenation>String concatenation<a class=headerlink href=#string-concatenation title="Permanent link">~</a></h3> <p>Let's start with an easy example:</p> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=nf>ExampleStringConcat</span><span class=p>(</span><span class=n>String</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=s>&quot;suffix&quot;</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly (25 bytes):</p> <div class=codehilite><pre><span></span><code><span class=nl>.LC1024:</span>
    <span class=na>.string</span> <span class=s>&quot;suffix&quot;</span>
    <span class=na>.literal</span> <span class=no>.LC1025</span><span class=p>,</span> <span class=no>.LC1024</span>
<span class=nl>_Z19ExampleStringConcatR6String:</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1025</span> <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>-16</span> <span class=c1>#,,</span>
    <span class=nf>s32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatEPKc</span>   <span class=c1>#</span>
    <span class=nf>l32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>16</span>  <span class=c1>#,,</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>If you need to add more complex strings, do not concatenate using native c++ concat:</p> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=nf>ExampleStringConcat2</span><span class=p>(</span><span class=n>String</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=s>&quot;[&quot;</span> <span class=o>+</span> <span class=n>String</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot;,&quot;</span> <span class=o>+</span> <span class=n>String</span><span class=p>(</span><span class=n>b</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot;]&quot;</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly (122 bytes!):</p> <div class=codehilite><pre><span></span><code><span class=nl>.LC231:</span>
    <span class=na>.string</span> <span class=s>&quot;,&quot;</span>
<span class=nl>.LC1026:</span>
    <span class=na>.string</span> <span class=s>&quot;[&quot;</span>
<span class=nl>.LC1029:</span>
    <span class=na>.string</span> <span class=s>&quot;]&quot;</span>
    <span class=na>.literal</span> <span class=no>.LC1027</span><span class=p>,</span> <span class=no>.LC1026</span>
    <span class=na>.literal</span> <span class=no>.LC1028</span><span class=p>,</span> <span class=no>.LC231</span>
    <span class=na>.literal</span> <span class=no>.LC1030</span><span class=p>,</span> <span class=no>.LC1029</span>
<span class=nl>_Z20ExampleStringConcat2R6Stringhh:</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>-64</span> <span class=c1>#,,</span>
    <span class=nf>s32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>52</span> <span class=c1>#,</span>
    <span class=nf>extui</span>   <span class=no>a13</span><span class=p>,</span> <span class=no>a3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span>   <span class=c1># a, a</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1027</span> <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>56</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a12</span><span class=p>,</span> <span class=no>a2</span> <span class=c1># s, s</span>
    <span class=nf>addi.n</span>  <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,,</span>
    <span class=nf>s32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>60</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>48</span> <span class=c1>#,</span>
    <span class=nf>extui</span>   <span class=no>a14</span><span class=p>,</span> <span class=no>a4</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span>   <span class=c1># b, b</span>
    <span class=nf>call0</span>   <span class=no>_ZN6StringC2EPKc</span>    <span class=c1># .    &lt;- allocate String</span>
    <span class=nf>movi.n</span>  <span class=no>a4</span><span class=p>,</span> <span class=mi>0xa</span> <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>24</span>  <span class=c1>#,,</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a13</span> <span class=c1>#, a</span>
    <span class=nf>call0</span>   <span class=no>_ZN6StringC1Ehh</span> <span class=c1>#              &lt;- allocate String</span>
    <span class=nf>addi</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>24</span>  <span class=c1>#,,</span>
    <span class=nf>addi.n</span>  <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,,</span>
    <span class=nf>call0</span>   <span class=no>_ZplRK15StringSumHelperRK6String</span>    <span class=c1>#</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1028</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>_ZplRK15StringSumHelperPKc</span>  <span class=c1>#</span>
    <span class=nf>movi.n</span>  <span class=no>a4</span><span class=p>,</span> <span class=mi>0xa</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a13</span><span class=p>,</span> <span class=no>a2</span> <span class=c1># D.171315,</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a14</span> <span class=c1>#, b</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span>  <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>_ZN6StringC1Ehh</span> <span class=c1>#              &lt;- allocate String</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>sp</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a13</span> <span class=c1>#, D.171315</span>
    <span class=nf>call0</span>   <span class=no>_ZplRK15StringSumHelperRK6String</span>    <span class=c1>#</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1030</span> <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>_ZplRK15StringSumHelperPKc</span>  <span class=c1>#</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a2</span>  <span class=c1># D.171315,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#, s</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatERKS_</span>  <span class=c1>#</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span>  <span class=c1>#,</span>
    <span class=nf>call0</span>   <span class=no>_ZN6StringD1Ev</span>  <span class=c1>#              &lt;- destructor</span>
    <span class=nf>addi</span>    <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>24</span>  <span class=c1>#,,</span>
    <span class=nf>call0</span>   <span class=no>_ZN6StringD1Ev</span>  <span class=c1>#              &lt;- destructor</span>
    <span class=nf>addi.n</span>  <span class=no>a2</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,,</span>
    <span class=nf>call0</span>   <span class=no>_ZN6StringD2Ev</span>  <span class=c1>#          &lt;- destructor</span>
    <span class=nf>l32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>60</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>56</span> <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>52</span> <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>48</span> <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>64</span>  <span class=c1>#,,</span>
    <span class=nf>ret.n</span>
</code></pre></div> <p>Instead use native <code>String</code> concat:</p> <div class=codehilite><pre><span></span><code><span class=kt>void</span> <span class=nf>ExampleStringConcat3</span><span class=p>(</span><span class=n>String</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>a</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=s>&quot;[&quot;</span><span class=p>;</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=n>a</span><span class=p>;</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=s>&quot;,&quot;</span><span class=p>;</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=n>b</span><span class=p>;</span>
  <span class=n>s</span> <span class=o>+=</span> <span class=s>&quot;]&quot;</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>Assembly (69 bytes, -43%):</p> <div class=codehilite><pre><span></span><code><span class=nl>.LC231:</span>
    <span class=na>.string</span> <span class=s>&quot;,&quot;</span>
<span class=nl>.LC1026:</span>
    <span class=na>.string</span> <span class=s>&quot;[&quot;</span>
<span class=nl>.LC1029:</span>
    <span class=na>.string</span> <span class=s>&quot;]&quot;</span>
    <span class=na>.literal</span> <span class=no>.LC1031</span><span class=p>,</span> <span class=no>.LC1026</span>
    <span class=na>.literal</span> <span class=no>.LC1032</span><span class=p>,</span> <span class=no>.LC231</span>
    <span class=na>.literal</span> <span class=no>.LC1033</span><span class=p>,</span> <span class=no>.LC1029</span>
<span class=nl>_Z20ExampleStringConcat3R6Stringhh:</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>-16</span> <span class=c1>#,,</span>
    <span class=nf>s32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>4</span>  <span class=c1>#,</span>
    <span class=nf>extui</span>   <span class=no>a13</span><span class=p>,</span> <span class=no>a3</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span>   <span class=c1># a, a</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1031</span> <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>8</span>  <span class=c1>#,</span>
    <span class=nf>s32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>0</span>  <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a12</span><span class=p>,</span> <span class=no>a2</span> <span class=c1># s, s</span>
    <span class=nf>extui</span>   <span class=no>a14</span><span class=p>,</span> <span class=no>a4</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>8</span>   <span class=c1># b, b</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatEPKc</span>   <span class=c1>#       &lt;- native char* add</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a13</span> <span class=c1>#, a</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#, s</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatEh</span> <span class=c1>#       &lt;- native int add</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1032</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#, s</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatEPKc</span>   <span class=c1>#       &lt;- native char* add</span>
    <span class=nf>mov.n</span>   <span class=no>a3</span><span class=p>,</span> <span class=no>a14</span> <span class=c1>#, b</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#, s</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatEh</span> <span class=c1>#       &lt;- native int add</span>
    <span class=nf>l32r</span>    <span class=no>a3</span><span class=p>,</span> <span class=no>.LC1033</span> <span class=c1>#,</span>
    <span class=nf>mov.n</span>   <span class=no>a2</span><span class=p>,</span> <span class=no>a12</span> <span class=c1>#, s</span>
    <span class=nf>call0</span>   <span class=no>_ZN6String6concatEPKc</span>   <span class=c1>#       &lt;- native char* add</span>
    <span class=nf>l32i.n</span>  <span class=no>a0</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>12</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a12</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>8</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a13</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>4</span>  <span class=c1>#,</span>
    <span class=nf>l32i.n</span>  <span class=no>a14</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>0</span>  <span class=c1>#,</span>
    <span class=nf>addi</span>    <span class=no>sp</span><span class=p>,</span> <span class=no>sp</span><span class=p>,</span> <span class=mi>16</span>  <span class=c1>#,,</span>
    <span class=nf>ret.n</span>
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M297.216 243.2c0 15.616-11.52 28.416-26.112 28.416-14.336 0-26.112-12.8-26.112-28.416s11.52-28.416 26.112-28.416c14.592 0 26.112 12.8 26.112 28.416zm-119.552-28.416c-14.592 0-26.112 12.8-26.112 28.416s11.776 28.416 26.112 28.416c14.592 0 26.112-12.8 26.112-28.416.256-15.616-11.52-28.416-26.112-28.416zM448 52.736V512c-64.494-56.994-43.868-38.128-118.784-107.776l13.568 47.36H52.48C23.552 451.584 0 428.032 0 398.848V52.736C0 23.552 23.552 0 52.48 0h343.04C424.448 0 448 23.552 448 52.736zm-72.96 242.688c0-82.432-36.864-149.248-36.864-149.248-36.864-27.648-71.936-26.88-71.936-26.88l-3.584 4.096c43.52 13.312 63.744 32.512 63.744 32.512-60.811-33.329-132.244-33.335-191.232-7.424-9.472 4.352-15.104 7.424-15.104 7.424s21.248-20.224 67.328-33.536l-2.56-3.072s-35.072-.768-71.936 26.88c0 0-36.864 66.816-36.864 149.248 0 0 21.504 37.12 78.08 38.912 0 0 9.472-11.52 17.152-21.248-32.512-9.728-44.8-30.208-44.8-30.208 3.766 2.636 9.976 6.053 10.496 6.4 43.21 24.198 104.588 32.126 159.744 8.96 8.96-3.328 18.944-8.192 29.44-15.104 0 0-12.8 20.992-46.336 30.464 7.68 9.728 16.896 20.736 16.896 20.736 56.576-1.792 78.336-38.912 78.336-38.912z"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../assets/javascripts/vendor.18f0862e.min.js></script> <script src=../assets/javascripts/bundle.994580cf.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "..",
          features: ['navigation.tabs', 'navigation.instant'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>