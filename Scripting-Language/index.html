<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Documentation (Wiki) for Tasmota"><link href=https://tasmota.github.io/docs/Scripting-Language/ rel=canonical><link rel="shortcut icon" href=../_media/favicon.ico><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.8"><title>Scripting - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.cb6bc1d0.min.css><link rel=stylesheet href=../assets/stylesheets/palette.39b8e14a.min.css><meta name=theme-color content=#2094f3><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Barlow",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-140681905-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=blue data-md-color-accent=indigo> <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#features class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://tasmota.github.io/docs/ title=Tasmota class="md-header-nav__button md-logo" aria-label=Tasmota> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <div class=md-header-nav__topic> <span class=md-ellipsis> Tasmota </span> </div> <div class=md-header-nav__topic> <span class=md-ellipsis> Scripting </span> </div> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/arendst/tasmota/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../About/ class=md-tabs__link> About </a> </li> <li class=md-tabs__item> <a href=../Getting-Started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../Upgrading/ class=md-tabs__link> Upgrading </a> </li> <li class=md-tabs__item> <a href=../MQTT/ class=md-tabs__link> MQTT </a> </li> <li class=md-tabs__item> <a href=../Commands/ class=md-tabs__link> Commands </a> </li> <li class=md-tabs__item> <a href=../Templates/ class=md-tabs__link> Templates </a> </li> <li class=md-tabs__item> <a href=../Components/ class=md-tabs__link> Components </a> </li> <li class=md-tabs__item> <a href=../Modules/ class=md-tabs__link> Modules </a> </li> <li class=md-tabs__item> <a href=../Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../WebUI/ class=md-tabs__link> WebUI </a> </li> <li class=md-tabs__item> <a href=../Features/ class="md-tabs__link md-tabs__link--active"> Features </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> <li class=md-tabs__item> <a href=../Builds/ class=md-tabs__link> Builds </a> </li> <li class=md-tabs__item> <a href=../Compile-your-build/ class=md-tabs__link> Compiling </a> </li> <li class=md-tabs__item> <a href=../Contributing/ class=md-tabs__link> Contributing </a> </li> <li class=md-tabs__item> <a href="http://ota.tasmota.com/tasmota/release/ " target='_blank""' class=md-tabs__link> Download </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://tasmota.github.io/docs/ title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../About/ class=md-nav__link> About </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../Upgrading/ class=md-nav__link> Upgrading </a> </li> <li class=md-nav__item> <a href=../MQTT/ class=md-nav__link> MQTT </a> </li> <li class=md-nav__item> <a href=../Commands/ class=md-nav__link> Commands </a> </li> <li class=md-nav__item> <a href=../Templates/ class=md-nav__link> Templates </a> </li> <li class=md-nav__item> <a href=../Components/ class=md-nav__link> Components </a> </li> <li class=md-nav__item> <a href=../Modules/ class=md-nav__link> Modules </a> </li> <li class=md-nav__item> <a href=../Peripherals/ class=md-nav__link> Peripherals </a> </li> <li class=md-nav__item> <a href=../WebUI/ class=md-nav__link> WebUI </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-12 type=checkbox id=nav-12 checked> <label class=md-nav__link for=nav-12> Features <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Features data-md-level=1> <label class=md-nav__title for=nav-12> <span class="md-nav__icon md-icon"></span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Features/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../bluetooth/Bluetooth-Esp32/ class=md-nav__link> Bluetooth ESP32 </a> </li> <li class=md-nav__item> <a href=../bluetooth/Bluetooth-Esp8266/ class=md-nav__link> Bluetooth ESP8266 </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ class=md-nav__link> Buttons and Switches </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ class=md-nav__link> DeepSleep </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ class=md-nav__link> Device Groups </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ class=md-nav__link> Dynamic Sleep </a> </li> <li class=md-nav__item> <a href=../I2CDevices/ class=md-nav__link> I2C Devices </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ class=md-nav__link> IR Communication </a> </li> <li class=md-nav__item> <a href=../Lights/ class=md-nav__link> Lights </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> OpenTherm </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ class=md-nav__link> PIR Motion Sensors </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ class=md-nav__link> Power Monitoring Calibration </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ class=md-nav__link> PWM Dimmer </a> </li> <li class=md-nav__item> <a href=../RF-Protocol/ class=md-nav__link> RF 433MHz Protocol </a> </li> <li class=md-nav__item> <a href=../Rules/ class=md-nav__link> Rules </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Scripting <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Scripting </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#features class=md-nav__link> Features </a> </li> <li class=md-nav__item> <a href=#script-sections class=md-nav__link> Script Sections </a> </li> <li class=md-nav__item> <a href=#special-variables class=md-nav__link> Special Variables </a> </li> <li class=md-nav__item> <a href=#commands class=md-nav__link> Commands </a> </li> <li class=md-nav__item> <a href=#scripting-cookbook class=md-nav__link> Scripting Cookbook </a> <nav class=md-nav aria-label="Scripting Cookbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#scripting-language-example class=md-nav__link> Scripting Language Example </a> </li> <li class=md-nav__item> <a href=#sensor-logging class=md-nav__link> Sensor Logging </a> </li> <li class=md-nav__item> <a href=#e-paper-29-display-with-sgp30-and-bme280 class=md-nav__link> e-Paper 29 Display with SGP30 and BME280 </a> </li> <li class=md-nav__item> <a href=#e-paper-42-display-with-sht31-and-bme280 class=md-nav__link> e-Paper 42 Display with SHT31 and BME280 </a> </li> <li class=md-nav__item> <a href=#ili-9488-color-lcd-display-with-bmp280-and-vl5310x class=md-nav__link> ILI 9488 Color LCD Display with BMP280 and VL5310X </a> </li> <li class=md-nav__item> <a href=#led-bar-display-with-ws2812-led-chain class=md-nav__link> LED Bar Display with WS2812 LED Chain </a> </li> <li class=md-nav__item> <a href=#multiple-ir-receiver-synchronization class=md-nav__link> Multiple IR Receiver Synchronization </a> </li> <li class=md-nav__item> <a href=#fast-polling class=md-nav__link> Fast Polling </a> </li> <li class=md-nav__item> <a href=#web-ui class=md-nav__link> Web UI </a> </li> <li class=md-nav__item> <a href=#hue-emulation class=md-nav__link> Hue Emulation </a> </li> <li class=md-nav__item> <a href=#alexa-controlled-mcp230xx-i2c-gpio-expander class=md-nav__link> Alexa Controlled MCP230xx I2C GPIO Expander </a> </li> <li class=md-nav__item> <a href=#retrieve-network-gateway-ip-address class=md-nav__link> Retrieve network gateway IP Address </a> </li> <li class=md-nav__item> <a href=#send-e-mail class=md-nav__link> Send e-mail </a> </li> <li class=md-nav__item> <a href=#switching-and-dimming-by-recognizing-mains-power-frequency class=md-nav__link> Switching and Dimming By Recognizing Mains Power Frequency </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Serial-to-TCP-Bridge/ class=md-nav__link> Serial to TCP Bridge </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ class=md-nav__link> Shutters and Blinds </a> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ class=md-nav__link> Smart Meter Interface </a> </li> <li class=md-nav__item> <a href=../Subscribe-%26-Unsubscribe/ class=md-nav__link> Subscribe & Unsubscribe </a> </li> <li class=md-nav__item> <a href=../TasmotaClient/ class=md-nav__link> TasmotaClient </a> </li> <li class=md-nav__item> <a href=../Thermostat/ class=md-nav__link> Thermostat </a> </li> <li class=md-nav__item> <a href=../Timers/ class=md-nav__link> Timers </a> </li> <li class=md-nav__item> <a href=../TLS/ class=md-nav__link> TLS Secured MQTT </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ class=md-nav__link> TuyaMCU </a> </li> <li class=md-nav__item> <a href=../Zigbee/ class=md-nav__link> Zigbee </a> </li> <li class=md-nav__item> <a href=../Tutorials/ class=md-nav__link> Projects and Tutorials </a> </li> <li class=md-nav__item> <a href=../For-Developers/ class=md-nav__link> For Developers </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-13 type=checkbox id=nav-13> <label class=md-nav__link for=nav-13> Smart Home Integrations <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Smart Home Integrations" data-md-level=1> <label class=md-nav__title for=nav-13> <span class="md-nav__icon md-icon"></span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../Alexa/ class=md-nav__link> Alexa </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ class=md-nav__link> AWS IoT </a> </li> <li class=md-nav__item> <a href=../Domoticz/ class=md-nav__link> Domoticz </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ class=md-nav__link> Home Assistant </a> </li> <li class=md-nav__item> <a href=../Homebridge/ class=md-nav__link> Homebridge </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ class=md-nav__link> HomeSeer </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ class=md-nav__link> IP Symcon </a> </li> <li class=md-nav__item> <a href=../KNX/ class=md-nav__link> KNX </a> </li> <li class=md-nav__item> <a href=../NodeRed/ class=md-nav__link> NodeRed </a> </li> <li class=md-nav__item> <a href=../nymea/ class=md-nav__link> nymea </a> </li> <li class=md-nav__item> <a href=../Octoprint/ class=md-nav__link> OctoPrint </a> </li> <li class=md-nav__item> <a href=../openHAB/ class=md-nav__link> openHAB </a> </li> <li class=md-nav__item> <a href=../otto/ class=md-nav__link> Otto </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 class=md-nav__link> IOBroker </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter class=md-nav__link> Mozilla WebThings Adapter </a> </li> <li class=md-nav__item> <a href=https://github.com/hongtat/tasmota-connect class=md-nav__link> SmartThings </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-14 type=checkbox id=nav-14> <label class=md-nav__link for=nav-14> Peripherals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Peripherals data-md-level=1> <label class=md-nav__title for=nav-14> <span class="md-nav__icon md-icon"></span> Peripherals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Supported-Peripherals/ class=md-nav__link> Supported Peripherals </a> </li> <li class=md-nav__item> <a href=../ADC/ class=md-nav__link> Analog pin </a> </li> <li class=md-nav__item> <a href=../Buzzer/ class=md-nav__link> Buzzer </a> </li> <li class=md-nav__item> <a href=../Displays/ class=md-nav__link> Displays </a> </li> <li class=md-nav__item> <a href=../ESP32/ class=md-nav__link> ESP32 Support (Beta development) </a> </li> <li class=md-nav__item> <a href=../A4988-Stepper-Motor-Controller/ class=md-nav__link> A4988 stepper motor controller </a> </li> <li class=md-nav__item> <a href=../AHT1x/ class=md-nav__link> AHT1x temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../AM2301/ class=md-nav__link> AM2301 temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../APDS-9960/ class=md-nav__link> APDS-9960 light and gesture sensor </a> </li> <li class=md-nav__item> <a href=../AS3935/ class=md-nav__link> AS3935 Franklin Lightning sensor </a> </li> <li class=md-nav__item> <a href=../AZ-7798/ class=md-nav__link> AZ7798 CO<sub>2</sub> meter </a> </li> <li class=md-nav__item> <a href=../BH1750/ class=md-nav__link> BH1750 ambient light sensor </a> </li> <li class=md-nav__item> <a href=../BME280/ class=md-nav__link> BME280 temperature, humidity and pressure sensor </a> </li> <li class=md-nav__item> <a href=../BME680/ class=md-nav__link> BME680 temperature, humidity, pressure and gas sensor </a> </li> <li class=md-nav__item> <a href=../CC2530/ class=md-nav__link> CC253x Zigbee module </a> </li> <li class=md-nav__item> <a href=../Moisture-Sensor-and-Chirp%21-Sensor/ class=md-nav__link> Chirp! moisture sensor </a> </li> <li class=md-nav__item> <a href=../DHT11/ class=md-nav__link> DHT11 temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../DS18x20/ class=md-nav__link> DS18x20 temperature sensor </a> </li> <li class=md-nav__item> <a href=../DS3231/ class=md-nav__link> DS3231 Real Time Clock </a> </li> <li class=md-nav__item> <a href=../EZO/ class=md-nav__link> EZO sensors </a> </li> <li class=md-nav__item> <a href=../HM-10/ class=md-nav__link> HM-10 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../HM-17/ class=md-nav__link> HM-17 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../HC-SR04/ class=md-nav__link> HC-SR04 ultrasonic ranging sensor </a> </li> <li class=md-nav__item> <a href=../Honeywell-HIH/ class=md-nav__link> Honeywell HIH temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../IAQ/ class=md-nav__link> iAQ-Core indoor air quality sensor </a> </li> <li class=md-nav__item> <a href=../IR-Remote/ class=md-nav__link> IR Remote </a> </li> <li class=md-nav__item> <a href=../LM75AD/ class=md-nav__link> LM75AD temperature sensor </a> </li> <li class=md-nav__item> <a href=../MCP230xx/ class=md-nav__link> MCP23008 / MCP23017 GPIO Expander </a> </li> <li class=md-nav__item> <a href=../MGC3130/ class=md-nav__link> MGC3130 3D tracking and gesture controller </a> </li> <li class=md-nav__item> <a href=../MH-Z19B/ class=md-nav__link> MH-Z19B CO<sub>2</sub> Sensor </a> </li> <li class=md-nav__item> <a href=../MLX90614/ class=md-nav__link> MLX90614 infrared thermometer </a> </li> <li class=md-nav__item> <a href=../MLX90640/ class=md-nav__link> MLX90640 Far infrared thermal sensor array </a> </li> <li class=md-nav__item> <a href=../MPR121/ class=md-nav__link> MPR121 capacitive touch sensor </a> </li> <li class=md-nav__item> <a href=../MPU-6050/ class=md-nav__link> MPU-6050 gyroscope and accelerometer </a> </li> <li class=md-nav__item> <a href=../NRF24L01/ class=md-nav__link> NRF24L01 module </a> </li> <li class=md-nav__item> <a href=../OpenTherm/ class=md-nav__link> OpenTherm </a> </li> <li class=md-nav__item> <a href=../P1-Smart-Meter/ class=md-nav__link> P1 Smart Meter </a> </li> <li class=md-nav__item> <a href=../PAJ7620/ class=md-nav__link> PAJ7620U2 gesture sensor </a> </li> <li class=md-nav__item> <a href=../PCA9685/ class=md-nav__link> PCA9685 12-bit PWM controller </a> </li> <li class=md-nav__item> <a href=../PN532/ class=md-nav__link> PN532 NFC reader </a> </li> <li class=md-nav__item> <a href=../PZEM-0XX/ class=md-nav__link> PZEM-0xx power monitor </a> </li> <li class=md-nav__item> <a href=../RCWL-0516/ class=md-nav__link> RCWL-0516 microwave radar motion sensor </a> </li> <li class=md-nav__item> <a href=../RDM6300/ class=md-nav__link> RDM6300 RFID reader </a> </li> <li class=md-nav__item> <a href=../RF-Transciever/ class=md-nav__link> RF Transciever </a> </li> <li class=md-nav__item> <a href=../SDS011/ class=md-nav__link> SDS011 air quality sensor </a> </li> <li class=md-nav__item> <a href=../SHT30/ class=md-nav__link> SHT30 temperature sensor </a> </li> <li class=md-nav__item> <a href=../TX2x/ class=md-nav__link> TX20/TX23 anemometer </a> </li> <li class=md-nav__item> <a href=../TSL2561/ class=md-nav__link> TSL2561 light sensor </a> </li> <li class=md-nav__item> <a href=../VEML6070/ class=md-nav__link> VEML6070 UV light sensor </a> </li> <li class=md-nav__item> <a href=../VEML6075/ class=md-nav__link> VEML6075 UVA/UVB/UVINDEX Sensor </a> </li> <li class=md-nav__item> <a href=../VEML7700/ class=md-nav__link> VEML7700 Ambient light sensor </a> </li> <li class=md-nav__item> <a href=../VL53L0x/ class=md-nav__link> VL53L0X laser ranging module </a> </li> <li class=md-nav__item> <a href=../WS2812B-RGB-Shield/ class=md-nav__link> WS2812B RGB Shield </a> </li> <li class=md-nav__item> <a href=../WS2812B-and-WS2813/ class=md-nav__link> WS2812B and WS2813 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-15 type=checkbox id=nav-15> <label class=md-nav__link for=nav-15> Supported Devices <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Supported Devices" data-md-level=1> <label class=md-nav__title for=nav-15> <span class="md-nav__icon md-icon"></span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-nav__link> Configure Unknown Device </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' class=md-nav__link> All Supported Devices </a> </li> <li class=md-nav__item> <a href=../Pinouts/ class=md-nav__link> Wi-Fi Module Pinouts </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ class=md-nav__link> Supported Modules </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-16 type=checkbox id=nav-16> <label class=md-nav__link for=nav-16> Help <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Help data-md-level=1> <label class=md-nav__title for=nav-16> <span class="md-nav__icon md-icon"></span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ class=md-nav__link> Device Recovery </a> </li> <li class=md-nav__item> <a href="https://discord.gg/Ks2Kzd4 " target='_blank""' class=md-nav__link> Discord Support </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Builds/ class=md-nav__link> Builds </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ class=md-nav__link> Compiling </a> </li> <li class=md-nav__item> <a href=../Contributing/ class=md-nav__link> Contributing </a> </li> <li class=md-nav__item> <a href="http://ota.tasmota.com/tasmota/release/ " target='_blank""' class=md-nav__link> Download </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#features class=md-nav__link> Features </a> </li> <li class=md-nav__item> <a href=#script-sections class=md-nav__link> Script Sections </a> </li> <li class=md-nav__item> <a href=#special-variables class=md-nav__link> Special Variables </a> </li> <li class=md-nav__item> <a href=#commands class=md-nav__link> Commands </a> </li> <li class=md-nav__item> <a href=#scripting-cookbook class=md-nav__link> Scripting Cookbook </a> <nav class=md-nav aria-label="Scripting Cookbook"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#scripting-language-example class=md-nav__link> Scripting Language Example </a> </li> <li class=md-nav__item> <a href=#sensor-logging class=md-nav__link> Sensor Logging </a> </li> <li class=md-nav__item> <a href=#e-paper-29-display-with-sgp30-and-bme280 class=md-nav__link> e-Paper 29 Display with SGP30 and BME280 </a> </li> <li class=md-nav__item> <a href=#e-paper-42-display-with-sht31-and-bme280 class=md-nav__link> e-Paper 42 Display with SHT31 and BME280 </a> </li> <li class=md-nav__item> <a href=#ili-9488-color-lcd-display-with-bmp280-and-vl5310x class=md-nav__link> ILI 9488 Color LCD Display with BMP280 and VL5310X </a> </li> <li class=md-nav__item> <a href=#led-bar-display-with-ws2812-led-chain class=md-nav__link> LED Bar Display with WS2812 LED Chain </a> </li> <li class=md-nav__item> <a href=#multiple-ir-receiver-synchronization class=md-nav__link> Multiple IR Receiver Synchronization </a> </li> <li class=md-nav__item> <a href=#fast-polling class=md-nav__link> Fast Polling </a> </li> <li class=md-nav__item> <a href=#web-ui class=md-nav__link> Web UI </a> </li> <li class=md-nav__item> <a href=#hue-emulation class=md-nav__link> Hue Emulation </a> </li> <li class=md-nav__item> <a href=#alexa-controlled-mcp230xx-i2c-gpio-expander class=md-nav__link> Alexa Controlled MCP230xx I2C GPIO Expander </a> </li> <li class=md-nav__item> <a href=#retrieve-network-gateway-ip-address class=md-nav__link> Retrieve network gateway IP Address </a> </li> <li class=md-nav__item> <a href=#send-e-mail class=md-nav__link> Send e-mail </a> </li> <li class=md-nav__item> <a href=#switching-and-dimming-by-recognizing-mains-power-frequency class=md-nav__link> Switching and Dimming By Recognizing Mains Power Frequency </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/Scripting-Language.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>Scripting</h1> <div class="admonition failure"> <p class=admonition-title>This feature is not included in precompiled binaries</p> </div> <p>To use it you must <a href=../Compile-your-build/ >compile your build</a>. Add the following to <code>user_config_override.h</code>:</p> <div class=codehilite><pre><span></span><code><span class=cp>#ifndef USE_SCRIPT</span>
<span class=cp>#define USE_SCRIPT  </span><span class=c1>// adds about 17k flash size, variable ram size</span>
<span class=cp>#endif</span>
<span class=cp>#ifdef USE_RULES</span>
<span class=cp>#undef USE_RULES</span>
<span class=cp>#endif  </span>
</code></pre></div> <p>Additional features are enabled by adding the following <code>#define</code> compiler directive parameters and then compiling the firmware. These parameters are explained further below in the article.</p> <table> <thead> <tr> <th>Feature</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>USE_BUTTON_EVENT</td> <td>enable <code>&gt;b</code> section (detect button state changes)</td> </tr> <tr> <td>USE_SCRIPT_JSON_EXPORT</td> <td>enable <code>&gt;J</code> section (publish JSON payload on <a href=../Commands/#teleperiod>TelePeriod</a>)</td> </tr> <tr> <td>USE_SCRIPT_SUB_COMMAND</td> <td>enables invoking named script subroutines via the Console or MQTT</td> </tr> <tr> <td>USE_SCRIPT_HUE</td> <td>enable <code>&gt;H</code> section (Alexa Hue emulation)</td> </tr> <tr> <td>USE_SCRIPT_STATUS</td> <td>enable <code>&gt;U</code> section (receive JSON payloads from cmd status)</td> </tr> <tr> <td>SCRIPT_POWER_SECTION</td> <td>enable <code>&gt;P</code> section (execute on power changes)</td> </tr> <tr> <td>SUPPORT_MQTT_EVENT</td> <td>enables support for subscribe unsubscribe</td> </tr> <tr> <td>USE_SENDMAIL</td> <td>enable <code>&gt;m</code> section and support for sending e-mail</td> </tr> <tr> <td>USE_SCRIPT_WEB_DISPLAY</td> <td>enable <code>&gt;W</code> section (modify web UI)</td> </tr> <tr> <td>SCRIPT_FULL_WEBPAGE</td> <td>enable <code>&gt;w</code> section (seperate full web page and webserver)</td> </tr> <tr> <td>USE_TOUCH_BUTTONS</td> <td>enable virtual touch button support with touch displays</td> </tr> <tr> <td>USE_WEBSEND_RESPONSE</td> <td>enable receiving the response of a <a href=../Commands/#websend><code>WebSend</code></a> command (received in section &gt;E)</td> </tr> <tr> <td>SCRIPT_STRIP_COMMENTS</td> <td>enables stripping comments when attempting to paste a script that is too large to fit</td> </tr> <tr> <td>USE_ANGLE_FUNC</td> <td>add sin(x),acos(x) and sqrt(x) e.g. to allow calculation of horizontal cylinder volume</td> </tr> <tr> <td>USE_24C256</td> <td>enables use of 24C256 I<sup>2</sup>C EEPROM to expand script buffer (defaults to 4k)</td> </tr> <tr> <td>USE_SCRIPT_FATFS</td> <td>enables SD card support (on SPI bus). Specify the CS pin number. Also enables 4k script buffer on ESP8266 if using device with 4 or more Mb can enable FS by specifying -1 (using linker files with enabled FS Buffer e.g. eagle.flash.4m1m.ld)</td> </tr> <tr> <td>USE_SCRIPT_FATFS_EXT</td> <td>enables additional FS commands</td> </tr> <tr> <td>SDCARD_DIR</td> <td>enables support for web UI for SD card directory upload and download</td> </tr> <tr> <td>USE_WEBCAM</td> <td>enables support ESP32 Webcam which is controlled by scripter cmds</td> </tr> <tr> <td>USE_FACE_DETECT</td> <td>enables face detecting in ESP32 Webcam</td> </tr> <tr> <td>USE_SCRIPT_TASK</td> <td>enables multitasking Task in ESP32</td> </tr> <tr> <td>USE_SCRIPT_GLOBVARS</td> <td>enables global variables and &gt;G section</td> </tr> <tr> <td>USE_SML_M</td> <td>enables <a href=../Smart-Meter-Interface/ >Smart Meter Interface</a></td> </tr> <tr> <td>SML_REPLACE_VARS</td> <td>enables posibility to replace the lines from the (SML) descriptor with Vars</td> </tr> <tr> <td>USE_SML_SCRIPT_CMD</td> <td>enables SML script cmds</td> </tr> <tr> <td>USE_SCRIPT_TIMER</td> <td>enables up to 4 timers</td> </tr> <tr> <td>SCRIPT_GET_HTTPS_JP</td> <td>enables reading HTTPS JSON WEB Pages (e.g. Tesla Powerwall)</td> </tr> <tr> <td>LARGE_ARRAYS</td> <td>enables arrays of up to 1000 entries instead of max 127</td> </tr> <tr> <td>SCRIPT_LARGE_VNBUFF</td> <td>enables to use 4096 in stead of 256 bytes buffer for variable names</td> </tr> <tr> <td>LITTLEFS_SCRIPT_SIZE S</td> <td>enables script buffer of size S (e.g.4096)</td> </tr> <tr> <td>USE_GOOGLE_CHARTS</td> <td>enables defintion of google charts within web section</td> </tr> <tr> <td>USE_DSIPLAY_DUMP</td> <td>enables to show epaper screen as BMP image in &gt;w section</td> </tr> <tr> <td>----</td> <td></td> </tr> </tbody> </table> <div class="admonition info"> <p class=admonition-title>Scripting Language for Tasmota is an alternative to Tasmota <a href=../Rules/ >Rules</a></p> </div> <p>To enter a script, go to <strong>Configuration - Edit script</strong> in the Tasmota web UI menu</p> <p>The maximum script size is 1535 bytes (uses rule set buffers). If the pasted script is larger than 1535 characters, comments will be stripped to attempt to make the script fit. </p> <p>To save code space almost no error messages are provided. However it is taken care of that at least it should not crash on syntax errors. </p> <h3 id=features>Features<a class=headerlink href=#features title="Permanent link">~</a></h3> <ul> <li>Up to 50 variables (45 numeric and 5 strings - this may be changed by setting a compilation <code>#define</code> directive) </li> <li>Freely definable variable names (all variable names are intentionally <em><strong>case sensitive</strong></em>) </li> <li>Nested if,then,else up to a level of 8 </li> <li>Math operators <code>+</code>,<code>-</code>,<code>*</code>,<code>/</code>,<code>%</code>,<code>&amp;</code>,<code>|</code>,<code>^</code> </li> <li>All operators may be used in the <code>op=</code> form, e.g., <code>+=</code> </li> <li>Comparison operators <code>==</code>,<code>!=</code>,<code>&gt;</code>,<code>&gt;=</code>,<code>&lt;</code>,<code>&lt;=</code> </li> <li><code>and</code> , <code>or</code> support </li> <li>Hexadecimal numbers with prefix <code>0x</code> are supported</li> <li>Strings support <code>+</code> and <code>+=</code> operators </li> <li>Support for \n \r regular expressions on strings</li> <li>String comparison <code>==</code>, <code>!=</code> </li> <li>String size is 19 characters (default). This can be increased or decreased by the optional parameter on the <code>D</code> section definition</li> </ul> <p><strong>Script Interpreter</strong> </p> <ul> <li>Execution is <em><strong>strictly sequential</strong></em>, <em><strong>line by line</strong></em></li> <li>Evaluation is <em><strong>left to right</strong></em> with optional brackets </li> <li>All <em><strong>numbers are float</strong></em>, e.g., temp=hum*(100/37.5)+temp-(timer*hum%10) </li> <li><em><strong>No spaces are allowed between math operators</strong></em></li> <li>Comments start with <code>;</code> </li> </ul> <p><strong>Script buffer size</strong><br> the script language normally shares script buffer with rules buffer which is 1536 chars. with below options script buffer size may be expanded. PVARS is size for permanant vars.</p> <table> <thead> <tr> <th>Feature</th> <th>ESP8266</th> <th>ESP32</th> <th>PVARS</th> <th>remarks</th> </tr> </thead> <tbody> <tr> <td>fallback</td> <td>1536</td> <td>1536</td> <td>50</td> <td></td> </tr> <tr> <td>compression (default)</td> <td>2560</td> <td>2560</td> <td>50</td> <td>actual compression rate may vary</td> </tr> <tr> <td>#define LITTLEFS_SCRIPT_SIZE S</td> <td>S&lt;=4096</td> <td>S&lt;=16384</td> <td>1536</td> <td>ESP8266 must use 4M Flash with SPIFFS section use linker option -Wl,-Teagle.flash.4m2m.ld</td> </tr> <tr> <td>#define USE_SCRIPT_FATFS -1, #define FAT_SCRIPT_SIZE S</td> <td>S&lt;=4096</td> <td>S&lt;=16384</td> <td>1536</td> <td>ESP8266 must use 4M Flash with SPIFFS section use linker option -Wl,-Teagle.flash.4m2m.ld, ESP32 must use linker file "esp32_partition_app1572k_ffat983k.csv"(4M chips) or "esp32_partition_app1984k_ffat12M.csv" (16M chips)</td> </tr> <tr> <td>#define USE_SCRIPT_FATFS CS, #define FAT_SCRIPT_SIZE S</td> <td>S&lt;=4096</td> <td>S&lt;=16384</td> <td>1536</td> <td>requires SPI SD card, CS is chip select pin of SD card</td> </tr> <tr> <td>#define EEP_SCRIPT_SIZE S, #define USE_EEPROM, #define USE_24C256</td> <td>S&lt;=4096</td> <td>S&lt;=8192</td> <td>1536</td> <td>only hardware eeprom is usefull, because Flash EEPROM is also used by Tasmota</td> </tr> <tr> <td>#define EEP_SCRIPT_SIZE S, #define ALT_EEPROM</td> <td>S&lt;=6500</td> <td></td> <td>1536</td> <td>you must use setoption12 1 to disable flash rotation</td> </tr> </tbody> </table> <p>most usefull defintion for larger scripts would be </p> <p>ESP8266: </p> <p>with 1M flash only default compressed mode should be used<br> a special mode can enable up to 6500 chars by defining #define ALT_EEPROM<br> however this has some side effects. the script is deleted on OTA or serial update and has to be installed fresh after update. </p> <p>with 4M Flash best mode would be<br> #define USE_SCRIPT_FATFS -1<br> with linker file "eagle.flash.4m2m.ld" </p> <p>ESP32: </p> <p>with standard linker file<br> #define LITTLEFS_SCRIPT_SIZE 8192<br> or better:<br> #define USE_SCRIPT_FATFS -1<br> #define FAT_SCRIPT_SIZE 8192<br> with linker file "esp32_partition_app1572k_ffat983k.csv" </p> <p><strong>Optional external editor</strong> </p> <p>you may use a special external editor with syntax highlighting to edit the scripts. (mac and pc) you may use any number of comments and indents to make it better readable. then with cmd r the script is transfered to the ESP and immediately started. (all comments and indents are removed before transfering) see further info and download <a href="https://www.dropbox.com/sh/0us18ohui4c3k82/AACcVmpZ4AfpdrWE_MPFGmbma?dl=0">here</a> </p> <p><strong>Console Commands</strong> </p> <p><code>script &lt;n&gt;</code> <n>: <code>0</code> = switch script off; <code>1</code> = switch script on<br> <code>script &gt;&lt;cmdline&gt;</code> execute <cmdline><br> - Can be used to set variables, e.g., <code>script &gt;mintmp=15</code><br> - Multiple statements can be specified by separating each with a semicolon, e.g. <code>script &gt;mintmp=15;maxtemp=40</code> </p> <p><code>script?&lt;var&gt;</code> queries a script variable <code>var</code> </p> <ul> <li>The script itself can't be specified because the size would not fit the MQTT buffers</li> </ul> <h2 id=script-sections>Script Sections<a class=headerlink href=#script-sections title="Permanent link">~</a></h2> <p><em>Section descriptors (e.g., <code>&gt;E</code>) are <strong>case sensitive</strong></em><br> a valid script must start with &gt;D in the first line<br> <code>&gt;D ssize</code> <br> <code>ssize</code> = optional max string size (default=19)<br> define and init variables here, must be the first section, no other code allowed<br> <code>p:vname</code> <br> specifies permanent variables. The number of permanent variables is limited by Tasmota rules space (50 bytes) - numeric variables are 4 bytes; string variables are one byte longer than the length of string<br> <code>t:vname</code> <br> specifies countdown timers, if &gt;0 they are decremented in seconds until zero is reached. see example below<br> <code>i:vname</code> <br> specifies auto increment counters if =0 (in seconds)<br> <code>g:vname</code> <br> specifies global variable which is linked to all global variables with the same defintion on all devices in the homenet. when a variable is updated in one device it is instantly updated in all other devices. if a section &gt;G exists it is executed when a variable is updated from another device (this is done via UDP-multicast, so not always reliable)<br> <code>m:vname</code> <br> specifies a median filter variable with 5 entries (for elimination of outliers)<br> <code>M:vname</code> <br> specifies a moving average filter variable with 8 entries (for smoothing data)<br> (max 5 filters in total m+M) optional another filter length (1..127) can be given after the definition.<br> Filter vars can be accessed also in indexed mode <code>vname[x]</code> (x = <code>1..N</code>, x = <code>0</code> returns current array index pointer, x = <code>-1</code> returns arry lenght)<br> Using this filter, vars can be used as arrays, #define LARGE_ARRAYS allows for arrays up to 1000 entries<br> array may also be permanent by specifying an extra :p<br> m:p:vname defines a permanent array. Keep in mind however that in 1M Flash standard configurations you only have 50 bytes permanent storage which stands for a maximum of 12 numbers. (see list above for permanent storage in other configurations) </p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Keep variable names as short as possible. The length of all variable names taken together may not exceed 256 characters.<br> Memory is dynamically allocated as a result of the D section.<br> Copying a string to a number or reverse is supported </p> </div> <p><code>&gt;B</code><br> executed on BOOT time before sensors are initialized and on save script </p> <p><code>&gt;BS</code><br> executed on BOOT time after sensors are initialized </p> <p><code>&gt;E</code><br> Executed when a Tasmota MQTT <code>RESULT</code> message is received, e.g., on <code>POWER</code> change. Also Zigbee reports to this section.</p> <p><code>&gt;F</code><br> Executed every 100 ms </p> <p><code>&gt;S</code><br> Executed every second </p> <p><code>&gt;R</code><br> Executed on restart. p vars are saved automatically after this call </p> <p><code>&gt;T</code><br> Executed on <a href=../Commands/#teleperiod><code>TelePeriod</code></a> time (<code>SENSOR</code> and <code>STATE</code>), only put <code>tele-</code> vars in this section<br> Remark: json variable names (like all others) may not contain math operators like - , you should set <a href=../Commands/#setoption64><code>SetOption64 1</code></a> to replace <code>-</code> (<em>dash</em>) with <code>_</code> (<em>underscore</em>). Zigbee sensors will not report to this section, use E instead.</p> <p><code>&gt;H</code><br> Alexa Hue interface (up to 32 virtual hue devices) <em>(<a href=#hue-emulation>example</a>)</em><br> <code>device</code>,<code>type</code>,<code>onVars</code><br> Remark: hue values have a range from 0-65535. Divide by 182 to assign HSBcolors hue values.</p> <p><code>device</code> device name<br> <code>type</code> device type - <code>E</code> = extended color; <code>S</code> = switch<br> <code>onVars</code> assign Hue "on" extended color parameters for hue, saturation, brightness, and color temperature (hue,sat,bri,ct) to scripter variables </p> <div class="admonition example"> <p class=admonition-title>Example</p> <p><code>lamp1,E,on=pwr1,hue=hue1,sat=sat1,bri=bri1,ct=ct1</code></p> </div> <p><code>&gt;U</code><br> JSON messages from cmd status arrive here</p> <p><code>&gt;G</code><br> global variable updated section</p> <p><code>&gt;P</code><br> any power change triggers here</p> <p><code>&gt;jp</code><br> https webpage json parse arrives here </p> <p><code>&gt;ti1</code><br> <code>&gt;ti2</code><br> <code>&gt;ti3</code><br> <code>&gt;ti4</code><br> ticker callback after timer expiration</p> <p><code>&gt;b</code> <em>(note lower case)</em><br> executed on button state change </p> <p><code>bt[x]</code> <br> read button state (x = <code>1.. MAX_KEYS</code>) </p> <div class="admonition example"> <p class=admonition-title>Example</p> </div> <div class=codehilite><pre><span></span><code><span class=err>&gt;D</span>
<span class=err>tmp=0</span>
<span class=err>&gt;b</span>
<span class=err>tmp=bt[1]</span>
<span class=err>if tmp==0  </span>
<span class=err>then  </span>
<span class=err>print falling edge of button1  </span>
<span class=err>endif  </span>
<span class=err>if tmp==1  </span>
<span class=err>then  </span>
<span class=err>print rising edge of button1  </span>
<span class=err>endif</span>
</code></pre></div> <p><code>&gt;J</code><br> The lines in this section are published via MQTT in a JSON payload on <a href=../Commands/#teleperiod>TelePeriod</a>. <mark>Requires compiling with <code>#define USE_SCRIPT_JSON_EXPORT</code>.</mark> </p> <p><code>&gt;W</code><br> The lines in this section are displayed in the web UI main page. <mark>Requires compiling with <code>#define USE_SCRIPT_WEB_DISPLAY</code>.</mark> </p> <p>You may put any html code here. </p> <ul> <li>Variables may be substituted using %var% </li> <li>HTML statements are displayed in the sensor section of the main page </li> <li>HTML statements preceded with a <code>@</code> are displayed at the top of the page </li> <li>USER IO elements are displayed at the top of the page<br> for next loops are supported to repeat HTML code (precede with % char) %for var from to inc %next script subroutines may be called sub=name of subroutine, like normal subroutines %=#sub in this subroutine a web line may be sent by wcs (see below) thus allowing dynamic HTML pages</li> </ul> <p>A web user interface may be generated containing any of the following elements:<br> <strong>Button:</strong> <br> <code>bu(vn txt1 txt2)</code> (up to 4 buttons may be defined in one row)<br> <code>vn</code> = name of variable to hold button state<br> <code>txt1</code> = text of ON state of button<br> <code>txt2</code> = text of OFF state of button<br> <strong>Checkbox:</strong> <br> <code>ck(vn txt)</code><br> <code>vn</code> = name of variable to hold checkbox state<br> <code>txt</code> = label text <br> <strong>Slider:</strong> <br> <code>sl(min max vn ltxt mtxt rtxt)</code><br> <code>min</code> = slider minimum value<br> <code>max</code> = slider maximum value<br> <code>vn</code> = name of variable to hold slider value<br> <code>ltxt</code> = label left of slider<br> <code>mtxt</code> = label middle of slider<br> <code>rtxt</code> = label right of slider<br> <strong>Text Input:</strong> <br> <code>tx(vn lbl)</code><br> <code>vn</code> = name of string variable to hold text state<br> <code>lbl</code> = label text </p> <p><strong>Number Input:</strong> <br> <code>nm(min max step vn txt)</code><br> <code>min</code> = number minimum value<br> <code>max</code> = number maximum value<br> <code>step</code> = number step value for up/down arrows<br> <code>vn</code> = name of number variable to hold number<br> <code>txt</code> = label text </p> <p><strong>Google Charts:</strong><br> draws a google chart with up to 4 data sets per chart<br> <code>gc( T array1 ... array4 "name" "label1" ... "label4" "entrylabels" "header" {"maxy1"} {"maxy2"})</code> <br> <code>T</code> = type<br> - b=barchart<br> - c=columnchart<br> - C=combochart<br> - p=piechart<br> - l=linechart up to 4 lines with same scaling<br> - l2=linechart with exactly 2 lines and 2 y scales (must be given at end)<br> - lf2 like above but with splined lines<br> - h=histogram<br> - t=data table<br> - g=simple gauges (must give extra 3 vars after header, yellow start, red start, maxval)<br> - T=Timeline (special type arrays contains start,stop pairs in minutes timeofday) </p> <p>b,l,h type may have the '2' option to specify exactly 2 arrays with 2 y scales given at the end of paramter list. </p> <p>a very individual chart may be specified by splitting the chart definition and inserting the chart options directly see example below </p> <p><code>array</code> = up to 4 arrays of data<br> <code>name</code> = name of chart<br> <code>label</code> = label for up to the 4 datasets in chart<br> <code>entrylabel</code> = labels of each x axis entry separated by '|' char<br> ("cntN" starts numbering entries with the number N an optional /X generates numbers devided by X)<br> ("wdh: before a week defintion generates a week with full hours)<br> <code>header</code> = visible header name of chart </p> <p>additionally you have to define the html frame to put the chart in (both lines must be preceded by a $ char) e.g.<br> <br> <pre><code>$&lt;div id="chart1"style="width:640px;height:480px;margin:0 auto">&lt;/div>
  $gc(c array1 array2 "wr" "pwr1" "pwr2" "mo|di|mi|do|fr|sa|so" "Solar feed")</pre></p> <p></code></p> <p>you may define more then one chart. The charts id is chart1 ... chartN</p> <p>very customized chart definition:<br> define a chart like above, but add a t to the definition<br> this generates a google table from the arrays e.g.:<br> &amp;gc(lt array1 array2 "wr" "pwr1" "pwr2" "mo|di|mi|do|fr|sa|so")</p> <p>then define the options for the graph as from the doku of google e.g.:<br> $var options = {<br> $vAxes:{0:{maxValue:40,title:'Außentemperatur'},1:{maxValue:60,title:'Solarspeicher'}},<br> $series:{0:{targetAxisIndex:0},1:{targetAxisIndex:1}},<br> $hAxis: {title: 'Wochenverlauf'},<br> $};<br> then gc(e) closes the definition <br> $gc(e) </p> <p><code>&gt;w</code> ButtonLabel generates a button with the name "ButtonLabel" in Tasmota main menu.<br> Clicking this button displays a web page with the HTML data of this section. all cmds like in &gt;W apply here. these lines are refreshed frequently to show e.g. sensor values. lines preceeded by $ are static and not refreshed and display below lines without $.<br> this option also enables a full webserver interface when USE_SCRIPT_FATFS is activ.<br> you may display files from the flash or SD filesystem by specifying the url: IP/sdc/path . (supported files: *.jpg, *.html, *.txt)<br> <mark>Requires compiling with <code>#define SCRIPT_FULL_WEBPAGE</code>.</mark> </p> <p><code>&gt;M</code><br> <a href=../Smart-Meter-Interface/ >Smart Meter Interface</a> </p> <p>If a variable does not exist, <code>???</code> is displayed for commands </p> <p>If a Tasmota <code>SENSOR</code> or <code>STATUS</code> or <code>RESULT</code> message is not generated or a <code>Var</code> does not exist the destination variable is <mark>NOT</mark> updated. </p> <h2 id=special-variables>Special Variables<a class=headerlink href=#special-variables title="Permanent link">~</a></h2> <p>(read only)<br> <code>upsecs</code> = seconds since start<br> <code>uptime</code> = minutes since start<br> <code>time</code> = minutes since midnight<br> <code>sunrise</code> = sunrise minutes since midnight<br> <code>sunset</code> = sunset minutes since midnight<br> <code>tper</code> = <a href=../Commands/#teleperiod>TelePeriod</a> (<em><strong>may be set also</strong></em>)<br> <code>tstamp</code> = timestamp (local date and time)<br> <code>topic</code> = mqtt topic<br> <code>gtopic</code> = mqtt group topic<br> <code>lip</code> = local ip as string<br> <code>luip</code> = udp ip as string (from updating device when USE_SCRIPT_GLOBVARS defined)<br> <code>prefixn</code> = prefix n = 1-3<br> <code>frnm</code> = friendly name<br> <code>pwr[x]</code> = power state (x = 1..N)<br> <code>pc[x]</code> = pulse counter value (x = 1..4)<br> <code>tbut[x]</code> = touch screen button state (x = 1..N)<br> <code>sw[x]</code> = switch state (x = 0..N) (Switch1 = <code>sw[0]</code>)<br> <code>bt[x]</code> = button state (x = 1..N) only valid in section b (if defined USE_BUTTON_EVENT)<br> <code>pin[x]</code> = GPIO pin level (x = 0..16)<br> <code>pn[x]</code> = GPIO for sensor code x. 99 if none<br> <code>pd[x]</code> = defined sensor for GPIO x. 999 if none<br> <code>pl[path]</code> = plays the mp3 path (ESP32 and if I2S Device defined)<br> <code>say[svar]</code> = text to speach (if I2S Device defined)<br> <code>adc(fac (pin))</code> = get adc value (on ESP32 can select pin) fac is number of averaged samples (power of 2: 0..7) <code>sht[x]</code> = shutter position (x = 1..N) (if defined USE_SHUTTER)<br> <code>gtmp</code> = global temperature<br> <code>ghum</code> = global humidity<br> <code>gprs</code> = global pressure<br> <code>pow(x y)</code> = calculates exponential powers x^y<br> <code>med(n x)</code> = calculates a 5 value median filter of x (2 filters possible n=0,1)<br> <code>int(x)</code> = gets the integer part of x (like floor)<br> <code>hn(x)</code> = converts x (0..255) to a hex nibble string<br> <code>hx(x)</code> = converts x (0..65535) to a hex string<br> <code>hd("hstr")</code> = converts hex number string to a decimal number<br> <code>st(svar c n)</code> = string token - retrieve the n<sup>th</sup> element of svar delimited by c<br> <code>sl(svar)</code> = gets the length of a string<br> <code>asc(svar)</code> = gets the binary value of 1. char of a string<br> <code>sb(svar p n)</code> = gets a substring from svar at position p (if p&lt;0 counts from end) and length n<br> <code>is(num "string1|string2|....|stringn|")</code> = defines a string array optionally preset with immediate strings separated by '|' (this immediate string may be up to 255 chars long) num = 0 read only string array, num &gt; 0 number of elements in read write string array<br> <code>is[index]</code> = gets string <code>index</code> from string array, if read-write also write string of index<br> <code>is1(..)</code>, <code>is2(...)</code> string array see above<br> <code>is1[x]</code>, <code>is2[x]</code> string array see above<br> <code>sin(x)</code> = calculates the sinus(x) (if defined USE_ANGLE_FUNC)<br> <code>acos(x)</code> = calculates the acos(x) (if defined USE_ANGLE_FUNC)<br> <code>sqrt(x)</code> = calculates the sqrt(x) (if defined USE_ANGLE_FUNC)<br> <code>abs(x)</code> = calculates the absolute value of x<br> <code>mpt(x)</code> = measure pulse time, x&gt;=0 defines pin to use, -1 returns low pulse time,-2 return high pulse time (if defined USE_ANGLE_FUNC)<br> <code>rnd(x)</code> = return a random number between 0 and x, (seed may be set by rnd(-x))<br> <code>sf(F)</code> = sets the CPU Frequency (ESP32) to 80,160,240 Mhz, returns current Freq.<br> <code>s(x)</code> = explicit conversion from number x to string<br> <code>mqtts</code> = MQTT connection status: <code>0</code> = disconnected, <code>&gt;0</code> = connected<br> <code>wbut</code> = button status of watch side button (if defined USE_TTGO_WATCH)<br> <code>wdclk</code> = double tapped on display (if defined USE_TTGO_WATCH)<br> <code>wtch(sel)</code> = gets state from touch panel sel=0 =&gt; touched, sel=1 =&gt; x position, sel=2 =&gt; y position (if defined USE_TTGO_WATCH)<br> <code>slp(time)</code> = sleep time in seconds, pos values =&gt; light sleep, neg values =&gt; deep sleep (if defined USE_TTGO_WATCH)<br> <code>play(path)</code> = play mp3 audio from filesystem (if defined USE_I2S_AUDIO or USE_TTGO_WATCH or USE_M5STACK_CORE2)<br> <code>say("text")</code> = plays specified text to speech (if defined USE_I2S_AUDIO or USE_TTGO_WATCH or USE_M5STACK_CORE2) <br> <code>c2ps(sel val)</code> = gets, sets values on ESP32 CORE2 sel=0 green led, sel=1 vibration motor, sel=2,3,4 get touch button state 1,2,3 (if defined USE_M5STACK_CORE2)<br> <code>rec(path seconds)</code> = rec n seconds wav audio file from i2s microphone to filesystem path (if defined USE_I2S_AUDIO or USE_M5STACK_CORE2)<br> <code>pwmN(-pin freq)</code> = defines a pwm channel N (1..N) with pin Nr and frequency (pin 0 beeing -64, N=5 with esp8266 and N=8 with esp32)<br> <code>pwmN(val)</code> = outputs a pwm signal on channel N (1..N) with val (0-1023)<br> <code>wifis</code> = Wi-Fi connection status: <code>0</code> = disconnected, <code>&gt;0</code> = connected </p> <p><code>wcs</code> = send this line to webpage (WebContentSend)<br> <code>wm</code> = contains source of web request code e.g. 0 = Sensor display (FUNC_WEB_SENSOR) </p> <p><code>sml(m 0 bd)</code> = set SML baudrate of Meter m to bd (baud) <br> <code>sml(m 1 htxt)</code> = send SML Hexstring htxt as binary to Meter m (if defined USE_SML_SCRIPT_CMD) <code>sml(m 2)</code> = reads serial data received by Meter m into string (if m&lt;0 reads hex values, else asci values)(if defined USE_SML_SCRIPT_CMD) <code>sml[n]</code> = get value of SML energy register n (if defined USE_SML_SCRIPT_CMD)<br> <code>enrg[n]</code> = get value of energy register n 0=total, 1..3 voltage of phase 1..3, 4..6 current of phase 1..3, 7..9 power of phase 1..3 (if defined USE_ENERGY_SENSOR)<br> <code>gjp("host" "path")</code> = trigger HTTPS JSON page read as used by Tesla Powerwall (if defined SCRIPT_GET_HTTPS_JP)<br> <code>tsN(ms)</code> = set up to 4 timers (N=1..4) to millisecond time on expiration triggers section &gt;tiN (if defined USE_SCRIPT_TIMER)<br> <code>hours</code> = hours<br> <code>mins</code> = mins<br> <code>secs</code> = seconds<br> <code>day</code> = day of month<br> <code>wday</code> = day of week (Sunday=1,Monday=2;Tuesday=3;Wednesday=4,Thursday=5,Friday=6,Saturday=7)<br> <code>month</code> = month <br> <code>year</code> = year<br> <code>epoch</code> = epoch time (from 2019-1-1 00:00)<br> <code>eres</code> = result of &gt;E section set this var to 1 in section &gt;E to tell Tasmota event is handled (prevents MQTT) </p> <p>The following variables are cleared after reading true:<br> <code>chg[var]</code> = true if a variables value was changed (numeric vars only)<br> <code>upd[var]</code> = true if a variable was updated<br> <code>boot</code> = true on BOOT<br> <code>tinit</code> = true on time init<br> <code>tset</code> = true on time set<br> <code>mqttc</code> = true on mqtt connect<br> <code>mqttd</code> = true on mqtt disconnect<br> <code>wific</code> = true on wifi connect<br> <code>wifid</code> = true on wifi disconnect </p> <p><strong>System variables</strong> (for debugging)<br> <code>stack</code> = stack size<br> <code>heap</code> = free heap size<br> <code>pheap</code> = PSRAM free heap size (ESP32)<br> <code>core</code> = current core (0 or 1) (ESP32)<br> <code>ram</code> = used ram size<br> <code>slen</code> = script length<br> <code>freq</code> = cpu frequency<br> <code>micros</code> = running microseconds<br> <code>millis</code> = running milliseconds<br> <code>loglvl</code> = loglevel of script cmds (<em><strong>may be set also</strong></em>) </p> <p>Remarks:<br> If you define a variable with the same name as a special variable that special variable is discarded </p> <h2 id=commands>Commands<a class=headerlink href=#commands title="Permanent link">~</a></h2> <p><code>=&gt; &lt;command&gt;</code> Execute <command> recursion disabled<br> <code>+&gt; &lt;command&gt;</code> Execute <command> recursion enabled<br> <code>-&gt; &lt;command&gt;</code> Execute <command> - do not send MQTT or log messages (i.e., silent execute - useful to reduce traffic) </p> <p><strong>Variable Substitution</strong><br> - A single percent sign must be given as <code>%%</code><br> - Variable replacement within commands is allowed using <code>%varname%</code>. Optionally, the decimal places precision for numeric values may be specified by placing a digit (<code>%Nvarname%</code>, N = <code>0..9</code>) in front of the substitution variable (e.g., <code>Humidity: %3hum%%%</code> will output <code>Humidity: 43.271%</code>)<br> - instead of variables arbitrary calculations my be inserted by bracketing %N(formula)%<br> - Linefeed and carriage return may be defined by \n and \r </p> <p><strong>Special</strong> commands:<br> <code>print</code> or <code>=&gt;print</code> prints to the log for debugging<br> A Tasmota MQTT RESULT message invokes the script's <code>E</code> section. Add <code>print</code> statements to debug a script. </p> <div class="admonition example"> <p class=admonition-title>Example</p> </div> <blockquote> <div class=codehilite><pre><span></span><code><span class=err>&gt;E</span>
<span class=err>slider=Dimmer</span>
<span class=err>power=POWER</span>
</code></pre></div> </blockquote> <div class=codehilite><pre><span></span><code><span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>slider</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>print</span><span class=w> </span><span class=n>slider</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=o>%</span><span class=n>slider</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>power</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>print</span><span class=w> </span><span class=nf>power</span><span class=w> </span><span class=n>updated</span><span class=w> </span><span class=o>%</span><span class=nf>power</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
</code></pre></div> <p><code>break</code> exits a section or terminates a <code>for next</code> loop<br> <code>dpx</code> sets decimal precision to x (0-9)<br> <code>svars</code> save permanent vars<br> <code>delay(x)</code> pauses x milliseconds (should be as short as possible)<br> <code>beep(f l)</code> (ESP32) beeps with a passive piezo beeper. beep(-f 0) attaches PIN f to the beeper, beep(f l) starts a sound with frequency f (Hz) and len l (ms). f=0 stops the sound.<br> <code>spin(x b)</code> set GPIO <code>x</code> (0..16) to value <code>b</code> (0,1). Only bit 0 of <code>b</code> is used - even values set the GPIO to <code>0</code> and uneven values set the GPIO to <code>1</code><br> <code>spinm(x m)</code> set GPIO <code>x</code> (0..16) to mode <code>m</code> (input=0, output=1, input with pullup=2,alternatively b may be: O=out, I=in, P=in with pullup)<br> <code>ws2812(array dstoffset)</code> copies an array (defined with <code>m:vname</code>) to the WS2812 LED chain. The array length should be defined as long as the number of pixels. Color is coded as 24 bit RGB. optionally the destinationoffset in the LED chain may be given<br> <code>hsvrgb(h s v)</code> converts hue (0..360), saturation (0..100) and value (0..100) to RGB color<br> <code>dt</code> display text command (if #define USE_DISPLAY) </p> <p><code>#name</code> names a subroutine. Subroutine is called with <code>=#name</code><br> <code>#name(param)</code> names a subroutine with a parameter. Subroutine is called with <code>=#name(param)</code><br> Subroutines end with the next <code>#</code> or <code>&gt;</code> line or break. Subroutines may be nested<br> Parameters can be numbers or strings and on type mismatch are converted </p> <p>If <code>#define USE_SCRIPT_SUB_COMMAND</code> is included in your <code>user_config_override.h</code>, a subroutine may be invoked via the Console or MQTT using the subroutine's name. For example, a declared subroutine <code>#SETLED(num)</code> may be invoked by typing <code>SETLED 1</code> in the Console. The parameter <code>1</code> is passed into the <code>num</code> argument. This also works with string parameters. since Tasmota capitalizes all commands you must use upper case labels. </p> <p>It is possible to "replace" internal Tasmota commands. For example, if a <code>#POWER1(num)</code> subroutine is declared, the command <code>POWER1</code> is processed in the scripter instead of in the main Tasmota code. </p> <p><code>=(svar)</code> executes a routine whose name is passed as a string in a variable (dynamic or self modifying code). The string has to start with <code>&gt;</code> or <code>=#</code> for the routine to be executed.</p> <div class=codehilite><pre><span></span><code><span class=n>D</span>
<span class=n>svar</span><span class=o>=</span><span class=s2>&quot;=#subroutine&quot;</span>

<span class=n>S</span>
<span class=o>=</span><span class=p>(</span><span class=n>svar</span><span class=p>)</span>

<span class=c1>#subroutine</span>
<span class=o>=&gt;</span><span class=nb>print</span> <span class=n>subroutine</span> <span class=n>was</span> <span class=n>executed</span>
</code></pre></div> <p><strong>For loop</strong> (loop count must not be less than 1, no direct nesting supported)</p> <div class=codehilite><pre><span></span><code><span class=k>for</span> <span class=k>var</span> <span class=o>&lt;</span><span class=n>from</span><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>to</span><span class=o>&gt;</span> <span class=o>&lt;</span><span class=n>inc</span><span class=o>&gt;</span>  
<span class=n>next</span>  
</code></pre></div> <p><strong>Switch selector</strong> (numeric or string)</p> <div class=codehilite><pre><span></span><code><span class=err>switch x  </span>
<span class=err>case a  </span>
<span class=err>case b  </span>
<span class=err>ends  </span>
</code></pre></div> <p><strong>Conditional Statements</strong><br> There are two syntax alternatives. You may <strong><em>NOT</em></strong> mix both formats. </p> <div class=codehilite><pre><span></span><code><span class=err>if a==b  </span>
<span class=err>and x==y  </span>
<span class=err>or k==i  </span>
<span class=err>then = do this  </span>
<span class=err>else = do that  </span>
<span class=err>endif  </span>
</code></pre></div> <p><strong>or</strong> </p> <div class=codehilite><pre><span></span><code><span class=err>if a==b  </span>
<span class=err>and x==y  </span>
<span class=err>or k==i {  </span>
<span class=err>  = do this  </span>
<span class=err>} else {  </span>
<span class=err>  = do that  </span>
<span class=err>}  </span>
</code></pre></div> <p>Remarks:<br> The last closing bracket must be on a separate line<br> Calculations are permitted in conditional expressions, e.g., </p> <div class=codehilite><pre><span></span><code><span class=k>if</span> <span class=n>var1</span><span class=o>-</span><span class=n>var2</span><span class=o>==</span><span class=n>var3</span><span class=o>*</span><span class=n>var4</span>
</code></pre></div> <p>Conditional expressions may be enclosed in parentheses. The statement must be on a single line. e.g., </p> <div class=codehilite><pre><span></span><code><span class=err>if ((a==b) and ((c==d) or (c==e)) and (s!=&quot;x&quot;))</span>
</code></pre></div> <p><strong><em>mapping function</em></strong> </p> <p>mp(x str1 str2 ... str<n>)<br> It addresses a standard task with less code and much flexibility: mapping an arbitrary incoming numeric value into the allowed range.<br> The numeric value x passed as the first parameter is compared to the rules in the order they are provided as subsequent sting parameters. If the value matches the criteria, the defined value is returned. Subsequent rules are skipped. If x matches none of the rules, x is returned unchanged. </p> <p>Rules consist of one of the comparison operators &lt; &gt; = followed by a numeric value v1, optionally followed by a colon and another numeric value v2. </p> <div class=codehilite><pre><span></span><code><span class=o>&lt;|&gt;|=</span><span class=n>v1</span><span class=o>[:</span><span class=n>v2</span><span class=o>]</span> 
<span class=n>Example</span> <span class=mi>1</span><span class=o>:</span> <span class=s>&quot;&lt;8:0&quot;</span> <span class=o>-</span> <span class=n>this</span> <span class=n>rule</span> <span class=n>reads</span><span class=o>:</span> <span class=n>If</span> <span class=n>x</span> <span class=n>is</span> <span class=n>less</span> <span class=n>than</span> <span class=mi>8</span><span class=o>,</span> <span class=k>return</span> <span class=mi>0</span><span class=o>.</span>
<span class=n>Example</span> <span class=mi>2</span><span class=o>:</span> <span class=s>&quot;&gt;100&quot;</span> <span class=o>-</span> <span class=n>this</span> <span class=n>rule</span> <span class=n>reads</span><span class=o>:</span> <span class=n>If</span> <span class=n>x</span> <span class=n>is</span> <span class=n>greater</span> <span class=n>than</span> <span class=mi>100</span><span class=o>,</span> <span class=k>return</span> <span class=mi>100</span><span class=o>.</span>

<span class=n>Example</span> <span class=mi>3</span><span class=o>:</span>

<span class=n>y</span><span class=o>=</span><span class=n>mp</span><span class=o>(</span><span class=n>x</span> <span class=s>&quot;&lt;8:0&quot;</span> <span class=s>&quot;&gt;100&quot;</span><span class=o>)</span>
<span class=n>Assigns</span> <span class=mi>0</span> <span class=k>to</span> <span class=n>y</span> <span class=k>if</span> <span class=n>x</span> <span class=n>is</span> <span class=n>less</span> <span class=n>than</span> <span class=mi>8</span><span class=o>.</span>
<span class=n>Assigns</span> <span class=mi>100</span> <span class=k>to</span> <span class=n>y</span> <span class=k>if</span> <span class=n>x</span> <span class=n>is</span> <span class=n>greater</span> <span class=n>than</span> <span class=mi>100</span><span class=o>.</span>
<span class=n>Assigns</span> <span class=n>x</span> <span class=k>to</span> <span class=n>y</span> <span class=k>for</span> <span class=n>all</span> <span class=n>values</span> <span class=k>of</span> <span class=n>x</span> <span class=n>that</span> <span class=k>do</span> <span class=ow>not</span> <span class=n>meet</span> <span class=n>the</span> <span class=n>above</span> <span class=n>criteria</span> <span class=o>(</span><span class=mi>8</span> <span class=k>to</span> <span class=mi>100</span><span class=o>).</span>

<span class=n>The</span> <span class=n>above</span> <span class=n>code</span> <span class=k>of</span> <span class=n>example</span> <span class=mi>3</span> <span class=n>does</span> <span class=n>the</span> <span class=n>same</span> <span class=k>as</span> <span class=n>the</span> <span class=n>following</span> <span class=n>code</span> <span class=o>-</span> <span class=k>with</span> <span class=n>just</span> <span class=n>one</span> <span class=n>line</span> <span class=k>of</span> <span class=n>code</span> <span class=ow>and</span> <span class=mi>15</span> <span class=n>characters</span> <span class=n>less</span><span class=o>:</span>

<span class=n>y</span><span class=o>=</span><span class=n>x</span>
<span class=k>if</span> <span class=n>x</span><span class=o>&lt;</span><span class=mi>8</span> <span class=o>{</span>
<span class=n>y</span><span class=o>=</span><span class=mi>0</span>
<span class=o>}</span>
<span class=k>if</span> <span class=n>x</span><span class=o>&gt;</span><span class=mi>100</span> <span class=o>{</span>
<span class=n>y</span><span class=o>=</span><span class=mi>100</span>
<span class=o>}</span>
</code></pre></div> <p><strong>E-mail</strong><br> <code>#define USE_SENDMAIL</code><br> Enabling this feature also enables <a href=../TLS/ >Tasmota TLS</a> as <code>sendmail</code> uses SSL. </p> <p><code>sendmail [server:port:user:passwd:from:to:subject] msg</code> </p> <div class="admonition example"> <p class=admonition-title>Example</p> <p><code>sendmail [smtp.gmail.com:465:user:passwd:sender@gmail.com:&lt;rec@gmail.com:alarm] %string%</code> </p> <p>Remark:<br> A number of e-mail servers (such as Gmail) require the receiver's e-mail address to be enclosed by <code>&lt; ...</code> as in example above. Most other e-mail servers also accept this format. While ESP8266 sendmail needs brackets, ESP32 sendmail inserts brackets itself so you should not specify brackets here. </p> </div> <p>The following parameters can be specified during compilation via <code>#define</code> directives in <code>user_config_override.h</code>:<br> * <code>EMAIL_SERVER</code><br> * <code>EMAIL_PORT</code><br> * <code>EMAIL_USER</code><br> * <code>EMAIL_PASSWORD</code><br> * <code>EMAIL_FROM</code> </p> <p>To use any of these values, pass an <code>*</code> as its corresponding argument placeholder. </p> <div class="admonition example"> <p class=admonition-title><code>sendmail [*:*:*:*:*:&lt;rec@gmail.com:theSubject] theMessage</code> </p> </div> <p>Instead of passing the <code>msg</code> as a string constant, the body of the e-mail message may also be composed using the script <code>m</code> <em>(note lower case)</em> section. The specified text in this script section must end with an <code>#</code> character. <code>sendmail</code> will use the <code>m</code> section if <code>*</code> is passed as the <code>msg</code> parameter. in this &gt;m section you may also specify email attachments. @/filename specifies a file to be attached (if file system is present)<br> &amp;arrayname specifies an array attachment (as tab delimeted text, no file system needed) </p> <p>See [Scripting Cookbook Example].(#send-e-mail) </p> <p><strong>Subscribe, Unsubscribe</strong><br> <code>#define SUPPORT_MQTT_EVENT</code><br> <code>subscribe</code> and <code>unsubscribe</code> commands are supported. In contrast to rules, no event is generated but the event name specifies a variable defined in <code>D</code> section and this variable is automatically set on transmission of the subscribed item<br> within a script the subscribe cmd must be send with +&gt; instead of =&gt;<br> the MQTT decoder may be configured for more space in user config overwrite by<br> <code>#define MQTT_EVENT_MSIZE</code> xxx (default is 256)<br> <code>#define MQTT_EVENT_JSIZE</code> xxx (default is 400) </p> <p><strong>SD Card Support</strong> (+ 10k flash)<br> <code>#define USE_SCRIPT_FATFS</code> <code>CARD_CS</code><br> <code>CARD_CS</code> = GPIO of card chip select <br> SD card uses standard hardware SPI GPIO: mosi,miso,sclk<br> with 4M flash on ESP8266 and special linker file you may specify -1 for CS and get a flash file system with the same functionality but but very low capacity (e.g. 2 MB)<br> A maximum of four files may be open at a time<br> e.g., allows for logging sensors to a tab delimited file and then downloading the file (<a href=#sensor-logging>see Sensor Logging example</a>)<br> The downloading of files may be executed in a kind of "multitasking" when bit 7 of loglvl is set (128+loglevel)<br> Without multitasking 150kb/s (all processes are stopped during downloading), with multitasking 50kb/s (other Tasmota processes are running)<br> The script itself is also stored on the SD card with a default size of 4096 characters </p> <p><strong>SD card directory support</strong> (+ 1,2k flash)<br> <code>#define SDCARD_DIR</code><br> Shows a web SD card directory (submenu of scripter) where you can upload and download files to/from sd card </p> <p><code>fr=fo("fname" m)</code> open file fname, mode 0=read, 1=write, 2=append (returns file reference (0-3) or -1 for error) (alternatively m may be: r=read, w=write, a=append)<br> <code>res=fw("text" fr)</code> writes text to (the end of) file fr, returns number of bytes written<br> <code>res=fr(svar fr)</code> reads a string into svar, returns bytes read. String is read until delimiter (\t \n \r) or eof<br> <code>fc(fr)</code> close file<br> <code>ff(fr)</code> flush file, writes cached data and updates directory<br> <code>fd("fname")</code> delete file fname<br> <code>flx(fname)</code> create download link for file (x=1 or 2) fname = file name of file to download<br> <code>fsm</code> return 1 if filesystem is mounted, (valid SD card found)<br> <code>res=fsi(sel)</code> gets file system information, sel=0 returns total media size, sel=1 returns free space both in kB <br> <code>fra(array fr)</code> reads array from open file with fr (assumes tab delimeted entries)<br> <code>fwa(array fr)</code> writes array to open file with fr (writes tab delimited entries) </p> <p><strong>Extended commands</strong> (+0,9k flash)<br> <code>#define USE_SCRIPT_FATFS_EXT</code><br> <code>fmd("fname")</code> make directory fname<br> <code>frd("fname")</code> remove directory fname<br> <code>fx("fname")</code> check if file fname exists<br> <code>fe("fname")</code> execute script fname (max 2048 bytes, script must start with the '&gt;' character on the first line) </p> <p><strong>ESP32 real Multitasking support</strong><br> <code>#define USE_SCRIPT_TASK</code> enables support for multitasking scripts<br> res=ct(num timer core)<br> creates a task num (1 or 2)<br> which is executed every timer (ms) time<br> on core 0 or 1 </p> <p>the sections are named<br> >t1 for task 1<br> >t2 for task 2 </p> <div class="admonition example"> <p class=admonition-title>Example</p> </div> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span>
<span class=o>&gt;</span><span class=n>B</span>
<span class=p>;</span> <span class=k>create</span> <span class=n>task</span> <span class=mi>1</span> <span class=k>every</span> <span class=mi>1000</span> <span class=n>ms</span> <span class=k>on</span> <span class=n>core</span> <span class=mi>0</span>
<span class=n>ct</span><span class=p>(</span><span class=mi>1</span> <span class=mi>1000</span> <span class=mi>0</span><span class=p>)</span>
<span class=p>;</span> <span class=k>create</span> <span class=n>task</span> <span class=mi>2</span> <span class=k>every</span> <span class=mi>3000</span> <span class=n>ms</span> <span class=k>on</span> <span class=n>core</span> <span class=mi>1</span>
<span class=n>ct</span><span class=p>(</span><span class=mi>2</span> <span class=mi>3000</span> <span class=mi>1</span><span class=p>)</span>

<span class=o>&gt;</span><span class=n>t1</span>
<span class=n>print</span> <span class=n>task1</span> <span class=k>on</span> <span class=n>core</span> <span class=o>%</span><span class=n>core</span><span class=o>%</span>

<span class=o>&gt;</span><span class=n>t2</span>
<span class=n>print</span> <span class=n>task2</span> <span class=k>on</span> <span class=n>core</span> <span class=o>%</span><span class=n>core</span><span class=o>%</span>
</code></pre></div> <p><strong>Script compression</strong><br> <code>#define USE_SCRIPT_COMPRESSION</code><br> enables compression of script storage to about 40%. The script buffer is set to 2560 instead of 1535 chars.<br> no backward compatibility. first save your old script before updating. </p> <p><strong>ESP32 Webcam support</strong> <br> <code>#define USE_WEBCAM</code><br> Template for AI THINKER CAM :<br> {"NAME":"AITHINKER CAM No SPI","GPIO":[4992,65504,65504,65504,65504,5088,65504,65504,65504,65504,65504,65504,65504,65504,5089,5090,0,5091,5184,5152,0,5120,5024,5056,0,0,0,0,4928,65504,5094,5095,5092,0,0,5093],"FLAG":0,"BASE":1}</p> <p>remarks:<br> - GPIO0 zero must be disconnected from any wire after programming because this pin drives the cam clock and does not tolerate any capictive load<br> - Only boards with PSRAM should be used. To enable PSRAM board should be se set to esp32cam in common32 of platform_override.ini<br> board = esp32cam<br> - To speed up cam processing cpu frequency should be better set to 240Mhz in common32 of platform_override.ini<br> board_build.f_cpu = 240000000L </p> <p>file system extension:<br> <code>fwp(pnum fr)</code> write picture from RAM buffer number pnum to sdcard file with file reference fr<br> specific webcam commands:<br> <code>res=wc(sel p1 p2)</code> controll webcam, sel = function selector p1 ... optional parameters<br> <code>res=wc(0 pres)</code> init webcam with picture resolution pres, returns 0 when error, 2 when PSRAM found, else 1<br> pres<br> * <code>0 = FRAMESIZE_QQVGA, // 160x120</code><br> * <code>1 = FRAMESIZE_QQVGA2, // 128x160</code><br> * <code>2 = FRAMESIZE_QCIF, // 176x144</code><br> * <code>3 = FRAMESIZE_HQVGA, // 240x176</code><br> * <code>4 = FRAMESIZE_QVGA, // 320x240</code><br> * <code>5 = FRAMESIZE_CIF, // 400x296</code><br> * <code>6 = FRAMESIZE_VGA, // 640x480</code><br> * <code>7 = FRAMESIZE_SVGA, // 800x600</code><br> * <code>8 = FRAMESIZE_XGA, // 1024x768</code><br> * <code>9 = FRAMESIZE_SXGA, // 1280x1024</code><br> * <code>10 = FRAMESIZE_UXGA, // 1600x1200</code> </p> <p><code>res=wc(1 bnum)</code> capture picture to rambuffer bnum (1..4), returns framesize of picture or 0 when error<br> <code>res=wc(2 sel p1)</code> execute various controls, details below.<br> <code>res=wc(3)</code> gets picture width<br> <code>res=wc(4)</code> gets picture height<br> <code>res=wc(5 p)</code> start stop streaming 0=stop, 1=start<br> <code>res=wc(6 p)</code> start stop motion detector, p=0 =&gt; stop detector, p=T start detector with picture every T ms, -1 get picture difference, -2 get picture brightness<br> <code>res=wc(7 p)</code> start stop face detector, p=0 =&gt; stop detector, p=T start detector with picture every T ms, -1 get number of faces found in picture (USE_FACE_DETECT must be defined) </p> <p>control cmds sel =<br> * 0 fs = set frame size (see above for constants) <br> * 1 se = set special effect </p> <ul> <li><code>0 = no effect</code> </li> <li><code>1 = negative</code> </li> <li><code>2 = black and white</code> </li> <li><code>3 = reddish</code> </li> <li><code>4 = greenish</code> </li> <li><code>5 = blue</code> </li> <li> <p><code>6 = retro</code> </p> </li> <li> <p>2 fl = set horizontal flip 0,1 </p> </li> <li>3 mi = set vertical mirror 0,1 </li> </ul> <p>to read a value without setting pass -1</p> <ul> <li> <p>extensions to the email system on ESP32<br> <code>#define SEND_EMAIL</code> and <code>#define USE_ESP32MAIL</code><br> enables specific ESP32 mail server<br> this server can handle more mail servers by supporting START_TLS<br> remark: mail adresses must not be enclosed with &lt;&gt; because the server inserts them automatically<br> this server also supports email attachments<br> in the &gt;m section you may write<br> &amp;/file.txt to attach a file from SD card<br> $N N=1..4 to attach a picture from picture RAM buffer number N </p> </li> <li> <p>displaying webcam pictures in WEBUI<br> you may display a webcam picture by giving the name /wc.jpg?p=N (1..4) for RAM picturebuffer N<br> "&lt;img src="/wc.jpg?p=1" alt="webcam image" &gt;"<br> you may also provide the picture size (h and v have to be preset before)<br> "&lt;img src="/wc.jpg?p=1" alt="webcam image" style="width:%w%px;height:%h%px;"&gt;"<br> if you precede the line by &amp; char the image is diplayed in the main section, else in the sensor tab section </p> </li> </ul> <p>the webcam stream can be specified by the following line<br> lip is a system variable containing the local device ip <br> "&amp;&lt;br&gt;"<br> "&amp;&lt;img src="http://%lip%:81/stream" style="width:%w%px;height:%h%px"&gt;"<br> "&amp;&lt;br&gt;&lt;center&gt;webcam stream" </p> <p>remark: the Flash illumination LED is connected to GPIO4</p> <div class="admonition example"> <p class=admonition-title>Example</p> </div> <div class=codehilite><pre><span></span><code>    <span class=o>&gt;</span><span class=nt>D</span>
    <span class=nt>res</span><span class=o>=</span><span class=nt>0</span>
    <span class=nt>w</span><span class=o>=</span><span class=nt>0</span>
    <span class=nt>h</span><span class=o>=</span><span class=nt>0</span>
    <span class=nt>mot</span><span class=o>=</span><span class=nt>0</span>
    <span class=nt>bri</span><span class=o>=</span><span class=nt>0</span>

    <span class=o>&gt;</span><span class=nt>B</span>
    <span class=o>;</span> <span class=nt>init</span> <span class=nt>cam</span> <span class=nt>with</span> <span class=nt>QVGA</span>
    <span class=nt>res</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>0</span> <span class=nt>4</span><span class=o>)</span>
    <span class=o>;</span> <span class=nt>get</span> <span class=nt>pixel</span> <span class=nt>size</span>
    <span class=nt>w</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>3</span><span class=o>)</span>
    <span class=nt>h</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>4</span><span class=o>)</span>
    <span class=o>;</span> <span class=nt>start</span> <span class=nt>motion</span> <span class=nt>detector</span><span class=o>,</span> <span class=nt>picture</span> <span class=nt>every</span> <span class=nt>1000</span> <span class=nt>ms</span>
    <span class=nt>mot</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>6</span> <span class=nt>1000</span><span class=o>)</span>

    <span class=o>&gt;</span><span class=nt>S</span>
    <span class=nt>if</span> <span class=nt>wific</span><span class=o>&gt;</span><span class=nt>0</span>
    <span class=nt>then</span>
    <span class=o>;</span> <span class=nt>when</span> <span class=nt>wifi</span> <span class=nt>up</span><span class=o>,</span> <span class=nt>start</span> <span class=nt>stream</span>
    <span class=nt>res</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>5</span> <span class=nt>1</span><span class=o>)</span>
    <span class=nt>endif</span>

    <span class=o>;</span> <span class=nt>get</span> <span class=nt>motion</span> <span class=nt>detect</span> <span class=nt>diff</span> <span class=nt>value</span>
    <span class=nt>mot</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>6</span> <span class=nt>-1</span><span class=o>)</span>
    <span class=o>;</span> <span class=nt>get</span> <span class=nt>picture</span> <span class=nt>brightnes</span>
    <span class=nt>bri</span><span class=o>=</span><span class=nt>wc</span><span class=o>(</span><span class=nt>6</span> <span class=nt>-2</span><span class=o>)</span>

    <span class=o>&gt;</span><span class=nt>W</span>
    <span class=o>&lt;</span><span class=nt>center</span><span class=o>&gt;</span><span class=nt>motion</span> <span class=nt>diff</span> <span class=o>=</span> <span class=o>%</span><span class=nt>mot</span><span class=o>%&lt;</span><span class=nt>br</span><span class=o>&gt;</span>
    <span class=o>&lt;</span><span class=nt>center</span><span class=o>&gt;</span><span class=nt>brightness</span> <span class=o>=</span> <span class=o>%</span><span class=nt>bri</span><span class=o>%&lt;</span><span class=nt>br</span><span class=o>&gt;</span>
    <span class=o>;</span> <span class=nt>show</span> <span class=nt>stream</span> <span class=nt>on</span> <span class=nt>WEBUI</span>
    <span class=o>&amp;&lt;</span><span class=nt>br</span><span class=o>&gt;</span>
    <span class=o>&amp;&lt;</span><span class=nt>img</span> <span class=nt>src</span><span class=o>=</span><span class=s2>&quot;http://%lip%:81/stream&quot;</span> <span class=nt>style</span><span class=o>=</span><span class=s2>&quot;width:%w%px;height:%h%px&quot;</span><span class=o>&gt;</span>
    <span class=o>&amp;&lt;</span><span class=nt>br</span><span class=o>&gt;&lt;</span><span class=nt>center</span><span class=o>&gt;</span><span class=nt>webcam</span> <span class=nt>stream</span>
</code></pre></div> <h2 id=scripting-cookbook>Scripting Cookbook<a class=headerlink href=#scripting-cookbook title="Permanent link">~</a></h2> <h3 id=scripting-language-example>Scripting Language Example<a class=headerlink href=#scripting-language-example title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=n>a</span><span class=w> </span><span class=n>valid</span><span class=w> </span><span class=n>script</span><span class=w> </span><span class=n>must</span><span class=w> </span><span class=k>start</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=o>&gt;</span><span class=n>D</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=k>first</span><span class=w> </span><span class=n>line</span><span class=err>!</span><span class=w>  </span>
<span class=ow>some</span><span class=w> </span><span class=n>samples</span><span class=w> </span><span class=n>still</span><span class=w> </span><span class=n>contain</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=n>lines</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=o>&gt;</span><span class=n>D</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>no</span><span class=w> </span><span class=n>longer</span><span class=w> </span><span class=n>valid</span><span class=err>!</span><span class=w></span>

<span class=o>**</span><span class=n>Actually</span><span class=w> </span><span class=n>this</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>too</span><span class=w> </span><span class=k>large</span><span class=o>**</span><span class=p>.</span><span class=w> </span><span class=n>This</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>only</span><span class=w> </span><span class=n>meant</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>show</span><span class=w> </span><span class=ow>some</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>possibilities</span><span class=w></span>

<span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>define</span><span class=w> </span><span class=ow>all</span><span class=w> </span><span class=n>vars</span><span class=w> </span><span class=n>here</span><span class=w></span>
<span class=nl>p</span><span class=p>:</span><span class=n>mintmp</span><span class=o>=</span><span class=mi>10</span><span class=w>  </span><span class=p>(</span><span class=nl>p</span><span class=p>:</span><span class=n>means</span><span class=w> </span><span class=n>permanent</span><span class=p>)</span><span class=w></span>
<span class=nl>p</span><span class=p>:</span><span class=n>maxtmp</span><span class=o>=</span><span class=mi>30</span><span class=w></span>
<span class=nl>t</span><span class=p>:</span><span class=n>timer1</span><span class=o>=</span><span class=mi>30</span><span class=w>  </span><span class=p>(</span><span class=nl>t</span><span class=p>:</span><span class=n>means</span><span class=w> </span><span class=n>countdown</span><span class=w> </span><span class=n>timer</span><span class=p>)</span><span class=w></span>
<span class=nl>t</span><span class=p>:</span><span class=n>mt</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=nl>i</span><span class=p>:</span><span class=nf>count</span><span class=o>=</span><span class=mi>0</span><span class=w>  </span><span class=p>(</span><span class=nl>i</span><span class=p>:</span><span class=n>means</span><span class=w> </span><span class=n>auto</span><span class=w> </span><span class=n>counter</span><span class=p>)</span><span class=w></span>
<span class=n>hello</span><span class=o>=</span><span class=ss>&quot;hello world&quot;</span><span class=w></span>
<span class=n>string</span><span class=o>=</span><span class=ss>&quot;xxx&quot;</span><span class=w></span>
<span class=n>url</span><span class=o>=</span><span class=ss>&quot;[_IP_]&quot;</span><span class=p>;</span><span class=w></span>
<span class=n>hum</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>temp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>zigbeetemp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>timer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>dimmer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>sw</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>rssi</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>param</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=n>col</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>ocol</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>chan1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>chan2</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>chan3</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=n>ahum</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>atemp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tcnt</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>hour</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>state</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=nl>m</span><span class=p>:</span><span class=n>med5</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=nl>M</span><span class=p>:</span><span class=n>movav</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>define</span><span class=w> </span><span class=k>array</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=n>entries</span><span class=w></span>
<span class=nl>m</span><span class=p>:</span><span class=k>array</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=mi>10</span><span class=w></span>

<span class=o>&gt;</span><span class=n>B</span><span class=w></span>
<span class=n>string</span><span class=o>=</span><span class=n>hello</span><span class=o>+</span><span class=ss>&quot;how are you?&quot;</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>BOOT</span><span class=w> </span><span class=n>executed</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=o>%</span><span class=n>hello</span><span class=o>%</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>mp3track</span><span class=w> </span><span class=mi>1</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=n>pin</span><span class=w> </span><span class=n>definitions</span><span class=w></span>
<span class=k>for</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>16</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=n>pd</span><span class=o>[</span><span class=n>cnt</span><span class=o>]</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=o>%</span><span class=n>cnt</span><span class=o>%</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>%</span><span class=n>tmp</span><span class=o>%</span><span class=w></span>
<span class=k>next</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=n>pin</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>relais</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=n>pn</span><span class=o>[</span><span class=n>21</span><span class=o>]</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>relais</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>pin</span><span class=w> </span><span class=o>%</span><span class=n>tmp</span><span class=o>%</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>pulse</span><span class=w> </span><span class=n>relais</span><span class=w> </span><span class=k>over</span><span class=w> </span><span class=n>raw</span><span class=w> </span><span class=n>gpio</span><span class=w></span>
<span class=n>spin</span><span class=p>(</span><span class=n>tmp</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w></span>
<span class=n>delay</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w></span>
<span class=n>spin</span><span class=p>(</span><span class=n>tmp</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>raw</span><span class=w> </span><span class=n>pin</span><span class=w> </span><span class=k>level</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=k>level</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>gpio1</span><span class=w> </span><span class=o>%</span><span class=n>pin</span><span class=o>[</span><span class=n>1</span><span class=o>]%</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>pulse</span><span class=w> </span><span class=k>over</span><span class=w> </span><span class=n>tasmota</span><span class=w> </span><span class=n>cmd</span><span class=w></span>
<span class=o>=&gt;</span><span class=nf>power</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=n>delay</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=w></span>
<span class=o>=</span><span class=nf>power</span><span class=w> </span><span class=mi>0</span><span class=w></span>

<span class=o>&gt;</span><span class=n>T</span><span class=w></span>
<span class=n>hum</span><span class=o>=</span><span class=n>BME280#Humidity</span><span class=w></span>
<span class=n>temp</span><span class=o>=</span><span class=n>BME280#Temperature</span><span class=w></span>
<span class=n>rssi</span><span class=o>=</span><span class=n>Wifi#RSSI</span><span class=w></span>
<span class=n>string</span><span class=o>=</span><span class=n>SleepMode</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>median</span><span class=w> </span><span class=k>filter</span><span class=w></span>
<span class=n>median</span><span class=o>=</span><span class=n>temp</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>moving</span><span class=w> </span><span class=n>average</span><span class=w> </span><span class=k>filter</span><span class=w></span>
<span class=n>movav</span><span class=o>=</span><span class=n>hum</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>show</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=n>results</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=o>%</span><span class=n>median</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>movav</span><span class=o>%</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>rssi</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>rssi</span><span class=w> </span><span class=n>changed</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=o>%</span><span class=n>rssi</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>temp</span><span class=o>&gt;</span><span class=mi>30</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=n>hum</span><span class=o>&gt;</span><span class=mi>70</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>damn</span><span class=w> </span><span class=n>hot</span><span class=err>!</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>=</span><span class=n>#siren</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>loop</span><span class=w> </span><span class=n>nesting</span><span class=w> </span><span class=n>workaround</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>using</span><span class=w> </span><span class=n>subroutine</span><span class=w></span>
<span class=n>#siren</span><span class=p>(</span><span class=n>num</span><span class=p>)</span><span class=w></span>
<span class=k>for</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=o>=</span><span class=n>#stone</span><span class=w></span>
<span class=k>next</span><span class=w></span>

<span class=n>#stone</span><span class=w></span>
<span class=k>for</span><span class=w> </span><span class=n>tone</span><span class=w> </span><span class=mi>2000</span><span class=w> </span><span class=mi>1000</span><span class=w> </span><span class=o>-</span><span class=mi>20</span><span class=w></span>
<span class=n>beep</span><span class=p>(</span><span class=n>tone</span><span class=w> </span><span class=mi>10</span><span class=p>);</span><span class=w></span>
<span class=n>delay</span><span class=p>(</span><span class=mi>12</span><span class=p>)</span><span class=w></span>
<span class=k>next</span><span class=w></span>

<span class=o>&gt;</span><span class=n>S</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>every</span><span class=w> </span><span class=k>second</span><span class=w> </span><span class=n>but</span><span class=w> </span><span class=ow>not</span><span class=w> </span><span class=n>completely</span><span class=w> </span><span class=n>reliable</span><span class=w> </span><span class=nc>time</span><span class=w> </span><span class=n>here</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>upsecs</span><span class=w> </span><span class=ow>and</span><span class=w> </span><span class=n>uptime</span><span class=w> </span><span class=ow>or</span><span class=w> </span><span class=n>best</span><span class=w> </span><span class=nl>t</span><span class=p>:</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>reliable</span><span class=w> </span><span class=n>timers</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>arrays</span><span class=w></span>
<span class=k>array</span><span class=o>[</span><span class=n>1</span><span class=o>]=</span><span class=mi>4</span><span class=w></span>
<span class=k>array</span><span class=o>[</span><span class=n>2</span><span class=o>]=</span><span class=mi>5</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=k>array</span><span class=o>[</span><span class=n>1</span><span class=o>]+</span><span class=k>array</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>call</span><span class=w> </span><span class=n>subrountines</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=k>parameters</span><span class=w></span>
<span class=o>=</span><span class=n>#sub1</span><span class=p>(</span><span class=ss>&quot;hallo&quot;</span><span class=p>)</span><span class=w></span>
<span class=o>=</span><span class=n>#sub2</span><span class=p>(</span><span class=mi>999</span><span class=p>)</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>stop</span><span class=w> </span><span class=n>timer</span><span class=w> </span><span class=k>after</span><span class=w> </span><span class=n>expired</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>timer1</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>timer1</span><span class=o>=-</span><span class=mi>1</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>timer1</span><span class=w> </span><span class=n>expired</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>auto</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>restart</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=nf>count</span><span class=o>=</span><span class=mi>10</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=n>seconds</span><span class=w> </span><span class=k>over</span><span class=w></span>
<span class=nf>count</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>upsecs</span><span class=o>%</span><span class=mi>5</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=o>%</span><span class=n>upsecs</span><span class=o>%</span><span class=w>  </span><span class=p>(</span><span class=k>every</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>seconds</span><span class=p>)</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=ow>not</span><span class=w> </span><span class=n>recommended</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>reliable</span><span class=w> </span><span class=n>timers</span><span class=w></span>
<span class=n>timer</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>timer</span><span class=o>&gt;=</span><span class=mi>5</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>seconds</span><span class=w> </span><span class=k>over</span><span class=w> </span><span class=p>(</span><span class=n>may</span><span class=w> </span><span class=n>be</span><span class=p>)</span><span class=w></span>
<span class=n>timer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=n>dimmer</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>dimmer</span><span class=o>&gt;</span><span class=mi>100</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>dimmer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>=&gt;</span><span class=n>dimmer</span><span class=w> </span><span class=o>%</span><span class=n>dimmer</span><span class=o>%</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>WebSend</span><span class=w> </span><span class=o>%</span><span class=n>url</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>%</span><span class=n>dimmer</span><span class=o>%</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>show</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>display</span><span class=w></span>
<span class=n>dp0</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>c1l1f1s2p20</span><span class=o>]</span><span class=w> </span><span class=n>dimmer</span><span class=o>=%</span><span class=n>dimmer</span><span class=o>%</span><span class=w></span>

<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=o>%</span><span class=n>upsecs</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>uptime</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=nc>time</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>sunrise</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>sunset</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>tstamp</span><span class=o>%</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=nc>time</span><span class=o>&gt;</span><span class=n>sunset</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=nc>time</span><span class=o>&lt;</span><span class=n>sunrise</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>night</span><span class=w> </span><span class=nc>time</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>pwr</span><span class=o>[</span><span class=n>1</span><span class=o>]==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=n>power1</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=nf>day</span><span class=w> </span><span class=nc>time</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>pwr</span><span class=o>[</span><span class=n>1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=n>power1</span><span class=w> </span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>clr</span><span class=w> </span><span class=n>display</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>boot</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>boot</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>z</span><span class=o>]</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>frost</span><span class=w> </span><span class=n>warning</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>temp</span><span class=o>&lt;</span><span class=mi>0</span><span class=w> </span><span class=ow>or</span><span class=w> </span><span class=n>zigbeetemp</span><span class=o>&lt;</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=ow>and</span><span class=w> </span><span class=n>mt</span><span class=o>&lt;=</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=</span><span class=n>#sendmail</span><span class=p>(</span><span class=ss>&quot;frost alert&quot;</span><span class=p>)</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>alarm</span><span class=w> </span><span class=k>only</span><span class=w> </span><span class=k>every</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>minutes</span><span class=w></span>
<span class=n>mt</span><span class=o>=</span><span class=mi>300</span><span class=w></span>
<span class=o>=</span><span class=n>mp3track</span><span class=w> </span><span class=mi>2</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=nf>var</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>been</span><span class=w> </span><span class=n>updated</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>hello</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=o>%</span><span class=n>hello</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>send</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>Thingspeak</span><span class=w> </span><span class=k>every</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=n>seconds</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>average</span><span class=w> </span><span class=k>data</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=ow>between</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upsecs</span><span class=o>%</span><span class=mi>60</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>ahum</span><span class=o>&gt;=</span><span class=n>tcnt</span><span class=w></span>
<span class=n>atemp</span><span class=o>&gt;=</span><span class=n>tcnt</span><span class=w></span>
<span class=o>=</span><span class=n>WebSend</span><span class=w> </span><span class=o>[</span><span class=n>_IP_</span><span class=o>]/</span><span class=k>update</span><span class=vm>?</span><span class=k>key</span><span class=o>=</span><span class=n>_token_</span><span class=o>&amp;</span><span class=n>field1</span><span class=o>=%</span><span class=n>atemp</span><span class=o>%&amp;</span><span class=n>field2</span><span class=o>=%</span><span class=n>ahum</span><span class=o>%</span><span class=w></span>
<span class=n>tcnt</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>atemp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>ahum</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=n>ahum</span><span class=o>+=</span><span class=n>hum</span><span class=w></span>
<span class=n>atemp</span><span class=o>+=</span><span class=n>temp</span><span class=w></span>
<span class=n>tcnt</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>hour</span><span class=o>=</span><span class=nc>int</span><span class=p>(</span><span class=nc>time</span><span class=o>/</span><span class=mi>60</span><span class=p>)</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>hour</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>exactly</span><span class=w> </span><span class=k>every</span><span class=w> </span><span class=k>hour</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=k>full</span><span class=w> </span><span class=k>hour</span><span class=w> </span><span class=n>reached</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>time5</span><span class=w> </span><span class=err>{</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>more</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>minutes</span><span class=w> </span><span class=k>after</span><span class=w> </span><span class=n>midnight</span><span class=w></span>
<span class=err>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=err>{</span><span class=w></span>
<span class=o>=</span><span class=k>print</span><span class=w> </span><span class=k>less</span><span class=w> </span><span class=k>then</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>minutes</span><span class=w> </span><span class=k>after</span><span class=w> </span><span class=n>midnight</span><span class=w></span>
<span class=err>}</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=nf>abs</span><span class=w> </span><span class=n>hum</span><span class=w> </span><span class=k>every</span><span class=w> </span><span class=n>teleperiod</span><span class=w> </span><span class=nc>time</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>mqtts</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=n>upsecs</span><span class=o>%</span><span class=n>tper</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>calc</span><span class=w> </span><span class=nf>abs</span><span class=w> </span><span class=n>humidity</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=n>pow</span><span class=p>(</span><span class=mf>2.718281828</span><span class=w> </span><span class=p>(</span><span class=mf>17.67</span><span class=o>*</span><span class=n>temp</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>temp</span><span class=o>+</span><span class=mf>243.5</span><span class=p>))</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=p>(</span><span class=mf>6.112</span><span class=o>*</span><span class=n>tmp</span><span class=o>*</span><span class=n>hum</span><span class=o>*</span><span class=mf>18.01534</span><span class=p>)</span><span class=o>/</span><span class=p>((</span><span class=mf>273.15</span><span class=o>+</span><span class=n>temp</span><span class=p>)</span><span class=o>*</span><span class=mf>8.31447215</span><span class=p>)</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=n>median</span><span class=w> </span><span class=n>filtered</span><span class=w> </span><span class=k>value</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>Publish</span><span class=w> </span><span class=n>tele</span><span class=o>/%</span><span class=n>topic</span><span class=o>%/</span><span class=n>SENSOR</span><span class=w> </span><span class=err>{</span><span class=ss>&quot;Script&quot;</span><span class=err>:{</span><span class=ss>&quot;abshum&quot;</span><span class=err>:</span><span class=o>%</span><span class=n>med</span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=n>tmp</span><span class=p>)</span><span class=o>%</span><span class=err>}}</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=n>switch</span><span class=w> </span><span class=k>case</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=n>machine</span><span class=w></span>
<span class=n>switch</span><span class=w> </span><span class=k>state</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=k>state</span><span class=o>=%</span><span class=k>state</span><span class=o>%</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=k>start</span><span class=w></span>
<span class=k>state</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=mi>2</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=k>state</span><span class=o>=%</span><span class=k>state</span><span class=o>%</span><span class=w></span>
<span class=k>state</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=mi>3</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=k>state</span><span class=o>=%</span><span class=k>state</span><span class=o>%</span><span class=w>  </span><span class=p>,</span><span class=w> </span><span class=n>reset</span><span class=w></span>
<span class=k>state</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=n>ends</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>subroutines</span><span class=w></span>
<span class=n>#sub1</span><span class=p>(</span><span class=n>string</span><span class=p>)</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=nl>sub1</span><span class=p>:</span><span class=w> </span><span class=o>%</span><span class=n>string</span><span class=o>%</span><span class=w></span>
<span class=n>#sub2</span><span class=p>(</span><span class=n>param</span><span class=p>)</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=nl>sub2</span><span class=p>:</span><span class=w> </span><span class=o>%</span><span class=n>param</span><span class=o>%</span><span class=w></span>

<span class=n>#sendmail</span><span class=p>(</span><span class=n>string</span><span class=p>)</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>sendmail</span><span class=w> </span><span class=o>[</span><span class=n>smtp.gmail.com:465:user:passwd:&lt;sender@gmail.de:&lt;rec@gmail.de:alarm</span><span class=o>]</span><span class=w> </span><span class=o>%</span><span class=n>string</span><span class=o>%</span><span class=w></span>

<span class=o>&gt;</span><span class=n>E</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=n>executed</span><span class=err>!</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>Assign</span><span class=w> </span><span class=n>temperature</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>Zigbee</span><span class=w> </span><span class=n>sensor</span><span class=w></span>
<span class=n>zigbeetemp</span><span class=o>=</span><span class=n>ZbReceived#0x2342#Temperature</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=n>HSBColor</span><span class=w> </span><span class=mf>1.</span><span class=w> </span><span class=n>component</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=n>st</span><span class=p>(</span><span class=n>HSBColor</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>check</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>switch</span><span class=w> </span><span class=n>changed</span><span class=w> </span><span class=k>state</span><span class=w></span>
<span class=n>sw</span><span class=o>=</span><span class=n>sw</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>sw</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=&gt;</span><span class=n>power1</span><span class=w> </span><span class=o>%</span><span class=n>sw</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=n>hello</span><span class=o>=</span><span class=ss>&quot;event occured&quot;</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>check</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Color</span><span class=w> </span><span class=n>change</span><span class=w> </span><span class=p>(</span><span class=n>Color</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>string</span><span class=p>)</span><span class=w></span>
<span class=n>col</span><span class=o>=</span><span class=n>Color</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>change</span><span class=w> </span><span class=n>needs</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>string</span><span class=w> </span><span class=n>vars</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>col</span><span class=o>!=</span><span class=n>ocol</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>ocol</span><span class=o>=</span><span class=n>col</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>changed</span><span class=w>  </span><span class=o>%</span><span class=n>col</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=ow>or</span><span class=w> </span><span class=k>check</span><span class=w> </span><span class=n>change</span><span class=w> </span><span class=k>of</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>channels</span><span class=w></span>
<span class=n>chan1</span><span class=o>=</span><span class=n>Channel</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w></span>
<span class=n>chan2</span><span class=o>=</span><span class=n>Channel</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w></span>
<span class=n>chan3</span><span class=o>=</span><span class=n>Channel</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>chan1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=ow>or</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>chan2</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=ow>or</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>chan3</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>changed</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>compose</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>string</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>red</span><span class=w></span>
<span class=n>col</span><span class=o>=</span><span class=n>hn</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=o>+</span><span class=n>hn</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>+</span><span class=n>hn</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=o>=</span><span class=n>color</span><span class=w> </span><span class=o>%</span><span class=n>col</span><span class=o>%</span><span class=w></span>

<span class=o>&gt;</span><span class=n>R</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>restarting</span><span class=w> </span><span class=n>now</span><span class=w></span>
</code></pre></div> <h3 id=sensor-logging>Sensor Logging<a class=headerlink href=#sensor-logging title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=p>;</span> <span class=n>define</span> <span class=n>all</span> <span class=n>vars</span> <span class=n>here</span>
<span class=p>;</span> <span class=n>reserve</span> <span class=n>large</span> <span class=n>strings</span>
<span class=o>&gt;</span><span class=n>D</span> <span class=mi>48</span>
<span class=n>hum</span><span class=o>=</span><span class=mi>0</span>
<span class=n>temp</span><span class=o>=</span><span class=mi>0</span>
<span class=n>fr</span><span class=o>=</span><span class=mi>0</span>
<span class=n>res</span><span class=o>=</span><span class=mi>0</span>
<span class=p>;</span> <span class=n>moving</span> <span class=n>average</span> <span class=k>for</span> <span class=mi>60</span> <span class=n>seconds</span>
<span class=n>M</span><span class=p>:</span><span class=n>mhum</span><span class=o>=</span><span class=mi>0</span> <span class=mi>60</span>
<span class=n>M</span><span class=p>:</span><span class=n>mtemp</span><span class=o>=</span><span class=mi>0</span> <span class=mi>60</span>
<span class=nb>str</span><span class=o>=</span><span class=s2>&quot;&quot;</span>

<span class=o>&gt;</span><span class=n>B</span>
<span class=p>;</span> <span class=n>set</span> <span class=n>sensor</span> <span class=n>file</span> <span class=n>download</span> <span class=n>link</span>
<span class=n>fl1</span><span class=p>(</span><span class=s2>&quot;slog.txt&quot;</span><span class=p>)</span>
<span class=p>;</span> <span class=n>delete</span> <span class=n>file</span> <span class=ow>in</span> <span class=n>case</span> <span class=n>we</span> <span class=n>want</span> <span class=n>to</span> <span class=n>start</span> <span class=n>fresh</span>
<span class=p>;</span><span class=n>fd</span><span class=p>(</span><span class=s2>&quot;slog.txt&quot;</span><span class=p>)</span>

<span class=p>;</span> <span class=n>list</span> <span class=n>all</span> <span class=n>files</span> <span class=ow>in</span> <span class=n>root</span> <span class=n>directory</span>
<span class=n>fr</span><span class=o>=</span><span class=n>fo</span><span class=p>(</span><span class=s2>&quot;/&quot;</span> <span class=mi>0</span><span class=p>)</span>
<span class=k>for</span> <span class=n>cnt</span> <span class=mi>1</span> <span class=mi>20</span> <span class=mi>1</span>
<span class=n>res</span><span class=o>=</span><span class=n>fr</span><span class=p>(</span><span class=nb>str</span> <span class=n>fr</span><span class=p>)</span>
<span class=k>if</span> <span class=n>res</span><span class=o>&gt;</span><span class=mi>0</span>
<span class=n>then</span>
<span class=o>=&gt;</span><span class=nb>print</span> <span class=o>%</span><span class=n>cnt</span><span class=o>%</span> <span class=p>:</span> <span class=o>%</span><span class=nb>str</span><span class=o>%</span>
<span class=k>else</span>
<span class=k>break</span>
<span class=n>endif</span>
<span class=n>next</span>
<span class=n>fc</span><span class=p>(</span><span class=n>fr</span><span class=p>)</span>

<span class=o>&gt;</span><span class=n>T</span>
<span class=p>;</span> <span class=n>get</span> <span class=n>sensor</span> <span class=n>values</span>
<span class=n>temp</span><span class=o>=</span><span class=n>BME280</span><span class=c1>#Temperature</span>
<span class=n>hum</span><span class=o>=</span><span class=n>BME280</span><span class=c1>#Humidity</span>

<span class=o>&gt;</span><span class=n>S</span>
<span class=p>;</span> <span class=n>average</span> <span class=n>sensor</span> <span class=n>values</span> <span class=n>every</span> <span class=n>second</span>
<span class=n>mhum</span><span class=o>=</span><span class=n>hum</span>
<span class=n>mtemp</span><span class=o>=</span><span class=n>temp</span>

<span class=p>;</span> <span class=n>write</span> <span class=n>average</span> <span class=n>to</span> <span class=n>sensor</span> <span class=nb>log</span> <span class=n>every</span> <span class=n>minute</span>
<span class=k>if</span> <span class=n>upsecs</span><span class=o>%</span><span class=mi>60</span><span class=o>==</span><span class=mi>0</span>
<span class=n>then</span>
<span class=p>;</span> <span class=n>open</span> <span class=n>file</span> <span class=k>for</span> <span class=n>write</span>
<span class=n>fr</span><span class=o>=</span><span class=n>fo</span><span class=p>(</span><span class=s2>&quot;slog.txt&quot;</span> <span class=mi>1</span><span class=p>)</span>
<span class=p>;</span> <span class=n>compose</span> <span class=n>string</span> <span class=k>for</span> <span class=n>tab</span> <span class=n>delimited</span> <span class=n>file</span> <span class=n>entry</span>
<span class=nb>str</span><span class=o>=</span><span class=n>s</span><span class=p>(</span><span class=n>upsecs</span><span class=p>)</span><span class=o>+</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>&quot;</span><span class=o>+</span><span class=n>s</span><span class=p>(</span><span class=n>mhum</span><span class=p>)</span><span class=o>+</span><span class=s2>&quot;</span><span class=se>\t</span><span class=s2>&quot;</span><span class=o>+</span><span class=n>s</span><span class=p>(</span><span class=n>mtemp</span><span class=p>)</span><span class=o>+</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span>
<span class=p>;</span> <span class=n>write</span> <span class=n>string</span> <span class=n>to</span> <span class=nb>log</span> <span class=n>file</span>
<span class=n>res</span><span class=o>=</span><span class=n>fw</span><span class=p>(</span><span class=nb>str</span> <span class=n>fr</span><span class=p>)</span>
<span class=p>;</span> <span class=n>close</span> <span class=n>file</span>
<span class=n>fc</span><span class=p>(</span><span class=n>fr</span><span class=p>)</span>
<span class=n>endif</span>

<span class=o>&gt;</span><span class=n>R</span>
</code></pre></div> <h3 id=e-paper-29-display-with-sgp30-and-bme280>e-Paper 29 Display with SGP30 and BME280<a class=headerlink href=#e-paper-29-display-with-sgp30-and-bme280 title="Permanent link">~</a></h3> <p>Some variables are set from ioBroker</p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=n>hum</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>temp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>press</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>ahum</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tvoc</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>eco2</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>zwz</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>wr1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>wr2</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>wr3</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>otmp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>pwl</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>preset</span><span class=w> </span><span class=n>units</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=k>case</span><span class=w> </span><span class=n>they</span><span class=w> </span><span class=k>are</span><span class=w> </span><span class=ow>not</span><span class=w> </span><span class=n>available</span><span class=w></span>
<span class=n>punit</span><span class=o>=</span><span class=ss>&quot;hPa&quot;</span><span class=w></span>
<span class=n>tunit</span><span class=o>=</span><span class=ss>&quot;C&quot;</span><span class=w></span>

<span class=o>&gt;</span><span class=n>B</span><span class=w></span>
<span class=p>;</span><span class=n>reset</span><span class=w> </span><span class=n>auto</span><span class=w> </span><span class=n>draw</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>zD0</span><span class=o>]</span><span class=w></span>
<span class=p>;</span><span class=n>clr</span><span class=w> </span><span class=n>display</span><span class=w> </span><span class=ow>and</span><span class=w> </span><span class=n>draw</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>frame</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>x0y20h296x0y40h296</span><span class=o>]</span><span class=w></span>

<span class=o>&gt;</span><span class=n>T</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=n>telemetry</span><span class=w> </span><span class=n>sensor</span><span class=w> </span><span class=k>values</span><span class=w></span>
<span class=n>temp</span><span class=o>=</span><span class=n>BME280#Temperature</span><span class=w></span>
<span class=n>hum</span><span class=o>=</span><span class=n>BME280#Humidity</span><span class=w></span>
<span class=n>press</span><span class=o>=</span><span class=n>BME280#Pressure</span><span class=w></span>
<span class=n>tvoc</span><span class=o>=</span><span class=n>SGP30#TVOC</span><span class=w></span>
<span class=n>eco2</span><span class=o>=</span><span class=n>SGP30#eCO2</span><span class=w></span>
<span class=n>ahum</span><span class=o>=</span><span class=n>SGP30#aHumidity</span><span class=w></span>
<span class=n>tunit</span><span class=o>=</span><span class=n>TempUnit</span><span class=w></span>
<span class=n>punit</span><span class=o>=</span><span class=n>PressureUnit</span><span class=w></span>

<span class=o>&gt;</span><span class=n>S</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=n>display</span><span class=w> </span><span class=k>every</span><span class=w> </span><span class=o>[</span><span class=n>`TelePeriod`</span><span class=o>]</span><span class=p>(</span><span class=n>Commands</span><span class=p>.</span><span class=n>md#teleperiod</span><span class=p>)</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upsecs</span><span class=o>%</span><span class=n>tper</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>dp2</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>f1p7x0y5</span><span class=o>]%</span><span class=n>temp</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>tunit</span><span class=o>%</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p5x70y5</span><span class=o>]%</span><span class=n>hum</span><span class=o>%</span><span class=w> </span><span class=o>%%[</span><span class=n>x250y5t</span><span class=o>]</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p11x140y5</span><span class=o>]%</span><span class=n>press</span><span class=o>%</span><span class=w> </span><span class=o>%</span><span class=n>punit</span><span class=o>%</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p10x30y25</span><span class=o>]</span><span class=nl>TVOC</span><span class=p>:</span><span class=w> </span><span class=o>%</span><span class=n>tvoc</span><span class=o>%</span><span class=w> </span><span class=n>ppb</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p10x160y25</span><span class=o>]</span><span class=nl>eCO2</span><span class=p>:</span><span class=w> </span><span class=o>%</span><span class=n>eco2</span><span class=o>%</span><span class=w> </span><span class=n>ppm</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p10c26l5</span><span class=o>]</span><span class=nl>ahum</span><span class=p>:</span><span class=w> </span><span class=o>%</span><span class=n>ahum</span><span class=o>%</span><span class=w> </span><span class=n>g</span><span class=o>^</span><span class=n>m3</span><span class=w></span>

<span class=n>dp0</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p25c1l5</span><span class=o>]</span><span class=n>WR</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>(</span><span class=n>Dach</span><span class=p>)</span><span class=w>  </span><span class=err>:</span><span class=w> </span><span class=o>%</span><span class=n>wr1</span><span class=o>%</span><span class=w> </span><span class=n>W</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p25c1l6</span><span class=o>]</span><span class=n>WR</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=p>(</span><span class=n>Garage</span><span class=p>)</span><span class=err>:</span><span class=w> </span><span class=o>%-</span><span class=n>wr3</span><span class=o>%</span><span class=w> </span><span class=n>W</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p25c1l7</span><span class=o>]</span><span class=n>WR</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=p>(</span><span class=n>Garten</span><span class=p>)</span><span class=err>:</span><span class=w> </span><span class=o>%-</span><span class=n>wr2</span><span class=o>%</span><span class=w> </span><span class=n>W</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>p25c1l8</span><span class=o>]</span><span class=nl>Aussentemperatur</span><span class=p>:</span><span class=w> </span><span class=o>%</span><span class=n>otmp</span><span class=o>%</span><span class=w> </span><span class=n>C</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>x170y95r120:30f2p6x185y100</span><span class=o>]</span><span class=w> </span><span class=o>%</span><span class=n>pwl</span><span class=o>%</span><span class=w> </span><span class=o>%%</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=k>update</span><span class=w> </span><span class=n>screen</span><span class=w></span>
<span class=n>dt</span><span class=w> </span><span class=o>[</span><span class=n>d</span><span class=o>]</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>&gt;</span><span class=n>E</span><span class=w></span>

<span class=o>&gt;</span><span class=n>R</span><span class=w></span>
</code></pre></div> <h3 id=e-paper-42-display-with-sht31-and-bme280>e-Paper 42 Display with SHT31 and BME280<a class=headerlink href=#e-paper-42-display-with-sht31-and-bme280 title="Permanent link">~</a></h3> <p>This script shows 2 graphs on an 4.2 inch e-Paper display: 1. some local sensors, and 2. power statistics </p> <ul> <li>The first graph is the battery level of a solar battery (Tesla PowerWall 2) </li> <li>The second graph shows the solar yield of the roof panels in Watts </li> <li>Another special feature is that this script displays daily and weekly averages (via moving average) of all power IO of the house. </li> <li>it sends an email every sunday night with the weekly data </li> <li>it displays a google bar chart on the webui with values for each weekday of the last week </li> <li>ESP32 CPU with SD card </li> <li>Since the display is a full update panel it is updated only once a minute </li> <li>Some values (like power meters) are set remotely from ioBroker </li> </ul> <hr> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=nv>D</span>
<span class="s s-Atom">hum</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">temp</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">press</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">zwz</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">wr1</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">wr2</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">wr3</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">otmp</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">pwl</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">ez1</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">sez1</span><span class=o>=</span><span class=mi>0</span>
<span class=nv>M</span><span class="s s-Atom">:mez1</span><span class=o>=</span><span class=mi>0</span> <span class=mi>7</span>
<span class="s s-Atom">ezh</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">sezh</span><span class=o>=</span><span class=mi>0</span>
<span class=nv>M</span><span class="s s-Atom">:mezh</span><span class=o>=</span><span class=mi>0</span> <span class=mi>7</span>
<span class="s s-Atom">vzh</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">svzh</span><span class=o>=</span><span class=mi>0</span>
<span class=nv>M</span><span class="s s-Atom">:mvzh</span><span class=o>=</span><span class=mi>0</span> <span class=mi>7</span>
<span class="s s-Atom">wd</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">res</span><span class=o>=</span><span class=mi>0</span>    
<span class="s s-Atom">hr</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">t1</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">res</span><span class=o>=</span><span class=mi>0</span>

<span class=o>&gt;</span><span class=nv>B</span>
<span class="s s-Atom">-&gt;setoption64</span> <span class=mi>1</span>
<span class="s s-Atom">tper</span><span class=o>=</span><span class=mi>30</span>

<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>IzD0</span><span class=p>]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">zG10352:</span><span class=mi>5</span><span class="s s-Atom">:</span><span class=mi>40</span><span class=p>:-</span><span class=mi>350</span><span class="s s-Atom">:</span><span class=mi>80</span><span class="s s-Atom">:</span><span class=mi>10080</span><span class="s s-Atom">:</span><span class=mi>0</span><span class="s s-Atom">:</span><span class=mi>100</span><span class="s s-Atom">f3x360y40</span><span class=p>]</span><span class=mi>100</span> <span class=c1>%%[x360y115]0 %%</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">f1x100y25</span><span class=p>]</span><span class=nv>Powerwall</span> <span class=o>-</span> <span class=mi>7</span> <span class=nv>Tage</span><span class=p>[</span><span class="s s-Atom">f1x360y75</span><span class=p>]</span> <span class=mi>0</span> <span class=c1>%%</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>G10353</span><span class="s s-Atom">:</span><span class=mi>5</span><span class="s s-Atom">:</span><span class=mi>140</span><span class=p>:-</span><span class=mi>350</span><span class="s s-Atom">:</span><span class=mi>80</span><span class="s s-Atom">:</span><span class=mi>10080</span><span class="s s-Atom">:</span><span class=mi>0</span><span class="s s-Atom">:</span><span class=mi>5000</span><span class="s s-Atom">f3x360y140</span><span class=p>]</span><span class=o>+</span><span class=mi>5000</span> <span class=nv>W</span><span class=p>[</span><span class="s s-Atom">x360y215</span><span class=p>]</span><span class=mi>0</span> <span class=nv>W</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">f1x70y125</span><span class=p>]</span><span class=nv>Volleinspeisung</span> <span class=o>-</span> <span class=mi>7</span> <span class=nv>Tage</span><span class=p>[</span><span class="s s-Atom">f1x360y180</span><span class=p>]</span> <span class=mi>0</span> <span class=nv>W</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p13x10y230</span><span class=p>]</span><span class=nv>WR</span> <span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class="s s-Atom">:</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p13x10y245</span><span class=p>]</span><span class=nv>H</span><span class=o>-</span><span class=nv>Einsp</span><span class=p>.</span><span class="s s-Atom">:</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p13x10y260</span><span class=p>]</span><span class=nv>H</span><span class=o>-</span><span class=nv>Verbr</span><span class=p>.</span><span class="s s-Atom">:</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p13x10y275</span><span class=p>]</span><span class=nv>D</span><span class=o>-</span><span class=nv>Einsp</span><span class=p>.</span><span class="s s-Atom">:</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">d</span><span class=p>]</span>

<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Gr0</span><span class="s s-Atom">:/g0_sav</span><span class=p>.</span><span class=nn>txt</span><span class=p>:]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Gr1</span><span class="s s-Atom">:/g1_sav</span><span class=p>.</span><span class=nn>txt</span><span class=p>:]</span>

<span class=nf>beep</span><span class=p>(</span><span class=o>-</span><span class=mi>25</span> <span class=mi>0</span><span class=p>)</span>
<span class=nf>beep</span><span class=p>(</span><span class=mi>1000</span> <span class=mi>100</span><span class=p>)</span>

<span class=o>&gt;</span><span class=nv>T</span>
<span class="s s-Atom">press</span><span class=o>=</span><span class=nv>BMP280</span><span class="s s-Atom">#</span><span class=nv>Pressure</span>
<span class="s s-Atom">temp</span><span class=o>=</span><span class=nv>SHT3X_0x44</span><span class="s s-Atom">#</span><span class=nv>Temperature</span>
<span class="s s-Atom">hum</span><span class=o>=</span><span class=nv>SHT3X_0x44</span><span class="s s-Atom">#</span><span class=nv>Humidity</span>

<span class=o>&gt;</span><span class=nv>S</span>

<span class="s s-Atom">if</span> <span class="s s-Atom">upsecs</span><span class=c1>%60==0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">dp2</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">f1p7x0y5</span><span class=p>]</span><span class=c1>%temp% C</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">x0y20h400x250y5T</span><span class=p>][</span><span class="s s-Atom">x350t</span><span class=p>][</span><span class="s s-Atom">f1p10x70y5</span><span class=p>]</span><span class=c1>%hum% %%</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p10x140y5</span><span class=p>]</span><span class=c1>%press% hPa</span>
<span class="s s-Atom">dp0</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p5x360y75</span><span class=p>]</span><span class=c1>%pwl% %%</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p6x360y180</span><span class=p>]</span><span class=c1>%wr1%W</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">g0:</span><span class=c1>%pwl%g1:%wr1%]</span>

<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p24x75y230</span><span class=p>]</span> <span class=c1>%wr1% W : %-wr2% W : %-wr3% W</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>10</span><span class="s s-Atom">x75y245</span><span class=p>]</span><span class=c1>%ezh% kWh</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>10</span><span class="s s-Atom">x75y260</span><span class=p>]</span><span class=c1>%vzh% kWh</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>10</span><span class="s s-Atom">x75y275</span><span class=p>]</span><span class=c1>%ez1% kWh</span>

<span class="s s-Atom">t1</span><span class=o>=</span><span class="s s-Atom">mezh</span><span class=o>*</span><span class=mi>7</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>10</span><span class="s s-Atom">x150y245</span><span class=p>]</span><span class="s s-Atom">:</span> <span class=c1>%t1% kWh</span>
<span class="s s-Atom">t1</span><span class=o>=</span><span class="s s-Atom">mvzh</span><span class=o>*</span><span class=mi>7</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>10</span><span class="s s-Atom">x150y260</span><span class=p>]</span><span class="s s-Atom">:</span> <span class=c1>%t1% kWh</span>
<span class="s s-Atom">t1</span><span class=o>=</span><span class="s s-Atom">mez1</span><span class=o>*</span><span class=mi>7</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>10</span><span class="s s-Atom">x150y275</span><span class=p>]</span><span class="s s-Atom">:</span> <span class=c1>%t1% kWh</span>

<span class="s s-Atom">dp1</span>
<span class="s s-Atom">t1</span><span class=o>=</span><span class="s s-Atom">ezh</span><span class=o>-</span><span class="s s-Atom">sezh</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p12x250y245</span><span class=p>]</span><span class="s s-Atom">:</span> <span class=c1>%t1% kWh</span>
<span class="s s-Atom">t1</span><span class=o>=</span><span class="s s-Atom">vzh</span><span class=o>-</span><span class="s s-Atom">svzh</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p12x250y260</span><span class=p>]</span><span class="s s-Atom">:</span> <span class=c1>%t1% kWh</span>
<span class="s s-Atom">t1</span><span class=o>=</span><span class="s s-Atom">ez1</span><span class=o>-</span><span class="s s-Atom">sez1</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p12x250y275</span><span class=p>]</span><span class="s s-Atom">:</span> <span class=c1>%t1% kWh</span>

<span class="s s-Atom">dp0</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">f2p5x320y250</span><span class=p>]</span> <span class=c1>%otmp%C</span>

<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">d</span><span class=p>]</span>
<span class="s s-Atom">print</span> <span class="s s-Atom">updating</span> <span class="s s-Atom">display</span>
<span class="s s-Atom">endif</span>

<span class="s s-Atom">hr</span><span class=o>=</span><span class="s s-Atom">hours</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">chg</span><span class=p>[</span><span class="s s-Atom">hr</span><span class=p>]</span><span class=o>&gt;</span><span class=mi>0</span>
<span class="s s-Atom">and</span> <span class="s s-Atom">hr</span><span class=o>==</span><span class=mi>0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">mez1</span><span class=o>=</span><span class="s s-Atom">ez1</span><span class=o>-</span><span class="s s-Atom">sez1</span>
<span class="s s-Atom">sez1</span><span class=o>=</span><span class="s s-Atom">ez1</span>
<span class="s s-Atom">mezh</span><span class=o>=</span><span class="s s-Atom">ezh</span><span class=o>-</span><span class="s s-Atom">sezh</span>
<span class="s s-Atom">sezh</span><span class=o>=</span><span class="s s-Atom">ezh</span>
<span class="s s-Atom">mvzh</span><span class=o>=</span><span class="s s-Atom">vzh</span><span class=o>-</span><span class="s s-Atom">svzh</span>
<span class="s s-Atom">svzh</span><span class=o>=</span><span class="s s-Atom">vzh</span>
<span class="s s-Atom">endif</span>

<span class="s s-Atom">if</span> <span class="s s-Atom">sezh</span><span class=o>==</span><span class=mi>0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">sez1</span><span class=o>=</span><span class="s s-Atom">ez1</span>
<span class="s s-Atom">sezh</span><span class=o>=</span><span class="s s-Atom">ezh</span>
<span class="s s-Atom">svzh</span><span class=o>=</span><span class="s s-Atom">vzh</span>
<span class="s s-Atom">endif</span>

<span class="s s-Atom">wd</span><span class=o>=</span><span class="s s-Atom">wday</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">chg</span><span class=p>[</span><span class="s s-Atom">wd</span><span class=p>]</span><span class=o>&gt;</span><span class=mi>0</span>
<span class="s s-Atom">and</span> <span class="s s-Atom">wd</span><span class=o>==</span><span class=mi>1</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">=&gt;sendmail</span> <span class=p>[</span><span class="s s-Atom">*:*:*:*:*:user</span><span class=p>.</span><span class="s s-Atom">tasmota@gmail</span><span class=p>.</span><span class=nn>com</span><span class=p>:</span> <span class=nv>Wochenbericht</span><span class=p>]</span><span class=o>*</span>
<span class="s s-Atom">print</span> <span class="s s-Atom">sening</span> <span class="s s-Atom">email</span>
<span class="s s-Atom">endif</span>


<span class="s s-Atom">if</span> <span class="s s-Atom">upsecs</span><span class=c1>%300==0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">=#savgraf</span>
<span class="s s-Atom">print</span> <span class="s s-Atom">saving</span> <span class="s s-Atom">graph</span>
<span class="s s-Atom">endif</span>

<span class="s s-Atom">#savgraf</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Gs0</span><span class="s s-Atom">:/g0_sav</span><span class=p>.</span><span class=nn>txt</span><span class=p>:]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Gs1</span><span class="s s-Atom">:/g1_sav</span><span class=p>.</span><span class=nn>txt</span><span class=p>:]</span>

<span class=o>&gt;</span><span class="s s-Atom">m</span>
<span class=nv>Wochenbericht</span> <span class=nv>Einspeisung</span> <span class="s s-Atom">und</span> <span class=nv>Verbrauch</span><span class=o>&lt;</span><span class="s s-Atom">br&gt;&lt;br</span><span class=o>&gt;</span>
<span class="s s-Atom">w1=</span><span class=c1>%mez1[1]%,%mez1[2]%,%mez1[3]%,%mez1[4]%,%mez1[5]%,%mez1[6]%,%mez1[7]%,%mez1[8]%&lt;br&gt;</span>
<span class="s s-Atom">w2=</span><span class=c1>%mezh[1]%,%mezh[2]%,%mezh[3]%,%mezh[4]%,%mezh[5]%,%mezh[6]%,%mezh[7]%,%mezh[8]%&lt;br&gt;</span>
<span class="s s-Atom">w3=</span><span class=c1>%mvzh[1]%,%mvzh[2]%,%mvzh[3]%,%mvzh[4]%,%mvzh[5]%,%mvzh[6]%,%mvzh[7]%,%mvzh[8]%&lt;br&gt;</span>
<span class="s s-Atom">#</span>
<span class=o>&gt;</span><span class=nv>W</span>
<span class="s s-Atom">&amp;&lt;br&gt;&lt;</span><span class=o>div</span> <span class="s s-Atom">id=</span><span class=s2>&quot;container&quot;</span><span class="s s-Atom">style=</span><span class=s2>&quot;width:640px;height:480px;margin:0 auto&quot;</span><span class="s s-Atom">&gt;&lt;/</span><span class=o>div</span><span class="s s-Atom">&gt;&lt;br</span><span class=o>&gt;</span>
<span class="s s-Atom">&amp;&lt;script</span> <span class="s s-Atom">type=</span><span class=s2>&quot;text/javascript&quot;</span> <span class="s s-Atom">src=</span><span class=s2>&quot;https://www.gstatic.com/charts/loader.js&quot;</span><span class="s s-Atom">&gt;&lt;/script</span><span class=o>&gt;</span>
<span class="s s-Atom">&amp;&lt;script</span> <span class="s s-Atom">type=</span><span class=s2>&quot;text/javascript&quot;</span><span class=o>&gt;</span><span class="s s-Atom">google</span><span class=p>.</span><span class="s s-Atom">charts</span><span class=p>.</span><span class=nf>load</span><span class=p>(</span><span class="s s-Atom">&#39;current&#39;</span><span class=p>,{</span><span class=nn>packages</span><span class=p>:[</span><span class="s s-Atom">&#39;corechart&#39;</span><span class=p>]});</span><span class="s s-Atom">&lt;/script</span><span class=o>&gt;</span>
<span class="s s-Atom">&amp;&lt;script</span> <span class="s s-Atom">language=</span><span class=s2>&quot;JavaScript&quot;</span><span class=o>&gt;</span><span class="s s-Atom">function</span> <span class=nf>drawChart</span><span class=p>(){</span><span class="s s-Atom">var</span> <span class="s s-Atom">data</span><span class=o>=</span>
<span class="s s-Atom">&amp;google</span><span class=p>.</span><span class="s s-Atom">visualization</span><span class=p>.</span><span class=nf>arrayToDataTable</span><span class=p>([</span>
<span class="s s-Atom">&amp;</span><span class=p>[</span><span class="s s-Atom">&#39;weekday&#39;</span><span class=p>,</span><span class="s s-Atom">&#39;Power&#39;</span><span class=p>],[</span><span class="s s-Atom">&#39;Mo&#39;</span><span class=p>,</span><span class=c1>%mvzh[1]%],[&#39;Di&#39;,%mvzh[2]%],[&#39;Mi&#39;,%mvzh[3]%],[&#39;Do&#39;,%mvzh[4]%],</span>
<span class="s s-Atom">&amp;</span><span class=p>[</span><span class="s s-Atom">&#39;Fr&#39;</span><span class=p>,</span><span class=c1>%mvzh[5]%],[&#39;Sa&#39;,%mvzh[6]%],[&#39;So&#39;,%mvzh[7]%]]);</span>
<span class="s s-Atom">&amp;var</span> <span class="s s-Atom">options=</span><span class=p>{</span><span class=nn>title</span><span class=p>:</span><span class="s s-Atom">&#39;daily solar feed&#39;</span><span class=p>,</span><span class="s s-Atom">isStacked:true</span><span class=p>};</span>
<span class="s s-Atom">&amp;var</span> <span class="s s-Atom">chart</span><span class=o>=</span><span class="s s-Atom">new</span> 
<span class="s s-Atom">&amp;google</span><span class=p>.</span><span class="s s-Atom">visualization</span><span class=p>.</span><span class=nv>ColumnChart</span><span class=p>(</span><span class="s s-Atom">document</span><span class=p>.</span><span class=nf>getElementById</span><span class=p>(</span><span class="s s-Atom">&#39;container&#39;</span><span class=p>));</span><span class="s s-Atom">chart</span><span class=p>.</span><span class=nf>draw</span><span class=p>(</span><span class="s s-Atom">data</span><span class=p>,</span><span class="s s-Atom">options</span><span class=p>);}</span>
<span class="s s-Atom">&amp;google</span><span class=p>.</span><span class="s s-Atom">charts</span><span class=p>.</span><span class=nf>setOnLoadCallback</span><span class=p>(</span><span class="s s-Atom">drawChart</span><span class=p>);</span><span class="s s-Atom">&lt;/script</span><span class=o>&gt;</span>
<span class="s s-Atom">#</span>
</code></pre></div> <h3 id=ili-9488-color-lcd-display-with-bmp280-and-vl5310x>ILI 9488 Color LCD Display with BMP280 and VL5310X<a class=headerlink href=#ili-9488-color-lcd-display-with-bmp280-and-vl5310x title="Permanent link">~</a></h3> <p>Shows various BMP280 energy graphs Turn display on and off using VL5310X proximity sensor to prevent burn-in</p> <p>Some variables are set from ioBroker</p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=nv>D</span>
<span class="s s-Atom">temp</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">press</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">zwz</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">wr1</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">wr2</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">wr3</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">otmp</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">pwl</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">tmp</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">dist</span><span class=o>=</span><span class=mi>0</span>
<span class="s s-Atom">punit=</span><span class=s2>&quot;hPa&quot;</span>
<span class="s s-Atom">tunit=</span><span class=s2>&quot;C&quot;</span>
<span class="s s-Atom">hour</span><span class=o>=</span><span class=mi>0</span>

<span class=o>&gt;</span><span class=nv>B</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">z</span><span class=p>]</span>

<span class=o>//</span> <span class="s s-Atom">define</span> <span class=mi>2</span> <span class="s s-Atom">graphs</span><span class=p>,</span> <span class=mf>2.</span> <span class="s s-Atom">has</span> <span class=mi>3</span> <span class="s s-Atom">tracks</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">zCi1G2656:</span><span class=mi>5</span><span class="s s-Atom">:</span><span class=mi>20</span><span class="s s-Atom">:</span><span class=mi>400</span><span class="s s-Atom">:</span><span class=mi>80</span><span class="s s-Atom">:</span><span class=mi>1440</span><span class=p>:-</span><span class=mi>5000</span><span class="s s-Atom">:</span><span class=mi>5000</span><span class="s s-Atom">:</span><span class=mi>3</span><span class=nv>Ci7f3x410y20</span><span class=p>]</span><span class=o>+</span><span class=mi>5000</span> <span class=nv>W</span><span class=p>[</span><span class="s s-Atom">x410y95</span><span class=p>]</span><span class=o>-</span><span class=mi>5000</span> <span class=nv>W</span> <span class=p>[</span><span class=nv>Ci7f1x70y3</span><span class=p>]</span> <span class=nv>Zweirichtungsz</span><span class="s s-Atom">~</span><span class=mi>80</span><span class="s s-Atom">hler</span> <span class=o>-</span> <span class=mi>24</span> <span class=nv>Stunden</span>
<span class="s s-Atom">dt</span>  <span class=p>[</span><span class=nv>Ci1G2657</span><span class="s s-Atom">:</span><span class=mi>5</span><span class="s s-Atom">:</span><span class=mi>120</span><span class="s s-Atom">:</span><span class=mi>400</span><span class="s s-Atom">:</span><span class=mi>80</span><span class="s s-Atom">:</span><span class=mi>1440</span><span class="s s-Atom">:</span><span class=mi>0</span><span class="s s-Atom">:</span><span class=mi>5000</span><span class="s s-Atom">:</span><span class=mi>3</span><span class=nv>Ci7f3x410y120</span><span class=p>]</span><span class=o>+</span><span class=mi>5000</span> <span class=nv>W</span><span class=p>[</span><span class="s s-Atom">x410y195</span><span class=p>]</span><span class=mi>0</span> <span class=nv>W</span> <span class=p>[</span><span class=nv>Ci7f1x70y103</span><span class=p>]</span> <span class=nv>Wechselrichter</span> <span class=mi>1</span><span class=o>-</span><span class=mi>3</span> <span class=o>-</span> <span class=mi>24</span> <span class=nv>Stunden</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Ci1G2658</span><span class="s s-Atom">:</span><span class=mi>5</span><span class="s s-Atom">:</span><span class=mi>120</span><span class="s s-Atom">:</span><span class=mi>400</span><span class="s s-Atom">:</span><span class=mi>80</span><span class="s s-Atom">:</span><span class=mi>1440</span><span class="s s-Atom">:</span><span class=mi>0</span><span class="s s-Atom">:</span><span class=mi>5000</span><span class="s s-Atom">:</span><span class=mi>16</span><span class=p>][</span><span class=nv>Ci1G2659</span><span class="s s-Atom">:</span><span class=mi>5</span><span class="s s-Atom">:</span><span class=mi>120</span><span class="s s-Atom">:</span><span class=mi>400</span><span class="s s-Atom">:</span><span class=mi>80</span><span class="s s-Atom">:</span><span class=mi>1440</span><span class="s s-Atom">:</span><span class=mi>0</span><span class="s s-Atom">:</span><span class=mi>5000</span><span class="s s-Atom">:</span><span class=mi>5</span><span class=p>]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">f1s1b0:</span><span class=mi>260</span><span class="s s-Atom">:</span><span class=mi>260</span><span class="s s-Atom">:</span><span class=mi>100</span><span class="s s-Atom">&amp;#</span><span class=mi>8203</span><span class=p>;</span><span class="s s-Atom">:</span><span class=mi>50</span><span class="s s-Atom">:</span><span class=mi>2</span><span class="s s-Atom">:</span><span class=mi>11</span><span class="s s-Atom">:</span><span class=mi>4</span><span class="s s-Atom">:</span><span class=mi>2</span><span class="s s-Atom">:</span><span class=nv>Rel</span> <span class=mi>1</span><span class="s s-Atom">:b1:</span><span class=mi>370</span><span class="s s-Atom">:</span><span class=mi>260</span><span class="s s-Atom">:</span><span class=mi>100</span><span class="s s-Atom">&amp;#</span><span class=mi>8203</span><span class=p>;</span><span class="s s-Atom">:</span><span class=mi>50</span><span class="s s-Atom">:</span><span class=mi>2</span><span class="s s-Atom">:</span><span class=mi>11</span><span class="s s-Atom">:</span><span class=mi>4</span><span class="s s-Atom">:</span><span class=mi>2</span><span class="s s-Atom">:</span><span class=nv>Dsp</span> <span class=nn>off</span><span class=p>:]</span>
<span class="s s-Atom">=&gt;mp3volume</span> <span class=mi>100</span>
<span class="s s-Atom">=&gt;mp3track</span> <span class=mi>4</span>

<span class=o>&gt;</span><span class=nv>T</span>
<span class=p>;</span> <span class="s s-Atom">get</span> <span class="s s-Atom">some</span> <span class="s s-Atom">telemetry</span> <span class="s s-Atom">values</span>
<span class="s s-Atom">temp</span><span class=o>=</span><span class=nv>BMP280</span><span class="s s-Atom">#</span><span class=nv>Temperature</span>
<span class="s s-Atom">press</span><span class=o>=</span><span class=nv>BMP280</span><span class="s s-Atom">#</span><span class=nv>Pressure</span>
<span class="s s-Atom">tunit</span><span class=o>=</span><span class=nv>TempUnit</span>
<span class="s s-Atom">punit</span><span class=o>=</span><span class=nv>PressureUnit</span>
<span class="s s-Atom">dist</span><span class=o>=</span><span class=nv>VL53L0X</span><span class="s s-Atom">#</span><span class=nv>Distance</span>

<span class=p>;</span> <span class="s s-Atom">check</span> <span class="s s-Atom">proximity</span> <span class="s s-Atom">sensor</span> <span class="s s-Atom">to</span> <span class="s s-Atom">turn</span> <span class="s s-Atom">display</span> <span class="s s-Atom">on</span> <span class="s s-Atom">and</span> <span class="s s-Atom">off</span> <span class="s s-Atom">to</span> <span class="s s-Atom">prevent</span> <span class="s s-Atom">burn</span><span class=o>-</span><span class="s s-Atom">in</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">dist</span><span class=o>&gt;</span><span class=mi>300</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">pwr</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>&gt;</span><span class=mi>0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">=&gt;power2</span> <span class=mi>0</span>
<span class="s s-Atom">endif</span>
<span class="s s-Atom">else</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">pwr</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=o>==</span><span class=mi>0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">=&gt;power2</span> <span class=mi>1</span>
<span class="s s-Atom">endif</span>
<span class="s s-Atom">endif</span>

<span class=o>&gt;</span><span class=nv>S</span>
<span class=p>;</span> <span class="s s-Atom">update</span> <span class="s s-Atom">graph</span> <span class="s s-Atom">every</span> <span class="s s-Atom">teleperiod</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">upsecs</span><span class=c1>%tper==0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">dp2</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">f1Ci3x40y260w30Ci1</span><span class=p>]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Ci7x120y220t</span><span class=p>]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Ci7x180y220T</span><span class=p>]</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Ci7p8x120y240</span><span class=p>]</span><span class=c1>%temp% %tunit%</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Ci7x120y260</span><span class=p>]</span><span class=c1>%press% %punit%</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class=nv>Ci7x120y280</span><span class=p>]</span><span class=c1>%dist% mm</span>
<span class="s s-Atom">dp0</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">g0:</span><span class=c1>%zwz%g1:%wr1%g2:%-wr2%g3:%-wr3%]</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">zwz0</span>
<span class="s s-Atom">then</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>8</span><span class="s s-Atom">x410y55Ci2Bi0</span><span class=p>]</span><span class=c1>%zwz% W</span>
<span class="s s-Atom">else</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>8</span><span class="s s-Atom">x410y55Ci3Bi0</span><span class=p>]</span><span class=c1>%zwz% W</span>
<span class="s s-Atom">endif</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>8</span><span class="s s-Atom">x410y140Ci3Bi0</span><span class=p>]</span><span class=c1>%wr1% W</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>8</span><span class="s s-Atom">x410y155Ci16Bi0</span><span class=p>]</span><span class=c1>%-wr2% W</span>
<span class="s s-Atom">dt</span> <span class=p>[</span><span class="s s-Atom">p</span><span class=o>-</span><span class=mi>8</span><span class="s s-Atom">x410y170Ci5Bi0</span><span class=p>]</span><span class=c1>%-wr3% W</span>
<span class="s s-Atom">endif</span>

<span class=p>;</span> <span class="s s-Atom">chime</span> <span class="s s-Atom">every</span> <span class="s s-Atom">full</span> <span class="s s-Atom">hour</span>
<span class="s s-Atom">hour</span><span class=o>=</span><span class=nf>int</span><span class=p>(</span><span class="s s-Atom">time</span><span class=o>/</span><span class=mi>60</span><span class=p>)</span>
<span class="s s-Atom">if</span> <span class="s s-Atom">chg</span><span class=p>[</span><span class="s s-Atom">hour</span><span class=p>]</span><span class=o>&gt;</span><span class=mi>0</span>
<span class="s s-Atom">then</span> <span class="s s-Atom">-&gt;mp3track</span> <span class=mi>4</span>
<span class="s s-Atom">endif</span>

<span class=o>&gt;</span><span class=nv>E</span>

<span class=o>&gt;</span><span class=nv>R</span>
</code></pre></div> <h3 id=led-bar-display-with-ws2812-led-chain>LED Bar Display with WS2812 LED Chain<a class=headerlink href=#led-bar-display-with-ws2812-led-chain title="Permanent link">~</a></h3> <p>Used to display home's solar power input/output (+-5000 Watts)</p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=nl>m</span><span class=p>:</span><span class=k>array</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=p>;</span><span class=n>defines</span><span class=w> </span><span class=k>array</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=mi>60</span><span class=w> </span><span class=n>led</span><span class=w> </span><span class=n>pixels</span><span class=w></span>
<span class=n>cnt</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>val</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>ind</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>rgb</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>grid</span><span class=w></span>
<span class=n>colr1</span><span class=o>=</span><span class=mh>0x050000</span><span class=w></span>
<span class=n>colr2</span><span class=o>=</span><span class=mh>0x050100</span><span class=w></span>
<span class=n>colg1</span><span class=o>=</span><span class=mh>0x000300</span><span class=w></span>
<span class=n>colg2</span><span class=o>=</span><span class=mh>0x020300</span><span class=w></span>
<span class=n>ledbar</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>blue</span><span class=o>=</span><span class=mi>64</span><span class=w></span>
<span class=n>pixels</span><span class=o>=</span><span class=mi>60</span><span class=w></span>
<span class=n>steps</span><span class=o>=</span><span class=mi>10</span><span class=w></span>
<span class=n>div</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tog</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=nf>max</span><span class=o>=</span><span class=mi>5000</span><span class=w></span>
<span class=nf>min</span><span class=o>=-</span><span class=mi>5000</span><span class=w></span>
<span class=n>pos</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=o>&gt;</span><span class=n>B</span><span class=w></span>
<span class=n>div</span><span class=o>=</span><span class=n>pixels</span><span class=o>/</span><span class=n>steps</span><span class=w></span>
<span class=o>=</span><span class=n>#prep</span><span class=w></span>
<span class=n>ws2812</span><span class=p>(</span><span class=k>array</span><span class=p>)</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>ledbar</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>broker</span><span class=w></span>

<span class=o>&gt;</span><span class=n>S</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>ledbar</span><span class=o>&lt;</span><span class=nf>min</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>ledbar</span><span class=o>=</span><span class=nf>min</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>ledbar</span><span class=o>&gt;</span><span class=nf>max</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>ledbar</span><span class=o>=</span><span class=nf>max</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=n>pos</span><span class=o>=</span><span class=p>(</span><span class=n>ledbar</span><span class=o>/</span><span class=nf>max</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=n>pixels</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>ledbar</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>pos</span><span class=o>+=</span><span class=p>(</span><span class=n>pixels</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>pospixels</span><span class=o>-</span><span class=mi>1</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>pos</span><span class=o>=</span><span class=n>pixels</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=n>pos</span><span class=o>+=</span><span class=p>(</span><span class=n>pixels</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>pospixels</span><span class=o>-</span><span class=mi>1</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>pos</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>pos</span><span class=o>&lt;</span><span class=mi>1</span><span class=w></span>
<span class=ow>or</span><span class=w> </span><span class=n>pos</span><span class=o>&gt;</span><span class=n>pixels</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>pos</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>=</span><span class=n>#prep</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>ledbar</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>array</span><span class=o>[</span><span class=n>pos</span><span class=o>]=</span><span class=n>blue</span><span class=w></span>
<span class=k>array</span><span class=o>[</span><span class=n>pos-1</span><span class=o>]=</span><span class=n>blue</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=k>array</span><span class=o>[</span><span class=n>pos</span><span class=o>]=</span><span class=n>blue</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>only</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=nf>power</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>off</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>so</span><span class=w> </span><span class=n>lets</span><span class=w> </span><span class=n>may</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>used</span><span class=w> </span><span class=n>normally</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=k>on</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>pwr</span><span class=o>[</span><span class=n>1</span><span class=o>]==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>ws2812</span><span class=p>(</span><span class=k>array</span><span class=p>)</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>subroutine</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>grid</span><span class=w></span>
<span class=n>#prep</span><span class=w></span>
<span class=k>for</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>pixels</span><span class=w> </span><span class=mi>1</span><span class=w></span>
<span class=n>ind</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>ind</span><span class=o>&gt;</span><span class=n>div</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>ind</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=n>tog</span><span class=o>^=</span><span class=mi>1</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>cnt</span><span class=o>&lt;=</span><span class=n>pixels</span><span class=o>/</span><span class=mi>2</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>tog</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>val</span><span class=o>=</span><span class=n>colr1</span><span class=w></span>
<span class=k>else</span><span class=w> </span><span class=n>val</span><span class=o>=</span><span class=n>colr2</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>tog</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>val</span><span class=o>=</span><span class=n>colg1</span><span class=w></span>
<span class=k>else</span><span class=w> </span><span class=n>val</span><span class=o>=</span><span class=n>colg2</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>array</span><span class=o>[</span><span class=n>cnt</span><span class=o>]=</span><span class=n>val</span><span class=w></span>
<span class=k>next</span><span class=w></span>

<span class=o>&gt;</span><span class=n>R</span><span class=w></span>
</code></pre></div> <h3 id=multiple-ir-receiver-synchronization>Multiple IR Receiver Synchronization<a class=headerlink href=#multiple-ir-receiver-synchronization title="Permanent link">~</a></h3> <p>Shows how a Magic Home with IR receiver works Synchronizes 2 Magic Home devices by also sending the commands to a second Magic Home via <a href=../Commands/#websend><code>WebSend</code></a></p> <p><strong>Script example using <code>if then else</code></strong> ; expand default string length to be able to hold <code>WebSend [xxx.xxx.xxx.xxx]</code> </p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w> </span><span class=mi>25</span><span class=w></span>
<span class=n>istr</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>ws</span><span class=o>=</span><span class=ss>&quot;WebSend [_IP_]&quot;</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=k>section</span><span class=w></span>
<span class=o>&gt;</span><span class=n>E</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=n>ir</span><span class=w> </span><span class=k>data</span><span class=w></span>
<span class=n>istr</span><span class=o>=</span><span class=n>IrReceived#Data</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>on</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F7C03F&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>wakeup</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>wakeup</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=k>off</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F740BF&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>power1</span><span class=w> </span><span class=mi>0</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=n>white</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F7E01F&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=mi>000000</span><span class=n>ff</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=mi>000000</span><span class=n>ff</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=n>red</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F720DF&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=n>ff000000</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>ff000000</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=n>green</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F7A05F&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=mi>00</span><span class=n>ff0000</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=mi>00</span><span class=n>ff0000</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=n>blue</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F7609F&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=mi>0000</span><span class=n>ff00</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=mi>0000</span><span class=n>ff00</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=n>up</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F700FF&quot;</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>dimmer</span><span class=w> </span><span class=o>+</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>+</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=n>dimmer</span><span class=w> </span><span class=n>down</span><span class=w>  </span>
<span class=k>if</span><span class=w> </span><span class=n>istr</span><span class=o>==</span><span class=ss>&quot;0x00F7807F&quot;</span><span class=w>  </span>
<span class=k>then</span><span class=w>  </span>
<span class=o>-&gt;</span><span class=n>dimmer</span><span class=w> </span><span class=o>-</span><span class=w>  </span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>-</span><span class=w>  </span>
<span class=n>endif</span><span class=w></span>

<span class=n>istr</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
</code></pre></div> <p><strong>Script example using <code>switch case ends</code></strong> ; expand default string length to be able to hold <code>WebSend [xxx.xxx.xxx.xxx]</code> </p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w> </span><span class=mi>25</span><span class=w></span>
<span class=n>istr</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>ws</span><span class=o>=</span><span class=ss>&quot;WebSend [_IP_]&quot;</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=k>section</span><span class=w></span>
<span class=o>&gt;</span><span class=n>E</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>get</span><span class=w> </span><span class=n>ir</span><span class=w> </span><span class=k>data</span><span class=w></span>
<span class=n>istr</span><span class=o>=</span><span class=n>IrReceived#Data</span><span class=w></span>

<span class=n>switch</span><span class=w> </span><span class=n>istr</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>on</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F7C03F&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>wakeup</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>wakeup</span><span class=w></span>

<span class=p>;</span><span class=k>off</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F740BF&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>power1</span><span class=w> </span><span class=mi>0</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=mi>0</span><span class=w></span>

<span class=p>;</span><span class=n>white</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F7E01F&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=mi>000000</span><span class=n>ff</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=mi>000000</span><span class=n>ff</span><span class=w></span>

<span class=p>;</span><span class=n>red</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F720DF&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=n>ff000000</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=n>ff000000</span><span class=w></span>

<span class=p>;</span><span class=n>green</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F7A05F&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=mi>00</span><span class=n>ff0000</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=mi>00</span><span class=n>ff0000</span><span class=w></span>

<span class=p>;</span><span class=n>blue</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F7609F&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>color</span><span class=w> </span><span class=mi>0000</span><span class=n>ff00</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=mi>0000</span><span class=n>ff00</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=n>up</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F700FF&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>dimmer</span><span class=w> </span><span class=o>+</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>+</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=n>down</span><span class=w></span>
<span class=k>case</span><span class=w> </span><span class=ss>&quot;0x00F7807F&quot;</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>dimmer</span><span class=w> </span><span class=o>-</span><span class=w></span>
<span class=o>-&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>-</span><span class=w></span>
<span class=n>ends</span><span class=w></span>

<span class=n>istr</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
</code></pre></div> <h3 id=fast-polling>Fast Polling<a class=headerlink href=#fast-polling title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=p>;</span><span class=w> </span><span class=n>expand</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>string</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=n>be</span><span class=w> </span><span class=n>able</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>hold</span><span class=w> </span><span class=err>`</span><span class=n>WebSend</span><span class=w> </span><span class=o>[</span><span class=n>xxx.xxx.xxx.xxx</span><span class=o>]</span><span class=err>`</span><span class=w>  </span>
<span class=o>&gt;</span><span class=n>D</span><span class=w> </span><span class=mi>25</span><span class=w></span>
<span class=n>sw</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>ws</span><span class=o>=</span><span class=ss>&quot;WebSend [_IP_]&quot;</span><span class=w></span>
<span class=n>timer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>hold</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>toggle</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=o>&gt;</span><span class=n>B</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>gpio</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=n>button</span><span class=w> </span><span class=k>input</span><span class=w></span>
<span class=n>spinm</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span><span class=mi>0</span><span class=p>)</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>fast</span><span class=w> </span><span class=k>section</span><span class=w> </span><span class=mi>100</span><span class=n>ms</span><span class=w></span>
<span class=o>&gt;</span><span class=n>F</span><span class=w></span>
<span class=n>sw</span><span class=o>=</span><span class=n>pin</span><span class=o>[</span><span class=n>5</span><span class=o>]</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=n>ms</span><span class=w> </span><span class=n>timer</span><span class=w></span>
<span class=n>timer</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=n>seconds</span><span class=w> </span><span class=n>long</span><span class=w> </span><span class=n>press</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>below</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=mi>5</span><span class=w> </span><span class=n>short</span><span class=w> </span><span class=n>press</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>sw</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=n>timer5</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=n>timer</span><span class=o>&lt;</span><span class=mi>30</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>short</span><span class=w> </span><span class=n>press</span><span class=w></span>
<span class=p>;</span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=n>short</span><span class=w> </span><span class=n>press</span><span class=w></span>
<span class=n>toggle</span><span class=o>^=</span><span class=mi>1</span><span class=w></span>
<span class=o>=&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=o>%</span><span class=n>toggle</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>sw</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=p>;</span><span class=n>pressed</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>timer</span><span class=o>&gt;</span><span class=mi>30</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>hold</span><span class=w></span>
<span class=k>hold</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=p>;</span><span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=k>hold</span><span class=o>=%</span><span class=n>timer</span><span class=o>%</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>toggle</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>=&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>+</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=o>=&gt;%</span><span class=n>ws</span><span class=o>%</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>-</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=n>timer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>hold</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
</code></pre></div> <h3 id=web-ui>Web UI<a class=headerlink href=#web-ui title="Permanent link">~</a></h3> <p>An example to show how to implement a web UI. This example controls a light via <code>WebSend</code></p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=n>dimmer</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>sw</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>color</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>col1</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>red</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>green</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>blue</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>ww</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=o>&gt;</span><span class=n>F</span><span class=w></span>
<span class=n>color</span><span class=o>=</span><span class=n>hn</span><span class=p>(</span><span class=n>red</span><span class=p>)</span><span class=o>+</span><span class=n>hn</span><span class=p>(</span><span class=n>green</span><span class=p>)</span><span class=o>+</span><span class=n>hn</span><span class=p>(</span><span class=n>blue</span><span class=p>)</span><span class=o>+</span><span class=n>hn</span><span class=p>(</span><span class=n>ww</span><span class=p>)</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>color</span><span class=o>!=</span><span class=n>col1</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>col1</span><span class=o>=</span><span class=n>color</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>websend</span><span class=w> </span><span class=o>[</span><span class=n>192.168.178.75</span><span class=o>]</span><span class=w> </span><span class=n>color</span><span class=w> </span><span class=o>%</span><span class=n>color</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>dimmer</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w>  </span>
<span class=o>=&gt;</span><span class=n>websend</span><span class=w> </span><span class=o>[</span><span class=n>192.168.178.75</span><span class=o>]</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=o>%</span><span class=n>dimmer</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>sw</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>websend</span><span class=w> </span><span class=o>[</span><span class=n>192.168.178.75</span><span class=o>]</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=o>%</span><span class=n>sw</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>&gt;</span><span class=n>W</span><span class=w></span>
<span class=n>bu</span><span class=p>(</span><span class=n>sw</span><span class=w> </span><span class=ss>&quot;Light on&quot;</span><span class=w> </span><span class=ss>&quot;Light off&quot;</span><span class=p>)</span><span class=w></span>
<span class=n>ck</span><span class=p>(</span><span class=n>sw</span><span class=w> </span><span class=ss>&quot;Light on/off   &quot;</span><span class=p>)</span><span class=w></span>
<span class=n>sl</span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=n>dimmer</span><span class=w> </span><span class=ss>&quot;0&quot;</span><span class=w> </span><span class=ss>&quot;Dimmer&quot;</span><span class=w> </span><span class=ss>&quot;100&quot;</span><span class=p>)</span><span class=w></span>
<span class=n>sl</span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=mi>255</span><span class=w> </span><span class=n>red</span><span class=w> </span><span class=ss>&quot;0&quot;</span><span class=w> </span><span class=ss>&quot;red&quot;</span><span class=w> </span><span class=ss>&quot;255&quot;</span><span class=p>)</span><span class=w></span>
<span class=n>sl</span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=mi>255</span><span class=w> </span><span class=n>green</span><span class=w> </span><span class=ss>&quot;0&quot;</span><span class=w> </span><span class=ss>&quot;green&quot;</span><span class=w> </span><span class=ss>&quot;255&quot;</span><span class=p>)</span><span class=w></span>
<span class=n>sl</span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=mi>255</span><span class=w> </span><span class=n>blue</span><span class=w> </span><span class=ss>&quot;0&quot;</span><span class=w> </span><span class=ss>&quot;blue&quot;</span><span class=w> </span><span class=ss>&quot;255&quot;</span><span class=p>)</span><span class=w></span>
<span class=n>sl</span><span class=p>(</span><span class=mi>0</span><span class=w> </span><span class=mi>255</span><span class=w> </span><span class=n>ww</span><span class=w> </span><span class=ss>&quot;0&quot;</span><span class=w> </span><span class=ss>&quot;warm white&quot;</span><span class=w> </span><span class=ss>&quot;255&quot;</span><span class=p>)</span><span class=w></span>
<span class=n>tx</span><span class=p>(</span><span class=n>color</span><span class=w> </span><span class=ss>&quot;color:   &quot;</span><span class=p>)</span><span class=w></span>
</code></pre></div> <h3 id=hue-emulation>Hue Emulation<a class=headerlink href=#hue-emulation title="Permanent link">~</a></h3> <p>An example to show how to respond to Alexa requests via Hue Emulation</p> <p>When Alexa sends on/off, dimmer, and color (via hsb), send commands to a MagicHome device</p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=n>pwr1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>hue1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>sat1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>bri1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=o>&gt;</span><span class=n>E</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>hue1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=ow>or</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>sat1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=ow>or</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>bri1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=n>hue1</span><span class=o>/</span><span class=mi>182</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>websend</span><span class=w> </span><span class=o>[</span><span class=n>192.168.178.84</span><span class=o>]</span><span class=w> </span><span class=n>hsbcolor</span><span class=w> </span><span class=o>%</span><span class=n>tmp</span><span class=o>%</span><span class=p>,</span><span class=o>%</span><span class=n>sat1</span><span class=o>%</span><span class=p>,</span><span class=o>%</span><span class=n>bri1</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>pwr1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>websend</span><span class=w> </span><span class=o>[</span><span class=n>192.168.178.84</span><span class=o>]</span><span class=w> </span><span class=n>power1</span><span class=w> </span><span class=o>%</span><span class=n>pwr1</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>&gt;</span><span class=n>H</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>on</span><span class=p>,</span><span class=n>hue</span><span class=p>,</span><span class=n>sat</span><span class=p>,</span><span class=n>bri</span><span class=p>,</span><span class=n>ct</span><span class=w></span>
<span class=n>livingroom</span><span class=p>,</span><span class=n>E</span><span class=p>,</span><span class=k>on</span><span class=o>=</span><span class=n>pwr1</span><span class=p>,</span><span class=n>hue</span><span class=o>=</span><span class=n>hue1</span><span class=p>,</span><span class=n>sat</span><span class=o>=</span><span class=n>sat1</span><span class=p>,</span><span class=n>bri</span><span class=o>=</span><span class=n>bri1</span><span class=w></span>
</code></pre></div> <h3 id=alexa-controlled-mcp230xx-i2c-gpio-expander>Alexa Controlled MCP230xx I<sup>2</sup>C GPIO Expander<a class=headerlink href=#alexa-controlled-mcp230xx-i2c-gpio-expander title="Permanent link">~</a></h3> <p>Uses Tasmota's Hue Emulation capabilities for Alexa interface</p> <div class=codehilite><pre><span></span><code><span class=p>;</span><span class=w> </span><span class=n>define</span><span class=w> </span><span class=n>vars</span><span class=w></span>
<span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=nl>p</span><span class=p>:</span><span class=n>p1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=nl>p</span><span class=p>:</span><span class=n>p2</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=nl>p</span><span class=p>:</span><span class=n>p3</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=nl>p</span><span class=p>:</span><span class=n>p4</span><span class=o>=</span><span class=mi>0</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>init</span><span class=w> </span><span class=n>ports</span><span class=w></span>
<span class=o>&gt;</span><span class=n>B</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=mi>5</span><span class=p>,</span><span class=mi>0</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p1</span><span class=o>%</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p2</span><span class=o>%</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p3</span><span class=o>%</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p4</span><span class=o>%</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>define</span><span class=w> </span><span class=n>Alexa</span><span class=w> </span><span class=n>virtual</span><span class=w> </span><span class=n>devices</span><span class=w></span>
<span class=o>&gt;</span><span class=n>H</span><span class=w></span>
<span class=n>port1</span><span class=p>,</span><span class=n>S</span><span class=p>,</span><span class=k>on</span><span class=o>=</span><span class=n>p1</span><span class=w></span>
<span class=n>port2</span><span class=p>,</span><span class=n>S</span><span class=p>,</span><span class=k>on</span><span class=o>=</span><span class=n>p2</span><span class=w></span>
<span class=n>port3</span><span class=p>,</span><span class=n>S</span><span class=p>,</span><span class=k>on</span><span class=o>=</span><span class=n>p3</span><span class=w></span>
<span class=n>port4</span><span class=p>,</span><span class=n>S</span><span class=p>,</span><span class=k>on</span><span class=o>=</span><span class=n>p4</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=n>events</span><span class=w></span>
<span class=o>&gt;</span><span class=n>E</span><span class=w></span>
<span class=k>print</span><span class=w> </span><span class=n>EVENT</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>p1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p1</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>p2</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p2</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>p3</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p3</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>upd</span><span class=o>[</span><span class=n>p4</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>-&gt;</span><span class=n>sensor29</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=o>%</span><span class=mi>0</span><span class=n>p4</span><span class=o>%</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>=</span><span class=n>#pub</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>publish</span><span class=w> </span><span class=k>routine</span><span class=w></span>
<span class=n>#pub</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>publish</span><span class=w> </span><span class=n>stat</span><span class=o>/%</span><span class=n>topic</span><span class=o>%/</span><span class=k>RESULT</span><span class=w> </span><span class=err>{</span><span class=ss>&quot;MCP23XX&quot;</span><span class=err>:{</span><span class=ss>&quot;p1&quot;</span><span class=err>:</span><span class=o>%</span><span class=mi>0</span><span class=n>p1</span><span class=o>%</span><span class=p>,</span><span class=ss>&quot;p2&quot;</span><span class=err>:</span><span class=o>%</span><span class=mi>0</span><span class=n>p2</span><span class=o>%</span><span class=p>,</span><span class=ss>&quot;p3&quot;</span><span class=err>:</span><span class=o>%</span><span class=mi>0</span><span class=n>p3</span><span class=o>%</span><span class=p>,</span><span class=ss>&quot;p4&quot;</span><span class=err>:</span><span class=o>%</span><span class=mi>0</span><span class=n>p4</span><span class=o>%</span><span class=err>}}</span><span class=w></span>
<span class=n>svars</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>web</span><span class=w> </span><span class=n>interface</span><span class=w></span>
<span class=o>&gt;</span><span class=n>W</span><span class=w></span>
<span class=n>bu</span><span class=p>(</span><span class=n>p1</span><span class=w> </span><span class=ss>&quot;p1 on&quot;</span><span class=w> </span><span class=ss>&quot;p1 off&quot;</span><span class=p>)</span><span class=n>bu</span><span class=p>(</span><span class=n>p2</span><span class=w> </span><span class=ss>&quot;p2 on&quot;</span><span class=w> </span><span class=ss>&quot;p2 off&quot;</span><span class=p>)</span><span class=n>bu</span><span class=p>(</span><span class=n>p3</span><span class=w> </span><span class=ss>&quot;p3 on&quot;</span><span class=w> </span><span class=ss>&quot;p3 off&quot;</span><span class=p>)</span><span class=n>bu</span><span class=p>(</span><span class=n>p4</span><span class=w> </span><span class=ss>&quot;p4 on&quot;</span><span class=w> </span><span class=ss>&quot;p4 off&quot;</span><span class=p>)</span><span class=w></span>
</code></pre></div> <h3 id=retrieve-network-gateway-ip-address>Retrieve network gateway IP Address<a class=headerlink href=#retrieve-network-gateway-ip-address title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span>
<span class=n>gw</span><span class=o>=</span><span class=s2>&quot;&quot;</span>

<span class=p>;</span> <span class=n>Request</span> <span class=k>Status</span> <span class=n>information</span><span class=p>.</span> <span class=n>The</span> <span class=n>response</span> <span class=n>will</span> <span class=k>trigger</span> <span class=n>the</span> <span class="n n-Quoted">`U`</span> <span class=n>section</span>
<span class=o>&gt;</span><span class=n>B</span>
<span class=o>+&gt;</span><span class=k>status</span> <span class=mi>5</span>

<span class=p>;</span> <span class=k>Read</span> <span class=n>the</span> <span class=k>status</span> <span class=kt>JSON</span> <span class=n>payload</span>
<span class=o>&gt;</span><span class=n>U</span>
<span class=n>gw</span><span class=o>=</span><span class=n>StatusNET</span><span class=c1>#Gateway</span>
<span class=n>print</span> <span class=o>%</span><span class=n>gw</span><span class=o>%</span>
</code></pre></div> <h3 id=send-e-mail>Send e-mail<a class=headerlink href=#send-e-mail title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w> </span><span class=mi>25</span><span class=w></span>
<span class=n>day1</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>et</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>to</span><span class=o>=</span><span class=ss>&quot;&lt;mrx@gmail.com&gt;&quot;</span><span class=w></span>

<span class=o>&gt;</span><span class=n>T</span><span class=w></span>
<span class=n>et</span><span class=o>=</span><span class=n>ENERGY#Total</span><span class=w></span>

<span class=o>&gt;</span><span class=n>S</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>send</span><span class=w> </span><span class=k>at</span><span class=w> </span><span class=n>midnight</span><span class=w></span>
<span class=n>day1</span><span class=o>=</span><span class=nf>day</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>day1</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>sendmail</span><span class=w> </span><span class=o>[</span><span class=n>*:*:*:*:*:%to%:energy report</span><span class=o>]*</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>&gt;</span><span class=n>m</span><span class=w></span>
<span class=n>email</span><span class=w> </span><span class=n>report</span><span class=w> </span><span class=k>at</span><span class=w> </span><span class=o>%</span><span class=n>tstamp</span><span class=o>%</span><span class=w></span>
<span class=n>your</span><span class=w> </span><span class=nf>power</span><span class=w> </span><span class=n>consumption</span><span class=w> </span><span class=n>today</span><span class=w> </span><span class=n>was</span><span class=w> </span><span class=o>%</span><span class=n>et</span><span class=o>%</span><span class=w> </span><span class=n>KWh</span><span class=w></span>
<span class=err>#</span><span class=w></span>
</code></pre></div> <h3 id=switching-and-dimming-by-recognizing-mains-power-frequency>Switching and Dimming By Recognizing Mains Power Frequency<a class=headerlink href=#switching-and-dimming-by-recognizing-mains-power-frequency title="Permanent link">~</a></h3> <p>Switching in Tasmota is usually done by High/Low (+3.3V/GND) changes on a GPIO. However, for devices like the <a href=https://templates.blakadder.com/qs-wifi_D01_dimmer.html>Moes QS-WiFi-D01 Dimmer</a>, this is achieved by a pulse frequency when connected to the GPIO, and these pulses are captured by <code>Counter1</code> in Tasmota.</p> <p><img alt=pushbutton-input src=https://user-images.githubusercontent.com/36734573/61955930-5d90e480-afbc-11e9-8d7e-00ac526874d3.png></p> <ul> <li>When the <strong>light is OFF</strong> and there is a <strong>short period</strong> of pulses - then turn the light <strong>ON</strong> at the previous dimmer level.</li> <li>When the <strong>light is ON</strong> and there is a <strong>short period</strong> of pulses - then turn the light <strong>OFF</strong>.</li> <li>When there is a longer period of pulses (i.e., <strong>HOLD</strong>) - toggle dimming direction and then adjust the brightness level as long as the button is pressed or until the limits are reached.</li> </ul> <p><a href=https://github.com/arendst/Tasmota/issues/6085#issuecomment-512353010>Issue 6085</a></p> <p>In the Data Section D at the beginning of the Script the following initialization variables may be changed:</p> <p>dim multiplier = <code>0..2.55</code> set the dimming increment value dim lower limit = range for the dimmer value for push-button operation (set according to your bulb); min 0 dim upper limit = range for the dimmer value for push-button operation (set according to your bulb); max 100 start dim level = initial dimmer level after power-up or restart; max 100</p> <div class=codehilite><pre><span></span><code><span class=o>&gt;</span><span class=n>D</span><span class=w></span>
<span class=n>sw</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tmp</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>cnt</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>tmr</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>hold</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>powert</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>slider</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>dim</span><span class=o>=</span><span class=ss>&quot;&quot;</span><span class=w></span>
<span class=n>shortprl</span><span class=o>=</span><span class=mi>2</span><span class=w> </span><span class=p>;</span><span class=n>short</span><span class=w> </span><span class=n>press</span><span class=w> </span><span class=n>lo</span><span class=w> </span><span class=k>limit</span><span class=w></span>
<span class=n>shortpru</span><span class=o>=</span><span class=mi>10</span><span class=p>;</span><span class=n>short</span><span class=w> </span><span class=n>press</span><span class=w> </span><span class=n>up</span><span class=w> </span><span class=k>limit</span><span class=w></span>
<span class=n>dimdir</span><span class=o>=</span><span class=mi>0</span><span class=w>   </span><span class=p>;</span><span class=n>dim</span><span class=w> </span><span class=n>direction</span><span class=w> </span><span class=mi>0</span><span class=o>/</span><span class=mi>1</span><span class=w></span>
<span class=n>dimstp</span><span class=o>=</span><span class=mi>2</span><span class=w>   </span><span class=p>;</span><span class=n>dim</span><span class=w> </span><span class=n>step</span><span class=o>/</span><span class=n>speed</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=mi>5</span><span class=w></span>
<span class=n>dimmlp</span><span class=o>=</span><span class=mf>2.2</span><span class=w> </span><span class=p>;</span><span class=n>dim</span><span class=w> </span><span class=n>multiplier</span><span class=w></span>
<span class=n>dimll</span><span class=o>=</span><span class=mi>15</span><span class=w>   </span><span class=p>;</span><span class=n>dim</span><span class=w> </span><span class=nf>lower</span><span class=w> </span><span class=k>limit</span><span class=w></span>
<span class=n>dimul</span><span class=o>=</span><span class=mi>95</span><span class=w>   </span><span class=p>;</span><span class=n>dim</span><span class=w> </span><span class=nf>upper</span><span class=w> </span><span class=k>limit</span><span class=w></span>
<span class=n>dimval</span><span class=o>=</span><span class=mi>70</span><span class=w>  </span><span class=p>;</span><span class=k>start</span><span class=w> </span><span class=n>dim</span><span class=w> </span><span class=k>level</span><span class=w></span>

<span class=o>&gt;</span><span class=n>B</span><span class=w></span>
<span class=o>=&gt;</span><span class=k>print</span><span class=w> </span><span class=ss>&quot;WiFi-Dimmer-Script-v0.2&quot;</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>Counter1</span><span class=w> </span><span class=mi>0</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>Baudrate</span><span class=w> </span><span class=mi>9600</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>boot</span><span class=w> </span><span class=k>sequence</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=n>dimval</span><span class=p>)</span><span class=w></span>
<span class=n>delay</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>

<span class=o>&gt;</span><span class=n>F</span><span class=w></span>
<span class=n>cnt</span><span class=o>=</span><span class=n>pc</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>cnt</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>sw</span><span class=w> </span><span class=n>pressed</span><span class=w></span>
<span class=k>then</span><span class=w> </span><span class=n>sw</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=k>else</span><span class=w> </span><span class=n>sw</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>sw</span><span class=w> </span><span class=ow>not</span><span class=w> </span><span class=n>pressed</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=mi>100</span><span class=n>ms</span><span class=w> </span><span class=n>timer</span><span class=w></span>
<span class=n>tmr</span><span class=o>+=</span><span class=mi>1</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>short</span><span class=w> </span><span class=n>press</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>sw</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=n>tmr</span><span class=o>&gt;</span><span class=n>shortprl</span><span class=w></span>
<span class=ow>and</span><span class=w> </span><span class=n>tmr</span><span class=o>&lt;</span><span class=n>shortpru</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>powert</span><span class=o>^=</span><span class=mi>1</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>change</span><span class=w> </span><span class=n>light</span><span class=w> </span><span class=k>on</span><span class=o>/</span><span class=k>off</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>powert</span><span class=o>==</span><span class=mi>1</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=n>dimval</span><span class=p>)</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>


<span class=p>;</span><span class=w> </span><span class=n>long</span><span class=w> </span><span class=n>press</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>sw</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=k>hold</span><span class=o>==</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>change</span><span class=w> </span><span class=n>dim</span><span class=w> </span><span class=n>direction</span><span class=w></span>
<span class=n>dimdir</span><span class=o>^=</span><span class=mi>1</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>tmr</span><span class=o>&gt;</span><span class=n>shortpru</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>hold</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>powert</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=n>dim</span><span class=w> </span><span class=k>when</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=k>hold</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>dimdir</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>increase</span><span class=w> </span><span class=n>dim</span><span class=w> </span><span class=k>level</span><span class=w></span>
<span class=n>dimval</span><span class=o>+=</span><span class=n>dimstp</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>dimval</span><span class=o>&gt;</span><span class=n>dimul</span><span class=w>  </span>
<span class=k>then</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=nf>upper</span><span class=w> </span><span class=k>limit</span><span class=w></span>
<span class=n>dimval</span><span class=o>=</span><span class=n>dimul</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=n>dimval</span><span class=p>)</span><span class=w></span>
<span class=k>else</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>decrease</span><span class=w> </span><span class=n>dim</span><span class=w> </span><span class=k>level</span><span class=w></span>
<span class=n>dimval</span><span class=o>-=</span><span class=n>dimstp</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>dimval</span><span class=o>&lt;</span><span class=n>dimll</span><span class=w></span>
<span class=k>then</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=nf>lower</span><span class=w> </span><span class=k>limit</span><span class=w></span>
<span class=n>dimval</span><span class=o>=</span><span class=n>dimll</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=n>dimval</span><span class=p>)</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=n>tmr</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=k>hold</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=o>&gt;</span><span class=n>E</span><span class=w></span>
<span class=n>slider</span><span class=o>=</span><span class=n>Dimmer</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>slider</span><span class=w> </span><span class=n>change</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>chg</span><span class=o>[</span><span class=n>slider</span><span class=o>]&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>dim</span><span class=w> </span><span class=n>according</span><span class=w> </span><span class=n>slider</span><span class=w></span>
<span class=k>if</span><span class=w> </span><span class=n>slider</span><span class=o>&gt;</span><span class=mi>0</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>dimval</span><span class=o>=</span><span class=n>slider</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=n>dimval</span><span class=p>)</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=n>powert</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=n>endif</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=n>pwr</span><span class=o>[</span><span class=n>1</span><span class=o>]==</span><span class=mi>1</span><span class=w></span>
<span class=p>;</span><span class=w> </span><span class=k>on</span><span class=o>/</span><span class=k>off</span><span class=w> </span><span class=n>webui</span><span class=w></span>
<span class=k>then</span><span class=w></span>
<span class=n>powert</span><span class=o>=</span><span class=mi>1</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=n>dimval</span><span class=p>)</span><span class=w></span>
<span class=k>else</span><span class=w></span>
<span class=n>powert</span><span class=o>=</span><span class=mi>0</span><span class=w></span>
<span class=o>=</span><span class=n>#senddim</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=n>endif</span><span class=w></span>

<span class=p>;</span><span class=w> </span><span class=n>subroutine</span><span class=w> </span><span class=n>dim</span><span class=w></span>
<span class=n>#senddim</span><span class=p>(</span><span class=n>tmp</span><span class=p>)</span><span class=w></span>
<span class=n>dim</span><span class=o>=</span><span class=ss>&quot;FF55&quot;</span><span class=o>+</span><span class=n>hn</span><span class=p>(</span><span class=n>tmp</span><span class=o>*</span><span class=n>dimmlp</span><span class=p>)</span><span class=o>+</span><span class=ss>&quot;05DC0A&quot;</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>SerialSend5</span><span class=w> </span><span class=o>%</span><span class=n>dim</span><span class=o>%</span><span class=w></span>
<span class=o>=&gt;</span><span class=n>Dimmer</span><span class=w> </span><span class=o>%</span><span class=n>tmp</span><span class=o>%</span><span class=w></span>
<span class=err>#</span><span class=w></span>
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../Rules/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Previous </span> Rules </div> </div> </a> <a href=../Serial-to-TCP-Bridge/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> Next </span> Serial to TCP Bridge </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M297.216 243.2c0 15.616-11.52 28.416-26.112 28.416-14.336 0-26.112-12.8-26.112-28.416s11.52-28.416 26.112-28.416c14.592 0 26.112 12.8 26.112 28.416zm-119.552-28.416c-14.592 0-26.112 12.8-26.112 28.416s11.776 28.416 26.112 28.416c14.592 0 26.112-12.8 26.112-28.416.256-15.616-11.52-28.416-26.112-28.416zM448 52.736V512c-64.494-56.994-43.868-38.128-118.784-107.776l13.568 47.36H52.48C23.552 451.584 0 428.032 0 398.848V52.736C0 23.552 23.552 0 52.48 0h343.04C424.448 0 448 23.552 448 52.736zm-72.96 242.688c0-82.432-36.864-149.248-36.864-149.248-36.864-27.648-71.936-26.88-71.936-26.88l-3.584 4.096c43.52 13.312 63.744 32.512 63.744 32.512-60.811-33.329-132.244-33.335-191.232-7.424-9.472 4.352-15.104 7.424-15.104 7.424s21.248-20.224 67.328-33.536l-2.56-3.072s-35.072-.768-71.936 26.88c0 0-36.864 66.816-36.864 149.248 0 0 21.504 37.12 78.08 38.912 0 0 9.472-11.52 17.152-21.248-32.512-9.728-44.8-30.208-44.8-30.208 3.766 2.636 9.976 6.053 10.496 6.4 43.21 24.198 104.588 32.126 159.744 8.96 8.96-3.328 18.944-8.192 29.44-15.104 0 0-12.8 20.992-46.336 30.464 7.68 9.728 16.896 20.736 16.896 20.736 56.576-1.792 78.336-38.912 78.336-38.912z"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../assets/javascripts/vendor.18f0862e.min.js></script> <script src=../assets/javascripts/bundle.994580cf.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "..",
          features: ['navigation.tabs', 'navigation.instant'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>